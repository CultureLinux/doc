{"config":{"lang":["fr"],"separator":"[\\s\\-]+","pipeline":["stopWordFilter"],"fields":{"title":{"boost":1000.0},"text":{"boost":1.0},"tags":{"boost":1000000.0}}},"docs":[{"location":"","title":"Bienvenue sur la documentation \ud83d\udc4b","text":""},{"location":"#demarrer","title":"\ud83d\ude80 D\u00e9marrer","text":"<ul> <li>Virtualisation: installer son homelab  avec Proxmox</li> <li>Opentofu : automatiser le d\u00e9ploiment de VM</li> <li>Ansible: Automatiser la configuration de son OS</li> <li>Le terminal : configuration de son terminal</li> </ul>"},{"location":"#ressources-utiles","title":"\ud83d\udcda Ressources utiles","text":"<ul> <li>Utilise la recherche (barre en haut \u00e0 droite)  </li> <li>Regarde les vid\u00e9os explicatives sur Youtube</li> <li>Retrouve le code utilis\u00e9 dans les vid\u00e9os Github</li> </ul> <p>\u00ab Un bon d\u00e9part vaut mieux qu\u2019un long discours \u00bb \u2014 Citation de L\u00e9odagan (ou presque) \ud83d\ude09</p>"},{"location":"containers/docker/","title":"\ud83d\ude80 Docker","text":""},{"location":"containers/docker/#install","title":"Install","text":""},{"location":"containers/docker/#rocky","title":"\ud83d\udcbe Rocky","text":"<p>Utilisez dnf pour installer Docker CE (Community Edition) sur CentOS.</p> <pre><code>dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo\ndnf install docker-ce docker-ce-cli containerd.io\nsystemctl enable docker\nsystemctl start docker\nsystemctl status docker\n</code></pre>"},{"location":"containers/docker/#allow-user","title":"\ud83d\udee1\ufe0f Allow user","text":"<p>Ajoutez l'utilisateur actuel au groupe docker  pour autoriser l'ex\u00e9cution des commandes Docker sans privil\u00e8ges administratifs.</p> <pre><code>usermod -aG docker docky\n</code></pre>"},{"location":"containers/docker/#commands","title":"\ud83e\udde0 Commands","text":"<p>Utilisez les commandes Docker pour g\u00e9rer et ex\u00e9cuter des conteneurs.</p>"},{"location":"containers/docker/#container","title":"\ud83d\ude80 Container","text":"<pre><code>docker ps\ndocker compose up -d\n</code></pre>"},{"location":"containers/docker/#network","title":"\ud83c\udf10 network","text":"<p>Utilisez les commandes Docker pour cr\u00e9er et configurer des r\u00e9seaux.</p>"},{"location":"containers/docker/#create","title":"\ud83d\udc47 create","text":"<pre><code>docker network create web\n</code></pre>"},{"location":"containers/docker/#images","title":"\ud83d\udce6 images","text":""},{"location":"containers/docker/#list","title":"\ud83d\udc49 List","text":"<pre><code>docker images\ndocker images --all\ndocker images moulti-stream\n</code></pre>"},{"location":"containers/docker/#build","title":"\ud83d\udd25 Build","text":"<pre><code>docker build -f DockerFile -t moulti-stream:0.0.9 .\n</code></pre>"},{"location":"containers/docker/#remove","title":"\ud83d\udd25 Remove","text":"<pre><code>docker image prune -a -f\n</code></pre>"},{"location":"containers/docker/#volumes","title":"\ud83d\udce6 Volumes","text":""},{"location":"containers/docker/#list_1","title":"\ud83d\udc49 List","text":"<pre><code>docker volume ls\ndocker volume ls -qf dangling=true\n</code></pre>"},{"location":"containers/docker/#remove_1","title":"\ud83d\udd25 Remove","text":"<pre><code>docker volume prune\n</code></pre>"},{"location":"databases/influxdb/","title":"Influxdb","text":""},{"location":"databases/influxdb/#retention","title":"Retention","text":"<pre><code>influx\n&gt; SHOW RETENTION POLICIES on icinga2\n&gt; CREATE RETENTION POLICY \"2years\" ON icinga2 DURATION 100w REPLICATION 1 DEFAULT\n&gt; DROP RETENTION POLICY \"autogen\"  ON icinga2\n</code></pre>"},{"location":"databases/mariadb/","title":"MariaDB","text":"<p>This section covers various commands and procedures for managing MariaDB.</p>"},{"location":"databases/mariadb/#install","title":"Install","text":"<p>Installs MariaDB and runs the secure installation script. <pre><code>mariadb_secure_install\n</code></pre></p>"},{"location":"databases/mariadb/#root-password","title":"Root password","text":"<p>This subsection provides methods for changing the root password in MariaDB.</p>"},{"location":"databases/mariadb/#hot-change","title":"Hot change","text":"<p>Changes the root password without restarting the MariaDB service. <pre><code>mysqladmin -u root -p'OLDPASSWORD' password 'NEWPASSWORD';\n</code></pre></p>"},{"location":"databases/mariadb/#cold-change","title":"Cold change","text":"<p>Changes the root password after stopping and starting the MariaDB service. <pre><code>systemctl mariadb stop\nmysqld_safe --skip-grant-tables &amp;\nmysql mysql -u root\nUPDATE user SET password=PASSWORD('NEWPASSWORD') WHERE user=\"root\";\nFLUSH PRIVILEGES;\nexit\nsystemctl mariadb start\n</code></pre></p>"},{"location":"databases/mariadb/#user-split","title":"User split","text":"<p>Creates a new database and grants privileges to a user. <pre><code>mysqladmin -u root -p create MYDB\nmysql -u root -p mysql\nGRANT ALL ON MYDB.* TO MYUSER@'%' IDENTIFIED BY 'NEWPASSWORD';\nGRANT ALL ON MYDB.* TO MYUSER@localhost IDENTIFIED BY 'NEWPASSWORD';\nFLUSH PRIVILEGES;\nexit\n</code></pre> * % : from any ip * localhost: only from localhost</p>"},{"location":"databases/mariadb/#extract-permissions","title":"Extract permissions","text":"<p>Displays the SQL commands needed to recreate the grants for each user. <pre><code>use mysql\nselect distinct concat('SHOW GRANTS FOR ''' , user, '''@''',host,''';') as query from user;\n</code></pre></p>"},{"location":"databases/mariadb/#tables","title":"Tables","text":"<p>This subsection provides commands related to database tables.</p>"},{"location":"databases/mariadb/#copy","title":"Copy","text":"<p>Creates a new table by copying an existing one. <pre><code>CREATE TABLE new_table_name AS\nSELECT * FROM old_table_name;\n</code></pre></p>"},{"location":"databases/mariadb/#log-requests","title":"Log requests","text":"<p>This subsection explains how to log MariaDB requests.</p>"},{"location":"databases/mariadb/#activate","title":"Activate","text":"<p>Enables the general query log. <pre><code>SET global general_log = 1;\n</code></pre></p>"},{"location":"databases/mariadb/#destination","title":"Destination","text":"<p>Specifies where the general query log should be stored.</p>"},{"location":"databases/mariadb/#table","title":"Table","text":"<p><pre><code>SET global log_output = 'table';\n</code></pre> <pre><code>select * from general_log;\nselect * from mysql.general_log where command_type = 'Query' and user_host = 'user[user] @ localhost []'\n</code></pre></p>"},{"location":"databases/mariadb/#file","title":"File","text":"<pre><code>SET global log_output = 'file';\nSET global general_log_file = '/tmp/mysql_trace.log';\n</code></pre>"},{"location":"databases/mariadb/#deactivate","title":"Deactivate","text":"<p>Disables the general query log. <pre><code>SET global general_log = 0;\n</code></pre></p>"},{"location":"databases/mariadb/#upgrade","title":"Upgrade","text":"<p>This subsection explains how to upgrade MariaDB.</p> <pre><code># service mariadb stop\n# yum remove MariaDB-*\n# cat /etc/yum.repos.d/MariaDB.repo\n# sed -i 's/11\\.1/11\\.2/' /etc/yum.repos.d/MariaDB.repo\n# yum install MariaDB-server\n# service mariadb start\n# /usr/bin/mariadb-upgrade -u root -p\n</code></pre>"},{"location":"databases/mongodb/","title":"MongoDB","text":""},{"location":"databases/mongodb/#install","title":"Install","text":""},{"location":"databases/mongodb/#debian-11","title":"Debian 11","text":"<pre><code># apt install gpg wget\n# wget -qO - https://www.mongodb.org/static/pgp/server-5.0.asc | apt-key add -\n# echo \"deb http://repo.mongodb.org/apt/debian buster/mongodb-org/5.0 main\" | tee /etc/apt/sources.list.d/mongodb-org-5.0.list\n# apt update\n# apt install mongodb-org\n# systemctl enable --now mongod\n</code></pre>"},{"location":"databases/mongodb/#authentication","title":"Authentication","text":""},{"location":"databases/mongodb/#create-admin-first","title":"Create admin first","text":"<p><pre><code>$ mongosh admin\nswitched to db admin\n</code></pre> <pre><code>db.createUser(\n  {\n    user: \"admin\",\n    pwd: \"admin_pwd\",\n    roles: [\n      { role: \"userAdminAnyDatabase\", db: \"admin\" },\n      { role: \"readWriteAnyDatabase\", db: \"admin\" }\n    ]\n  }\n)\n</code></pre></p>"},{"location":"databases/mongodb/#force-auth","title":"Force auth","text":"<p><pre><code># systemctl stop mongod\n# vi /etc/mongod.conf\n</code></pre> <pre><code>...\nsecurity:\n  authorization: enabled\n...\n</code></pre> <pre><code># systemctl start mongod\n</code></pre></p>"},{"location":"databases/mongodb/#login","title":"Login","text":"<ul> <li>failed <pre><code>$ mongosh\ntest&gt; db.getCollectionNames()\nMongoServerError: Command listCollections requires authentication\n</code></pre></li> <li>success <pre><code>$ mongosh mongodb://admin:admin_pwd@localhost:27017/test --authenticationDatabase admin\ntest&gt; db.getCollectionNames()\n[]\n</code></pre></li> </ul>"},{"location":"databases/mongodb/#users","title":"Users","text":""},{"location":"databases/mongodb/#get","title":"get","text":"<pre><code>$ mongosh mongodb://admin:admin_pwd@localhost:27017/test --authenticationDatabase admin\nadmin&gt; db.getUsers()\n{\n  users: [\n    {\n      _id: 'admin.admin',\n      userId: new UUID(\"58625790-8e6b-4433-9e54-777ede29afea\"),\n      user: 'admin',\n      db: 'admin',\n      roles: [\n        { role: 'readWriteAnyDatabase', db: 'admin' },\n        { role: 'userAdminAnyDatabase', db: 'admin' }\n      ],\n      mechanisms: [ 'SCRAM-SHA-1', 'SCRAM-SHA-256' ]\n    }\n  ],\n  ok: 1\n}\n</code></pre>"},{"location":"databases/mongodb/#add-role","title":"Add role","text":"<pre><code>admin&gt; db.grantRolesToUser('admin',['dbAdminAnyDatabase'])\n{ ok: 1 }\nadmin&gt; db.getUsers()\n{\n  users: [\n    {\n      _id: 'admin.admin',\n      userId: new UUID(\"58625790-8e6b-4433-9e54-777ede29afea\"),\n      user: 'admin',\n      db: 'admin',\n      roles: [\n        { role: 'dbAdminAnyDatabase', db: 'admin' },\n        { role: 'userAdminAnyDatabase', db: 'admin' },\n        { role: 'readWriteAnyDatabase', db: 'admin' }\n      ],\n      mechanisms: [ 'SCRAM-SHA-1', 'SCRAM-SHA-256' ]\n    }\n  ],\n  ok: 1\n}\n</code></pre>"},{"location":"databases/mongodb/#change-password","title":"Change password","text":"<pre><code>admin&gt; db.changeUserPassword(\"svc_backup\",\"mysqlpwd\")\n{ ok: 1 }\n</code></pre>"},{"location":"databases/mongodb/#connect","title":"Connect","text":""},{"location":"databases/mongodb/#auto-connect","title":"auto connect","text":"<p>vi ~/.mongoshrc.js <pre><code>db = connect(\"localhost:27017/admin\");\ndb.auth('admin','mysqlpwd')\n</code></pre></p> <pre><code>mongosh --authenticationDatabase admin\n</code></pre>"},{"location":"databases/mongodb/#no-autoconnect","title":"no autoconnect","text":"<pre><code>mongosh --authenticationDatabase admin --norc -u otheruser -p\n</code></pre>"},{"location":"databases/mongodb/#database","title":"Database","text":""},{"location":"databases/mongodb/#create","title":"Create","text":"<pre><code>$ mongosh \ntest&gt; use ex_db\nswitched to db ex_db\nex_db&gt; db.createCollection(\"posts\")\n{ ok: 1 }\nex_db&gt; show dbs\nadmin   116.00 KiB\nconfig  108.00 KiB\nex_db     8.00 KiB\nlocal    72.00 KiB\n</code></pre>"},{"location":"databases/mongodb/#drop","title":"Drop","text":"<ul> <li>User must have role : dbAdmin or dbAdminAnyDatabase <pre><code>$ mongosh \ntest&gt; use ex_db\nswitched to db ex_db\nex_db&gt; db.dropDatabase()\n{ ok: 1, dropped: 'ex_db' }\nex_db&gt; show dbs\nadmin   116.00 KiB\nconfig  108.00 KiB\nlocal    72.00 KiB\n</code></pre></li> </ul>"},{"location":"databases/sqlserver/","title":"Sql Server","text":""},{"location":"databases/sqlserver/#install-debian12","title":"Install (debian12)","text":""},{"location":"databases/sqlserver/#repository","title":"Repository","text":"<pre><code># apt install gnupg2 apt-transport-https wget curl\n# wget -q -O- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor | sudo tee /usr/share/keyrings/microsoft.gpg &gt; /dev/null 2&gt;&amp;1\n# echo \"deb [signed-by=/usr/share/keyrings/microsoft.gpg arch=amd64,armhf,arm64] https://packages.microsoft.com/ubuntu/22.04/mssql-server-2022 jammy main\" | sudo tee /etc/apt/sources.list.d/mssql-server-2022.list\n</code></pre>"},{"location":"databases/sqlserver/#install","title":"Install","text":"<pre><code># apt install mssql-server\n</code></pre>"},{"location":"databases/sqlserver/#setup","title":"setup","text":"<pre><code>/opt/mssql/bin/mssql-conf setup\n</code></pre>"},{"location":"databases/sqlserver/#install-cli","title":"install cli","text":"<pre><code># echo \"deb [signed-by=/usr/share/keyrings/microsoft.gpg arch=amd64,armhf,arm64] https://packages.microsoft.com/ubuntu/22.04/prod jammy main\" | sudo tee /etc/apt/sources.list.d/prod.list\n# apt update\n# apt install mssql-tools unixodbc-dev\n# ln -s /opt/mssql-tools/bin/sqlcmd /usr/local/bin/sqlcmd\n</code></pre>"},{"location":"databases/sqlserver/#usage","title":"Usage","text":""},{"location":"databases/sqlserver/#connect","title":"Connect","text":""},{"location":"databases/sqlserver/#interactive","title":"interactive","text":"<pre><code>$ /opt/mssql-tools/bin/sqlcmd -S 192.168.1.110 -U SA\n</code></pre>"},{"location":"databases/sqlserver/#not-interactive","title":"not interactive","text":"<ul> <li>not secure <code>$ /opt/mssql-tools/bin/sqlcmd -S 192.168.1.110 -U SA -P 'xXxXxxX'</code></li> <li>a little better <code>$ export SQLCMDPASSWORD='xXxXxxX'     $ /opt/mssql-tools/bin/sqlcmd -S 192.168.1.110 -U SA</code> </li> </ul>"},{"location":"databases/sqlserver/#query","title":"query","text":"<pre><code>$ /opt/mssql-tools/bin/sqlcmd -S 192.168.1.110 -U SA -Q \"SELECT @@version GO\"\n</code></pre>"},{"location":"databases/sqlserver/#script","title":"script","text":"<pre><code>$ /opt/mssql-tools/bin/sqlcmd -S 192.168.1.110 -U SA -i script-file.sql\n</code></pre>"},{"location":"databases/sqlserver/#user","title":"User","text":""},{"location":"databases/sqlserver/#create","title":"Create","text":"<pre><code>use master \nCREATE LOGIN clinux WITH PASSWORD = 'Clinux';\n\nIF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'db_clinux')\nBEGIN\nCREATE DATABASE db_clinux;\nEND;\nGO\n\nuse db_clinux\nCREATE USER u_clinux FOR LOGIN clinux;\nALTER ROLE db_owner ADD MEMBER u_clinux ;\nGO\n</code></pre>"},{"location":"databases/sqlserver/#query_1","title":"Query","text":""},{"location":"databases/sqlserver/#database","title":"Database","text":"<ul> <li>get current <pre><code>    select DB_NAME()\n    GO\n</code></pre></li> <li>get all  <pre><code>    select name from sys.databases\n    GO\n</code></pre></li> <li>create <pre><code>    IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'datalake')\n    BEGIN\n    CREATE DATABASE datalake;\n    END;\n    GO\n</code></pre></li> </ul>"},{"location":"databases/sqlserver/#table","title":"Table","text":"<ul> <li>get all <pre><code>    use datalake\n    SELECT name,crdate FROM SYSOBJECTS WHERE xtype = 'U';\n    GO\n</code></pre></li> <li>Describe <pre><code>    exec sp_columns MyTable\n</code></pre></li> </ul>"},{"location":"databases/sqlserver/#columns","title":"Columns","text":"<ul> <li>add column  <pre><code>    ALTER TABLE MyTable ADD zone varchar(255)\n</code></pre></li> <li>delete column  <pre><code>    ALTER TABLE MyTable DROP COLUMN zone\n</code></pre></li> </ul>"},{"location":"databases/sqlserver/#insert","title":"insert","text":""},{"location":"databases/sqlserver/#datetime","title":"datetime","text":"<pre><code>    INSERT [dbo].[MyTable] ([ID], [DATEMyDatetime]) VALUES (500, convert(datetime, '2022-11-17 00:00:00', 121))\n</code></pre>"},{"location":"debian/msmtp/","title":"msmtp","text":""},{"location":"debian/msmtp/#install","title":"install","text":"<pre><code># apt install msmtp msmtp-mta\n</code></pre>"},{"location":"debian/msmtp/#config","title":"Config","text":"<pre><code># cat &lt;&lt; EOF &gt; /etc/msmtprc\n\ndefaults\nauth           on\ntls            on\ntls_starttls   on\ntls_trust_file /etc/ssl/certs/ca-certificates.crt\nlogfile        /var/log/msmtp\n\naccount        gmail\nauth           plain\nhost           smtp.gmail.com\nport           587\nfrom           sender@gmail.com\nuser           sender@gmail.com\npassword       XXXXXXXXXXXXXXXXXXXXXXXX\n\naccount default : gmail\nEOF\n# chown root:msmtp /etc/msmtprc\n# chmod 640 /etc/msmtprc\n</code></pre>"},{"location":"debian/msmtp/#test","title":"Test","text":"<pre><code>$ echo \"sample message\" | mail -s \"subject\" email@address\n</code></pre>"},{"location":"debian/network/","title":"Network","text":""},{"location":"debian/network/#ip-config","title":"IP config","text":""},{"location":"debian/network/#restart","title":"Restart","text":"<pre><code># systemctl restart networking.service\n</code></pre>"},{"location":"debian/network/#dhcp","title":"dhcp","text":"<pre><code># vim /etc/network/interfaces\niface eth0 inet dhcp\n</code></pre>"},{"location":"debian/network/#static","title":"static","text":"<pre><code># vim /etc/network/interfaces\niface eth0 inet static\naddress 192.168.1.83/24\ngateway 192.168.1.1\ndns-nameservers 192.168.1.20 192.168.1.1\ndns-domain local.culturelinux.lan\n</code></pre>"},{"location":"debian/nftables/","title":"NFtables","text":""},{"location":"debian/nftables/#enable","title":"Enable","text":"<pre><code># systemctl enable --now nftables\n</code></pre>"},{"location":"debian/nftables/#list","title":"List","text":"<pre><code># nft list ruleset\n</code></pre>"},{"location":"debian/nftables/#save","title":"Save","text":"<pre><code># nft list ruleset &gt;&gt; /etc/nftables.conf\n</code></pre>"},{"location":"debian/nftables/#flush","title":"Flush","text":"<pre><code># nft -f /etc/nftables.conf\n</code></pre>"},{"location":"debian/nftables/#basic-sshhttphttps","title":"Basic ssh,http,https","text":"<pre><code>nft add table inet firewall\nnft add chain inet firewall input { type filter hook input priority 0 \\; policy drop\\; } \nnft add rule inet firewall input ct state established,related accept\nnft add rule inet firewall input ct state invalid drop\nnft add rule inet firewall input ip protocol icmp limit rate 4/second accept\nnft add rule inet firewall input tcp dport { 22, http, https }\nnft add rule inet firewall input udp dport { 22, http, https }\n# don't forward anything, you're not a router!\nnft add chain inet firewall forward { type filter hook forward priority 0 \\; policy drop\\; } \n# allow all outgoing traffic\nnft add chain inet firewall output { type filter hook output priority 0 \\; policy accept\\; }\n</code></pre>"},{"location":"debian/packages/","title":"packages","text":""},{"location":"debian/packages/#apt","title":"Apt","text":""},{"location":"debian/packages/#update-upgrade","title":"update / upgrade","text":""},{"location":"debian/packages/#update","title":"update","text":"<p>refresh repository <pre><code># apt update \n</code></pre></p>"},{"location":"debian/packages/#upgrade","title":"upgrade","text":"<p>really upgrade packages <pre><code># apt upgrade\n</code></pre></p> <p>really upgrade packages and remove unused packages <pre><code># apt full-upgrade\n</code></pre></p>"},{"location":"debian/packages/#install-package","title":"install package","text":"<pre><code># apt install nmon\n</code></pre>"},{"location":"debian/packages/#remove-package","title":"remove package","text":"<pre><code># apt remove nmon\n</code></pre> <p>remove + purge  <pre><code># apt autoremove nmon\n</code></pre></p>"},{"location":"debian/packages/#package-provided-by","title":"package provided by","text":"<pre><code># apt install apt-file\n# apt-file update\n# apt-file search --package-only netstat\n</code></pre>"},{"location":"debian/packages/#nala","title":"Nala","text":""},{"location":"debian/packages/#install-from-repo","title":"install from repo","text":"<pre><code># apt install nala\n# nala --version\nnala 0.12.0\n</code></pre>"},{"location":"debian/packages/#install-from-asset","title":"install from asset","text":"<pre><code># wget https://gitlab.com/volian/nala/uploads/dd7631fdacb0c4837df18ed11b8bfe15/nala_0.14.0_all.deb\n# apt install ./nala_0.14.0_all.deb\n# nala --version\nnala 0.14.0\n</code></pre>"},{"location":"debian/packages/#fetch-best-mirror","title":"fetch best mirror","text":"<pre><code># nala fetch\n</code></pre>"},{"location":"debian/packages/#install-package_1","title":"install package","text":"<pre><code># nala install nmon\n</code></pre>"},{"location":"debian/packages/#get-history","title":"get history","text":"<pre><code>nala history\n</code></pre>"},{"location":"debian/packages/#rollback","title":"rollback","text":"<pre><code>nala history undo ID\n</code></pre>"},{"location":"debian/snap/","title":"Snap","text":""},{"location":"debian/snap/#install","title":"Install","text":"<pre><code># apt install snapd \n# systemctl enable --now snapd.service snapd.socket\n# systemctl status snapd.service snapd.socket\n# source /etc/profile.d/apps-bin-path.sh\n</code></pre>"},{"location":"debian/snap/#use","title":"Use","text":""},{"location":"debian/snap/#install_1","title":"install","text":"<pre><code># snap install hello-world\n</code></pre>"},{"location":"debian/snap/#list-installed","title":"list installed","text":"<pre><code># snap list\n</code></pre>"},{"location":"debian/snap/#search","title":"search","text":"<pre><code># snap find microk8s\n</code></pre>"},{"location":"debian/ufw/","title":"ufw (uncomplicate firewall)","text":""},{"location":"debian/ufw/#list-rules","title":"list rules","text":"<pre><code># ufw status\n# ufw status verbose\n# ufw status numbered\n</code></pre>"},{"location":"debian/ufw/#action","title":"action","text":"<pre><code># ufw enable\n# ufw disable\n</code></pre>"},{"location":"debian/ufw/#logging","title":"Logging","text":"<pre><code># ufw logging on\n# ufw logging off\n</code></pre>"},{"location":"debian/ufw/#simple-rules","title":"Simple rules","text":"<pre><code># ufw allow 80/tcp\n</code></pre>"},{"location":"debian/ufw/#advancerd-rules","title":"Advancerd rules","text":"<pre><code># ufw allow proto tcp from 192.168.1.62 to any port 80\n</code></pre>"},{"location":"git/git/","title":"git","text":""},{"location":"git/git/#install","title":"Install","text":"<pre><code>dnf install git\n</code></pre>"},{"location":"git/git/#basic","title":"Basic","text":""},{"location":"git/git/#repository-creation","title":"Repository creation","text":"<pre><code>git init\ngit init --initial-branch=develop\n</code></pre>"},{"location":"git/git/#status","title":"Status","text":"<pre><code> git status\n</code></pre>"},{"location":"git/git/#gitignore","title":".gitignore","text":"<pre><code>.gitignore\n</code></pre>"},{"location":"git/git/#ajout","title":"Ajout","text":"<pre><code>git add README.md\ngit add . \n</code></pre>"},{"location":"git/git/#commit","title":"Commit","text":"<pre><code>git commit -m \"Ajout README\"\ngit commit\n</code></pre>"},{"location":"git/git/#commit-editor","title":"Commit editor","text":"<pre><code>git config --global core.editor \"gedit\"\ngit config core.editor \"gedit\"\n</code></pre>"},{"location":"git/git/#git-log","title":"Git log","text":"<pre><code>git log\ngit log --pretty=oneline\ngit log --graph --pretty=format:'%Cred%h%Creset %C(bold blue)&lt;%an&gt;%Creset %Cgreen(%cr) -%C(yellow)%d%Creset %s' --abbrev-commit\n</code></pre>"},{"location":"git/git/#identity-user-gitconfig","title":"Identity (user) [~/.gitconfig]","text":"<pre><code>git config --global user.email = 'culturelinux@clinux.lan'\ngit config --global user.name = 'Clinux'\n</code></pre>"},{"location":"git/git/#identity-project-gitconfig","title":"Identity (project) [.git/config]","text":"<pre><code>git config user.email = 'culturelinux@clinux.lan'\ngit config user.name = 'Clinux'  \n</code></pre>"},{"location":"git/git/#identity-folder-envrc","title":"Identity (folder) [.envrc]","text":"<pre><code>echo 'Loading git account from direnv'\nname='Clinux'\nemail='culturelinux@clinux.lan'\nexport GIT_COMMITTER_NAME=\"$name\"\nexport GIT_COMMITTER_EMAIL=\"$email\"\nexport GIT_AUTHOR_NAME=\"$name\"\nexport GIT_AUTHOR_EMAIL=\"$email\"\n</code></pre>"},{"location":"git/git/#alias-git-config","title":"Alias git config","text":"<pre><code>git config --global alias.lg \"log --graph --pretty=format:'%Cred%h%Creset %C(bold blue)&lt;%an&gt;%Creset %Cgreen(%cr) -%C(yellow)%d%Creset %s'\"\ngit lg\n</code></pre>"},{"location":"git/git/#alias-git-env","title":"Alias git env","text":"<pre><code>alias g.='git add . -A'\nalias g.c='git add . -A &amp;&amp; gc'\nalias gba='git branch -a'\nalias gc='git commit -m'\nalias gcout='git checkout'\nalias glog='git log --stat --pretty=short --graph'\n</code></pre>"},{"location":"git/git/#git-diff","title":"Git diff","text":"<pre><code>git diff\ngit diff COMMIT COMMIT     \ngit log -p --\n</code></pre>"},{"location":"git/git/#checkout-commit-detached","title":"Checkout commit (detached)","text":"<pre><code>git checkout COMMIT\ngit switch -\n</code></pre>"},{"location":"git/git/#reset-commit-attached","title":"Reset commit (attached)","text":"<pre><code>git reset COMMIT\ngit reset COMMIT(old)\ngit reset --hard COMMIT\n</code></pre>"},{"location":"git/git/#medium","title":"Medium","text":""},{"location":"git/git/#change-remote","title":"change remote","text":"<pre><code>git remote set-url origin ssh://git@localhost:10022/GROUP/PROJECT.git\n</code></pre>"},{"location":"git/git/#faire-le-menage-sur-ses-branches-locales","title":"faire le menage sur ses branches locales","text":"<pre><code>git fetch --prune\ngit branch -vv | awk '/: gone]/{print $1}' | xargs -r git branch -d\ngit fetch --all --prune\n</code></pre>"},{"location":"git/gitlab/","title":"Gitlab","text":""},{"location":"git/gitlab/#install","title":"Install","text":""},{"location":"git/gitlab/#docker","title":"Docker","text":"<pre><code>https://github.com/sameersbn/docker-gitlab\n</code></pre>"},{"location":"git/gitlab/#backup","title":"Backup","text":"<pre><code>docker-compose down\ndocker-compose run --rm gitlab app:rake gitlab:backup:create\n</code></pre>"},{"location":"git/gitlab/#debian","title":"Debian","text":""},{"location":"git/gitlab/#specific-version","title":"specific version","text":"<pre><code># apt install wget ca-certificates curl apt-transport-https gnupg2 -y\n# curl -s https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | bash\n# curl -s https://packages.gitlab.com/gpg.key | apt-key add -\n# chmod 644 /usr/share/keyrings/gitlab_gitlab-ce-archive-keyring.gpg\n# apt install gitlab-ce=16.6.6-ce.0\n</code></pre>"},{"location":"git/gitlab/#setup","title":"setup","text":"<pre><code>vi /etc/gitlab/gitlab.rb\n</code></pre>"},{"location":"git/gitlab/#rocky","title":"Rocky","text":"<pre><code>dnf -y update\ndnf -y install curl vim policycoreutils python3-policycoreutils git  firewalld epel-release\ncurl -s https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.rpm.sh | sudo bash\ndnf --showduplicates list gitlab-ce\ndnf install gitlab-ce-16.11.2-ce.0.el9\nsystemctl enable firewalld\nsystemctl start firewalld\nfirewall-cmd --zone=public --add-service=http\nfirewall-cmd --zone=public --add-service=https\nfirewall-cmd --zone=public --add-service=ssh\nfirewall-cmd --runtime-to-permanent\n</code></pre>"},{"location":"git/gitlab/#update","title":"Update","text":""},{"location":"git/gitlab/#rocky_1","title":"Rocky","text":"<pre><code>dnf update -x gitlab-ce\ndnf update gitlab-ce-18.2.8-ce.0.el9\n</code></pre>"},{"location":"git/gitlab/#setup-omnibus","title":"Setup (omnibus)","text":""},{"location":"git/gitlab/#url","title":"Url","text":"<p><code>vi /etc/gitlab/gitlab.rb     external_url 'http://gitlab.culturelinux.lan'</code> <code>gitlab-ctl reconfigure     gitlab-ctl status</code></p>"},{"location":"git/gitlab/#url-https","title":"Url https","text":"<p><code>vi /etc/gitlab/gitlab.rb     external_url 'https://gitlab.local.clinux.fr'       nginx['enable'] = true     nginx['redirect_http_to_https'] = true     nginx['ssl_certificate'] = \"/etc/gitlab/ssl/_.local.clinux.fr.crt\"     nginx['ssl_certificate_key'] = \"/etc/gitlab/ssl/_.local.clinux.fr.key\"</code> <code>gitlab-ctl reconfigure     gitlab-ctl status</code></p>"},{"location":"git/gitlab/#root-account","title":"root account","text":"<pre><code>cat /etc/gitlab/initial_root_password\n</code></pre>"},{"location":"git/gitlab/#backup_1","title":"Backup","text":"<pre><code>gitlab-backup create\ntar cvzf gitlab-conf.tar.gz /etc/gitlab/*\nscp {/var/opt/gitlab/backups/*,gitlab-conf.tar.gz}  backup@backup_server:/path/\n</code></pre>"},{"location":"git/gitlab/#restore","title":"Restore","text":"<p>Installer la meme version de gitlab que celle du backup \u00e0 restorer <pre><code>    gitlab-ctl stop puma\n    gitlab-ctl stop sidekiq\n    gitlab-ctl status\n    gitlab-backup restore BACKUP=11493107454_2018_04_25_10.6.4-ce\n    gitlab-ctl restart\n    gitlab-rake gitlab:check SANITIZE=true\n</code></pre></p>"},{"location":"git/gitlab/#upgrade","title":"Upgrade","text":"<pre><code>gitlab-rake gitlab:check\ngitlab-rake gitlab:doctor:secrets\ndnf upgrade\n</code></pre> <p>Une fois l'upgrade fait, il faut attendre la fin des background migrations</p>"},{"location":"git/gitlab/#small-config","title":"Small config","text":"<pre><code>/etc/gitlab/gitlab.rb\nalertmanager['enable'] = false\ngitlab_exporter['enable'] = false\ngitlab_kas['enable'] = false\nnode_exporter['enable'] = false\npostgres_exporter['enable'] = false\nprometheus['enable'] = false\nredis_exporter['enable'] = false\n</code></pre>"},{"location":"git/gitlab/#ci-cd","title":"CI-CD","text":""},{"location":"git/gitlab/#install-runner","title":"Install runner","text":"<pre><code>curl -L --output /usr/local/bin/gitlab-runner \"https://s3.dualstack.us-east-1.amazonaws.com/gitlab-runner-downloads/latest/binaries/gitlab-runner-linux-amd64\"\nchmod +x /usr/local/bin/gitlab-runner\nuseradd --comment 'GitLab Runner' --create-home gitlab-runner --shell /bin/bash\ngitlab-runner install --user=gitlab-runner --working-directory=/home/gitlab-runner\ngitlab-runner start\n</code></pre>"},{"location":"git/gitlab/#register-v17x","title":"Register (v17.x)","text":""},{"location":"git/gitlab/#webui","title":"webui","text":"<ul> <li>https://git.local.clinux.fr/admin/runners/new    </li> <li>Ajout d'un tag (my-cd-tag)</li> </ul>"},{"location":"git/gitlab/#runner","title":"runner","text":""},{"location":"git/gitlab/#cli-glab","title":"CLI glab","text":""},{"location":"git/gitlab/#install_1","title":"install","text":"<pre><code>wget https://gitlab.com/gitlab-org/cli/-/releases/v1.45.0/downloads/glab_1.45.0_Linux_x86_64.tar.gz\ntar xvzf glab_*_Linux_x86_64.tar.gz\nmv bin/glab /usr/local/bin/\n</code></pre>"},{"location":"git/gitlab/#login","title":"Login","text":"<pre><code>glab auth login --hostname gitlab.fqdn --stdin &lt; ~/.gitlab.token\n</code></pre>"},{"location":"git/gitlab/#clean-pipelines","title":"Clean pipelines","text":"<p><pre><code> glab ci delete --status success --repo git.clinux.lan/GROUP/REPO\n</code></pre> <pre><code>docker exec --user git -it sameersbn-gitlab-gitlab-1 bundle exec rake gitlab:cleanup:orphan_job_artifact_files DRY_RUN=false RAILS_ENV=production\n</code></pre></p>"},{"location":"git/gitlab/#pipeline","title":"Pipeline","text":""},{"location":"git/gitlab/#list","title":"list","text":"<pre><code>glab pipeline list --sort asc\nglab pipeline list --sort asc -P 5\n</code></pre>"},{"location":"git/gitlab/#delete","title":"delete","text":"<pre><code>for id in `glab pipeline list --sort asc -P 200| awk '{print substr($3,2)}'| tail -n+2`; do glab pipeline delete $id; done\n</code></pre>"},{"location":"git/gitlab/#artifact","title":"artifact","text":"<pre><code>docker exec --user git -it gitlab_gitlab_1 bundle exec rake gitlab:cleanup:orphan_job_artifact_files DRY_RUN=false RAILS_ENV=production\n</code></pre>"},{"location":"git/gitlab/#container-image","title":"container image","text":""},{"location":"git/gitlab/#delete_1","title":"delete","text":"<pre><code>docker exec -it gitlab_registry_1 /bin/sh\nregistry garbage-collect /etc/docker/registry/config.yml\nregistry garbage-collect --delete-untagged /etc/docker/registry/config.yml\n</code></pre>"},{"location":"git/gitlab/#troubleshooting","title":"Troubleshooting","text":""},{"location":"git/gitlab/#migration-fail","title":"Migration fail","text":"<pre><code>psql -h localhost -U gitlab -d gitlabhq_production -W\ngitlabhq_production=&gt; ALTER TABLE sent_notifications DROP COLUMN id_convert_to_bigint;\ngitlabhq_production=&gt; \\q\n</code></pre>"},{"location":"git/gitlab/#chercher-les-cles-ssh","title":"Chercher les cl\u00e9s ssh","text":""},{"location":"git/gitlab/#connexion-a-la-base","title":"Connexion \u00e0 la base","text":"<pre><code>docker exec -it sameersbn-gitlab-postgresql-1 bash\n</code></pre>"},{"location":"git/gitlab/#recherche-dans-les-utilisateurs","title":"Recherche dans les utilisateurs","text":"<pre><code>SELECT k.id AS key_id,\n    k.title,\n    k.fingerprint,\n    u.id AS user_id,\n    u.username,\n    u.email,\n    k.created_at\nFROM keys k\nJOIN users u ON k.user_id = u.id ;\n</code></pre>"},{"location":"git/gitlab/#recherche-dans-les-projets","title":"Recherche dans les projets","text":"<pre><code>SELECT k.id AS key_id,\n    k.type,\n    k.title,\n    k.fingerprint,\n    p.id AS project_id,\n    n.path || '/' || p.path AS full_path,\n    dkp.can_push,\n    dkp.created_at\nFROM keys k\nJOIN deploy_keys_projects dkp ON k.id = dkp.deploy_key_id\nJOIN projects p ON dkp.project_id = p.id\nJOIN namespaces n ON p.namespace_id = n.id;\n</code></pre>"},{"location":"ia/ollama/","title":"\ud83e\udde0 Ollama","text":""},{"location":"ia/ollama/#installation","title":"\ud83d\udcbe Installation","text":"<p>Pour installer Ollama, suivez ces \u00e9tapes :</p> <pre><code>dnf install curl tar gzip unzip\ncurl -fsSL https://ollama.com/install.sh | sh\nsystemctl enable --now ollama\nsystemctl status ollama\nfirewall-cmd --add-port=11434/tcp --permanent\nfirewall-cmd --reload\n</code></pre>"},{"location":"ia/ollama/#ouvrir-les-ports","title":"\ud83d\ude80 Ouvrir les ports","text":"<p>Pour ouvrir les ports n\u00e9cessaires \u00e0 Ollama, modifiez le fichier de service :</p> <pre><code>systemctl edit ollama.service\n</code></pre> <p>Editez la section <code>[Service]</code> et ajoutez :</p> <pre><code>Environment=\"OLLAMA_HOST=0.0.0.0:11434\"\n</code></pre> <p>Relancez le service pour prendre en compte les modifications :</p> <pre><code>systemctl daemon-reload\nsystemctl restart ollama\n</code></pre>"},{"location":"ia/ollama/#liste-des-modeles","title":"\ud83d\udcda Liste des mod\u00e8les","text":"<p>Pour afficher la liste des mod\u00e8les disponibles, utilisez :</p> <pre><code>curl -sS http://localhost:11434/api/models | jq .\nollama list\n</code></pre>"},{"location":"ia/ollama/#test-de-modeles","title":"\ud83d\ude0a Test de mod\u00e8les","text":""},{"location":"ia/ollama/#petit-et-cpu-friendly","title":"Petit et cpu-friendly \ud83c\udf21\ufe0f","text":"<p>Testez le mod\u00e8le \"Gemma2\" :</p> <pre><code>ollama pull gemma2:2b\nollama run gemma2:2b \"Salut, r\u00e9sume-moi bri\u00e8vement ce serveur.\"\n</code></pre>"},{"location":"ia/ollama/#petit-et-cpu-friendly-avec-beaucoup-de-ram","title":"\ud83d\udcbe Petit et cpu-friendly (avec beaucoup de ram)","text":"<p>Testez le mod\u00e8le \"Mistral\" :</p> <pre><code>ollama pull mistral:latest\nollama run mistral:latest \"Donne un plan d'attaque pour d\u00e9ployer un service web.\"\n</code></pre>"},{"location":"iac/ansible/","title":"Ansible","text":""},{"location":"iac/ansible/#install","title":"Install","text":""},{"location":"iac/ansible/#pipx","title":"pipx","text":"<pre><code>sudo dnf install pipx\npipx install --include-deps ansible\npipx inject --include-apps ansible argcomplete\n</code></pre>"},{"location":"iac/ansible/#upgrade","title":"Upgrade","text":"<pre><code>pipx upgrade --include-injected ansible\n</code></pre>"},{"location":"iac/ansible/#test","title":"Test","text":"<pre><code>python3 -m pip -V\nansible --version\nansible-community --version\n</code></pre>"},{"location":"iac/ansible/#config","title":"Config","text":"<pre><code>ansible-config init --disabled -t all &gt; ansible.cfg\n</code></pre>"},{"location":"iac/ansible/#inventory","title":"inventory","text":""},{"location":"iac/ansible/#setup","title":"setup","text":"<pre><code># single host\nbpg-debian12 ansible_host=192.168.1.170 ansible_user=debian\n</code></pre>"},{"location":"iac/ansible/#test_1","title":"test","text":"<pre><code>ansible bpg-debian12 -m ping -i inventory\nansible all -m ping -i inventory\n</code></pre>"},{"location":"iac/ansible/#envvar","title":"envvar","text":"<pre><code>export ANSIBLE_INVENTORY=inventory\n</code></pre>"},{"location":"iac/ansible/#playbook","title":"playbook","text":""},{"location":"iac/ansible/#create-test","title":"create test","text":"<pre><code>---\n- name : test user\n  hosts: bpg-debian12\n  remote_user: debian\n  become: true\n\n  tasks:\n  - name: get id\n    shell: id\n    register: results\n  - name: Add the user 'clinux'\n    ansible.builtin.user:\n      name: clinux\n      comment: created by ansible\n  - name: break\n    shell: exit 1\n    ignore_errors: true\n  - name: Remove the user 'clinux'\n    ansible.builtin.user:\n      name: clinux\n      state: absent\n      remove: yes\n\n  - name: Install some packages\n    package:\n      name:\n        - htop\n        - curl\n        - nmon\n        - net-tools\n        - nginx\n      state: latest\n\n  - name: Make sure a service unit is running\n    ansible.builtin.systemd_service:\n      state: started\n      enabled: true\n      name: nginx\n\n  - debug:\n      var: results.stdout \n</code></pre>"},{"location":"iac/ansible/#create-post-tofu-root","title":"create post tofu root","text":"<pre><code>---\n- name: \"tofu : setup root key\"\n  ansible.builtin.copy:\n    remote_src: true\n    src: /home/debian/.ssh/authorized_keys\n    dest: /root/.ssh/authorized_keys\n    owner: root\n    group: root\n    mode: '0600'\n\n- name: \"tofu : allow root sshkey\"\n  lineinfile:\n    path: /etc/ssh/sshd_config\n    regexp: '(.*)PermitRootLogin(.*)$'\n    line: 'PermitRootLogin without-password'\n    owner: root\n\n- name: \"tofu : reload ssh\"\n  service:\n    name: ssh\n    state: restarted\n</code></pre>"},{"location":"iac/ansible/#execute","title":"Execute","text":"<pre><code>ansible-playbook plb_get_user.yml -i inventory\nexport ANSIBLE_INVENTORY=inventory\nansible-playbook plb_get_user.yml\n</code></pre>"},{"location":"iac/ansible/#roles","title":"Roles","text":""},{"location":"iac/ansible/#create","title":"Create","text":""},{"location":"iac/ansible/#galaxy","title":"galaxy","text":"<pre><code>ansible-galaxy init roles/post_tofu --offline\n</code></pre>"},{"location":"iac/ansible/#custom","title":"custom","text":""},{"location":"iac/ansible/#structure","title":"structure","text":"<p><code>mkdir -p roles/post_tofu/tasks</code></p>"},{"location":"iac/ansible/#tasks","title":"tasks","text":""},{"location":"iac/ansible/#main","title":"main","text":"<pre><code>cat &lt;&lt; EOF &gt; roles/post_tofu/tasks/main.yml\n- include_tasks: copy_ssh_key_root.yml\nEOF\n</code></pre>"},{"location":"iac/ansible/#task-sshkey","title":"task sshkey","text":"<pre><code>cat &lt;&lt; EOF &gt; roles/post_tofu/tasks/copy_ssh_key_root.yml\n---\n- name: copy ssh authozied_keys to root\n  ansible.builtin.copy:\n    src: /home/debian/.ssh/authorized_keys\n    dest: /root/.ssh/authorized_keys\n    remote_src: yes\n    owner: root\n    group: root\n\n- name: Update and upgrade apt packages\n  apt:\n    upgrade: yes\n    update_cache: yes\n    cache_valid_time: 86400 #One day\nEOF\n</code></pre>"},{"location":"iac/ansible/#playbook_1","title":"playbook","text":"<pre><code>cat &lt;&lt; EOF &gt; deploy_post_tofu.yml\n---\n- name : post actions tofu\n  hosts: debian12\n  remote_user: debian\n  become: true\n\n  roles:\n    - post_tofu\nEOF\n</code></pre>"},{"location":"iac/ansible/#run","title":"run","text":"<pre><code>ansible-playbook deploy_post_tofu.yml\n</code></pre>"},{"location":"iac/ansible/#nginx","title":"Nginx","text":""},{"location":"iac/ansible/#structure_1","title":"structure","text":"<pre><code>mkdir -p roles/nginx/{tasks,handlers,files}\n</code></pre>"},{"location":"iac/ansible/#tasks_1","title":"tasks","text":"<p><pre><code>cat &lt;&lt; EOF &gt; roles/nginx/tasks/main.yml\n</code></pre> <pre><code>---\n- include_tasks: install_packages.yml\n- include_tasks: configuration.yml\nEOF\n</code></pre> <pre><code>cat &lt;&lt; EOF &gt; roles/nginx/tasks/install_packages.yml\n</code></pre> <pre><code>---\n- name: Install nginx\n  package:\n    name:\n      - nginx\n      - net-tools\n    state: latest\n\n- name: Make sure a service unit is running\n  ansible.builtin.systemd_service:\n    state: started\n    enabled: true\n    name: nginx\nEOF\n</code></pre> <pre><code>cat &lt;&lt; EOF &gt; roles/nginx/tasks/configuration.yml\n- name: copy configuration\n  copy:\n    src: nginx.conf\n    dest: /etc/nginx/nginx.conf\n    owner: root\n    group: root\n  notify: restart_nginx\n  tags:\n    - configuration_nginx\nEOF\n</code></pre></p>"},{"location":"iac/ansible/#handlers","title":"handlers","text":"<pre><code>cat &lt;&lt; EOF &gt; roles/nginx/handlers/main.yml\n- name: Restart nginx\n  service:\n    name: nginx\n    state: restarted\n  listen: restart_nginx\nEOF\n</code></pre>"},{"location":"iac/ansible/#files","title":"files","text":"<pre><code>cat &lt;&lt; EOF &gt; roles/nginx/files/nginx.conf\nuser www-data;\nworker_processes auto;\npid /run/nginx.pid;\nerror_log /var/log/nginx/error.log;\ninclude /etc/nginx/modules-enabled/*.conf;\n\nevents {\n    worker_connections 768;\n    # multi_accept on;\n}\n\nhttp {\n\n    ##\n    # Basic Settings\n    ##\n\n    sendfile on;\n    tcp_nopush on;\n    types_hash_max_size 2048;\n    # server_tokens off;\n\n    server_names_hash_bucket_size 64;\n    # server_name_in_redirect off;\n\n    include /etc/nginx/mime.types;\n    default_type application/octet-stream;\n\n    ##\n    # SSL Settings\n    ##\n\n    ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3; # Dropping SSLv3, ref: POODLE\n    ssl_prefer_server_ciphers on;\n\n    ##\n    # Logging Settings\n    ##\n\n    access_log /var/log/nginx/access_default.log;\n\n    ##\n    # Gzip Settings\n    ##\n\n    gzip on;\n\n    gzip_vary on;\n    gzip_proxied any;\n    gzip_comp_level 6;\n    gzip_buffers 16 8k;\n    gzip_http_version 1.1;\n    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;\n\n    ##\n    # Virtual Host Configs\n    ##\n\n    include /etc/nginx/conf.d/*.conf;\n    include /etc/nginx/sites-enabled/*;\n}\nEOF\n</code></pre>"},{"location":"iac/ansible/#playbook_2","title":"playbook","text":"<pre><code>cat &lt;&lt; EOF &gt; deploy_webservers.yml\n---\n- name : post actions tofu\n  hosts: webservers\n  become: true\n  roles:\n    - nginx\nEOF        \n</code></pre>"},{"location":"iac/ansible/#run_1","title":"run","text":"<pre><code>ansible-playbook deploy_webservers.yml\n</code></pre>"},{"location":"iac/opentofu/","title":"OpenTofu","text":""},{"location":"iac/opentofu/#github","title":"Github","text":"<pre><code>wget https://github.com/opentofu/opentofu/releases/download/v1.11.1/tofu_1.11.1_linux_amd64.zip\nunzip tofu*\ncp tofu /usr/local/bin/\n</code></pre>"},{"location":"iac/opentofu/#examples","title":"Examples","text":"<ul> <li>\u2705 GitHub repo</li> </ul>"},{"location":"iac/opentofu/#providers","title":"Providers","text":"<ul> <li>\u2620\ufe0f Telmate</li> <li>\u2705 BPG</li> </ul>"},{"location":"iac/opentofu/#add-role","title":"Add role","text":"<pre><code>pveum role add OpenTofu -privs \"Datastore.Allocate Datastore.AllocateSpace Datastore.AllocateTemplate Datastore.Audit Pool.Allocate Sys.Audit Sys.Console Sys.Modify SDN.Use VM.Allocate VM.Audit VM.Clone VM.Config.CDROM VM.Config.Cloudinit VM.Config.CPU VM.Config.Disk VM.Config.HWType VM.Config.Memory VM.Config.Network VM.Config.Options VM.Migrate VM.Monitor VM.PowerMgmt User.Modify\"\n\nor\n\nUse PVEAdmin\n</code></pre>"},{"location":"iac/opentofu/#add-user","title":"Add user","text":"<pre><code>pveum user add opentofu@pve\n</code></pre>"},{"location":"iac/opentofu/#link-role-user","title":"link role user","text":"<pre><code>pveum aclmod / -user opentofu@pve -role OpenTofu\n</code></pre>"},{"location":"iac/opentofu/#generate-token","title":"generate token","text":"<pre><code>pveum user token add opentofu@pve opentofu -expire 0 -privsep 0 -comment \"OpenTofu token\"\n</code></pre>"},{"location":"iac/opentofu/#test-token","title":"test token","text":"<pre><code>curl -X GET 'https://$PROXMOX_URL:8006/api2/json/nodes' -H 'Authorization: PVEAPIToken=opentofu@pve!opentofu=$TOKEN'\n</code></pre>"},{"location":"iac/opentofu/#exemple","title":"Exemple","text":""},{"location":"iac/opentofu/#avec-variables-static","title":"Avec variables static","text":""},{"location":"iac/opentofu/#providertf","title":"provider.tf","text":"<pre><code>terraform {\n    required_providers {\n        proxmox =  {\n        source = \"bpg/proxmox\"\n        version = \"&gt;= 0.38.1\"\n        }\n    }\n}\nprovider \"proxmox\" {\n    endpoint = var.pm_api_url\n    api_token = var.pm_api_token\n    insecure = false  # Warning TLS cert of proxmox webui must be valid (Let's Encrypt)\n    ssh {\n        agent    = true\n        username = \"root\"\n    }\n}\n</code></pre>"},{"location":"iac/opentofu/#varstf","title":"vars.tf","text":"<pre><code>variable  \"pm_api_url\" {\n    default =  \"https://$PROXMOX_URL:8006/api2/json\"\n}\nvariable  \"pm_api_token\" {\n    default =  \"opentofu@pve!opentofu=XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\"\n}\nvariable  \"target_node\" {\n    default =  \"proxmox2\"\n}\nvariable  \"ssh_key\" {\n    default =  \"ssh-ed25519 XXXXXXXX clinux@rocky9.local\"\n}\n</code></pre>"},{"location":"iac/opentofu/#avec-variables-denvironnement","title":"Avec variables d'environnement","text":""},{"location":"iac/opentofu/#envvars","title":"envvars","text":"<pre><code>export PROXMOX_VE_ENDPOINT='https://PROXMOX_URL:8006/'\nexport PROXMOX_VE_API_TOKEN='USER@REMAM!TOKEN_KEY=TOKEN_VALUE'\n</code></pre>"},{"location":"iac/opentofu/#providertf_1","title":"provider.tf","text":"<pre><code>terraform {\n    required_providers {\n        proxmox =  {\n        source = \"bpg/proxmox\"\n        version = \"&gt;= 0.38.1\"\n        }\n    }\n}\nprovider \"proxmox\" {\n    insecure = false  # Warning TLS cert of proxmox webui must be valid (Let's Encrypt)\n}\n</code></pre>"},{"location":"iac/opentofu/#maintf","title":"main.tf","text":"<pre><code>resource \"proxmox_virtual_environment_vm\" \"debian_vm\" {\n    name        = \"bpg-debian12\"\n    description = \"Managed by opentofu\"\n    tags        = [\"opentofu\", \"debian\"]\n    node_name = var.target_node\n    clone {\n        vm_id = \"1000\"\n    }\n\n    cpu {\n        cores = 2\n        type = \"host\"\n        numa = true\n    }\n    memory {\n        dedicated = 2048\n    }\n    network_device {\n        bridge = \"vmbr0\"\n        model = \"virtio\"\n    }\n\n    efi_disk {\n        datastore_id = \"local-lvm\"\n        file_format = \"raw\"\n        type    = \"4m\"\n    }\n\n    disk {\n        datastore_id = \"local-lvm\"\n        file_format = \"raw\"\n        interface = \"scsi0\"\n        size = \"10\"\n    }\n\n    operating_system {\n        type = \"l26\"\n    }\n    machine = \"q35\"\n    agent {\n        enabled = false\n    }\n\n    initialization {\n        ip_config {\n            ipv4 {\n                address = \"192.168.1.170/24\"\n                gateway = \"192.168.1.1\"\n            }\n        }\n        user_account {\n            keys     = [var.ssh_key]\n            password = \"tofu\"\n            username = \"debian\"\n        }\n    }\n}\n</code></pre>"},{"location":"iac/opentofu/#outils","title":"Outils","text":""},{"location":"iac/opentofu/#linter","title":"Linter","text":""},{"location":"kubernetes/mikrok8s/","title":"mikrok8s","text":""},{"location":"kubernetes/mikrok8s/#requierement","title":"Requierement","text":"<ul> <li>snap</li> <li>sudo package     # apt install sudo</li> </ul>"},{"location":"kubernetes/mikrok8s/#install","title":"Install","text":"<pre><code># snap install microk8s --classic\n# nft tcp dport 16443 counter accept comment \"accept kube\"\n</code></pre>"},{"location":"kubernetes/mikrok8s/#get-konfig","title":"Get konfig","text":"<pre><code># microk8s config\n</code></pre>"},{"location":"kubernetes/mikrok8s/#get-token","title":"Get token","text":"<pre><code># token=$(microk8s kubectl -n kube-system get secret | grep default-token | cut -d \" \" -f1) \n# microk8s kubectl -n kube-system describe secret $token | grep token:\n</code></pre>"},{"location":"kubernetes/mikrok8s/#add-addon","title":"Add addon","text":"<pre><code># microk8s enable dashboard \n# microk8s enable storage\n</code></pre>"},{"location":"kubernetes/mikrok8s/#add-loadbalancer","title":"Add loadbalancer","text":"<pre><code># microk8s enable metallb:PUBLICIP-PUBLICIP\n</code></pre>"},{"location":"kubernetes/mikrok8s/#kubectl","title":"kubectl","text":""},{"location":"kubernetes/mikrok8s/#setup","title":"setup","text":"<pre><code>$ export KUBECONFIG=~/.kube/microk8s\n$ kubectl get pods -A\n</code></pre>"},{"location":"kubernetes/mikrok8s/#dashboard","title":"dashboard","text":"<pre><code>$ microk8s kubectl describe secret -n kube-system microk8s-dashboard-token\n$ kubectl proxy\n</code></pre> <ul> <li>local dashboard</li> </ul>"},{"location":"kubernetes/mikrok8s/#grafana","title":"Grafana","text":""},{"location":"kubernetes/mikrok8s/#install_1","title":"install","text":"<pre><code># microk8s enable prometheus\n# microk8s status\n</code></pre>"},{"location":"kubernetes/mikrok8s/#access","title":"access","text":"<ul> <li>port forwad (k9s)</li> <li>admin:prom-operator</li> </ul>"},{"location":"linux/crontab/","title":"Crontab","text":"<p>Un utilitaire unix qui permet d'executer des taches automatiques \u00e0 un certain moment.</p>"},{"location":"linux/crontab/#structure","title":"\ud83d\udc77\u200d\u2640\ufe0f\u200b Structure","text":""},{"location":"linux/crontab/#utilisateur","title":"Utilisateur","text":"<pre><code>* * * * * commande\n</code></pre>"},{"location":"linux/crontab/#systeme","title":"Syst\u00e8me","text":"<pre><code>* * * * * utilisateur commande\n</code></pre>"},{"location":"linux/crontab/#champs","title":"Champs","text":"<ul> <li>Minute (0\u201359)</li> <li>Heure (0\u201323)</li> <li>Jour du mois (1\u201331)</li> <li>Mois (1\u201312)</li> <li>Jour de la semaine (0\u20137, avec 0 ou 7 = dimanche)</li> </ul>"},{"location":"linux/crontab/#meta-caracteres","title":"Meta caract\u00e8res","text":"<ul> <li>Les champs peuvent \u00eatre remplac\u00e9s par des caract\u00e8res sp\u00e9ciaux :<ul> <li><code>*</code> : toutes les valeurs possibles</li> <li><code>,</code> : s\u00e9paration entre valeurs</li> <li><code>-</code> : intervalle de valeurs</li> <li><code>/</code> : pas (ex: 0/2 = tous les deux minutes)</li> </ul> </li> </ul>"},{"location":"linux/crontab/#exemples","title":"Exemples","text":""},{"location":"linux/crontab/#chaque-jour-a-800","title":"Chaque jour a 8:00","text":"<pre><code>0 8 * * * /path/absolu/script.sh\n</code></pre>"},{"location":"linux/crontab/#le-1er-jour-du-mois-a-200","title":"Le 1er jour du mois \u00e0 2:00","text":"<pre><code>0 2 1 * * /path/absolu/script.sh\n</code></pre>"},{"location":"linux/crontab/#le-15-de-tous-les-mois-impairs-a-1600","title":"Le 15 de tous les mois impairs \u00e0 16:00","text":"<pre><code>0 16 15 */2 * /path/absolu/script.sh\n</code></pre>"},{"location":"linux/crontab/#tous-les-lundis-matin-a-700","title":"Tous les lundis matin \u00e0 7:00","text":"<pre><code>0 7 * * 1 /path/absolu/script.sh\n</code></pre>"},{"location":"linux/crontab/#les-3-premiers-jours-du-mois-a-900","title":"Les 3 premiers jours du mois \u00e0 9:00","text":"<pre><code>0 9 1-3 * * /path/absolu/script.sh\n</code></pre>"},{"location":"linux/crontab/#toutes-les-15-minutes-entre-700-et-1700-de-lundi-a-vendredi","title":"Toutes les 15 minutes entre 7:00 et 17:00 de lundi a vendredi","text":"<pre><code>*/15 7-17 * * 1-5 /path/absolu/script.sh\n</code></pre>"},{"location":"linux/crontab/#limitations","title":"Limitations","text":"<ul> <li>La r\u00e9solution minimale est de 1 minute </li> <li>Le script doit \u00eatre d\u00e9fini par son chemin absolu</li> <li>Le script n'a pas connaissance de l'environnement (.bashrc, .bash_profile)</li> </ul>"},{"location":"linux/crontab/#operations","title":"Op\u00e9rations","text":""},{"location":"linux/crontab/#par-utilisateur","title":"Par utilisateur","text":"<pre><code>crontab -u rocky -l\n</code></pre>"},{"location":"linux/crontab/#liste","title":"Liste","text":"<pre><code>crontab -l\n</code></pre>"},{"location":"linux/crontab/#creation","title":"Cr\u00e9ation","text":"<pre><code>export EDITOR=vim\ncrontab -e\n</code></pre>"},{"location":"linux/crontab/#suppression","title":"Suppression","text":"<pre><code>crontab -r\n</code></pre>"},{"location":"linux/crontab/#suivi-des-logs","title":"Suivi des logs","text":"<pre><code>sudo tail -f /var/log/cron\nsudo journalctl -u crond.service -f\n</code></pre>"},{"location":"linux/environnement/","title":"\ud83c\udf10\ufe0f Bash","text":""},{"location":"linux/environnement/#profile","title":"Profile","text":"<p>Profile personnalis\u00e9 pour le syst\u00e8me.</p> <pre><code>vi /etc/profile.d/custom_conf\n</code></pre>"},{"location":"linux/environnement/#alias","title":"Alias","text":"<p>Liste des alias disponibles dans le shell.</p> <pre><code>alias\n</code></pre>"},{"location":"linux/environnement/#shell","title":"\ud83d\udd27 Shell","text":"<p>Alias personnalis\u00e9s pour facilitation de la saisie dans le terminal.</p> <pre><code>alias sbin='cd /usr/local/sbin'\nalias cp='cp -i'\nalias dfg='df -h'\nalias dus='du -ms $(ls -A)'\nalias dusx='du -xms $(ls -A)'\nalias h='history'\nalias j='jobs -l'\nalias l.='ls -d .* --color=auto'\nalias ll='ls -l --color=auto'\nalias lla='ls -alrt'\nalias ls='ls --color=auto'\nalias mkdir='mkdir -pv'\nalias mv='mv -i'\nalias nets='netstat -tnlpv'\n</code></pre>"},{"location":"linux/environnement/#git","title":"\ud83d\ude80 Git","text":"<p>Alias pour les commandes git couramment utilis\u00e9es.</p> <pre><code>alias g.='git add . -A'\nalias g.c='git add . -A &amp;&amp; gc'\nalias gba='git branch -a'\nalias gc='git commit -m'\nalias gcout='git checkout'\nalias gdu='git diff @{upstream}'\nalias gfd='git fetch --dry-run'\nalias glog='git log --stat --pretty=short --graph'\nalias glr='git remote -v'\nalias glt='git tag'\nalias gph='git push origin'\nalias gs='git status'\n</code></pre>"},{"location":"linux/environnement/#iptables","title":"iptables","text":"<p>Alias pour afficher et manipuler les r\u00e8gles de pare-feu iptables.</p> <pre><code>alias iptlist='iptables -L -n -v --line-numbers'\nalias iptlistfw='iptables -L FORWARD -n -v --line-numbers'\nalias iptlistin='iptables -L INPUT -n -v --line-numbers'\nalias iptlistnat='iptables -t nat -v -L -n --line-number'\nalias iptlistout='iptables -L OUTPUT -n -v --line-number'\nalias iptrestore='iptables-restore &lt;  /etc/iptables/rules.v4'\nalias iptsave='iptables-save &gt; /etc/iptables/rules.v4'\n</code></pre>"},{"location":"linux/environnement/#firewalld","title":"Firewalld","text":"<p>Alias pour afficher et g\u00e9rer les r\u00e8gles de pare-feu firewalld.</p> <pre><code>alias fwlist='firewall-cmd --info-zone public'\nfunction fwaddport(){\n            firewall-cmd --add-port=${1} --permanent &amp;&amp; firewall-cmd --reload\n            firewall-cmd --info-zone public\n}\nfunction fwremport(){\n            firewall-cmd --remove-port=${1} --permanent &amp;&amp; firewall-cmd --reload\n            firewall-cmd --info-zone public\n}\nfunction fwaddservice(){\n            firewall-cmd --add-service=${1} --permanent &amp;&amp; firewall-cmd --reload\n            firewall-cmd --info-zone public\n}\nfunction fwremservice(){\n            firewall-cmd --remove-service=${1} --permanent &amp;&amp; firewall-cmd --reload\n            firewall-cmd --info-zone public\n}\n</code></pre>"},{"location":"linux/environnement/#fail2ban","title":"Fail2Ban","text":"<p>Alias pour g\u00e9rer les r\u00e8gles de protection contre le brute force avec Fail2ban.</p> <pre><code>alias f2breload='fail2ban-client reload'\nalias f2bwssh='watch fail2ban-client status sshd'\nalias f2bssh='fail2ban-client status sshd'\n</code></pre>"},{"location":"linux/gnome/","title":"Gnome","text":""},{"location":"linux/gnome/#num-lock","title":"Num lock","text":"<pre><code>gsettings get org.gnome.desktop.peripherals.keyboard numlock-state\ngsettings get org.gnome.desktop.peripherals.keyboard remember-numlock-state\ngsettings set org.gnome.desktop.peripherals.keyboard numlock-state true\n</code></pre>"},{"location":"linux/grub/","title":"Grub","text":""},{"location":"linux/grub/#kernel-en-cours","title":"Kernel en cours","text":"<pre><code>uname -r\n</code></pre>"},{"location":"linux/grub/#kernels-installes","title":"Kernels install\u00e9s","text":"<p><code>ls -l /boot/vmlinuz-*</code></p>"},{"location":"linux/grub/#rocky-9","title":"Rocky 9","text":"<pre><code>/boot/loader/entries/858382f092494811bf89e090de079ab1-0-rescue.conf:title Rocky Linux (0-rescue-858382f092494811bf89e090de079ab1) 9.5 (Blue Onyx)\n/boot/loader/entries/858382f092494811bf89e090de079ab1-5.14.0-503.14.1.el9_5.x86_64.conf:title Rocky Linux (5.14.0-503.14.1.el9_5.x86_64) 9.5 (Blue Onyx)\n/boot/loader/entries/a343998b88a34ce78a8a06339e65eeab-5.14.0-503.33.1.el9_5.x86_64.conf:title Rocky Linux (5.14.0-503.33.1.el9_5.x86_64) 9.5 (Blue Onyx)\n/boot/loader/entries/a343998b88a34ce78a8a06339e65eeab-0-rescue.conf:title Rocky Linux (0-rescue-a343998b88a34ce78a8a06339e65eeab) 9.5 (Blue Onyx)\n</code></pre>"},{"location":"linux/grub/#debian-12-proxmxo","title":"Debian 12 (proxmxo)","text":"<pre><code>grep -P \"submenu|menuentry\" /boot/grub/grub.cfg | cut -d \"'\" -f2\n</code></pre>"},{"location":"linux/grub/#changer-le-kernel","title":"Changer le kernel","text":""},{"location":"linux/grub/#rocky9","title":"Rocky9","text":""},{"location":"linux/grub/#prochain-kernel-au-boot","title":"Prochain kernel au boot","text":"<pre><code>grub2-editenv list\n</code></pre>"},{"location":"linux/grub/#forcer-le-prochain-kernel-au-boot","title":"Forcer le prochain kernel au boot","text":"<pre><code>grub2-reboot \"Rocky Linux (5.14.0-503.14.1.el9_5.x86_64) 9.5 (Blue Onyx)\"\n</code></pre>"},{"location":"linux/grub/#changer-definitivement-le-kernel-au-boot","title":"Changer definitivement le kernel au boot","text":"<pre><code>grub2-set-default \"Rocky Linux (5.14.0-503.33.1.el9_5.x86_64) 9.5 (Blue Onyx)\"\n</code></pre>"},{"location":"linux/grub/#proxmox-8","title":"Proxmox 8","text":""},{"location":"linux/grub/#prochain-kernel-au-boot_1","title":"Prochain kernel au boot","text":"<p><pre><code>grep GRUB_DEFAULT /etc/default/grub \n</code></pre> <pre><code>0\n</code></pre> * C'est le 1er koernel qui va booter <pre><code>grep -P \"submenu|menuentry\" /boot/grub/grub.cfg\n</code></pre> <pre><code>if [ x\"${feature_menuentry_id}\" = xy ]; then\n  menuentry_id_option=\"--id\"\n  menuentry_id_option=\"\"\nexport menuentry_id_option\nmenuentry 'Proxmox VE GNU/Linux' --class proxmox --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-simple-f768d6b7-5898-4c6b-827d-aab79581f769' {\nsubmenu 'Advanced options for Proxmox VE GNU/Linux' $menuentry_id_option 'gnulinux-advanced-f768d6b7-5898-4c6b-827d-aab79581f769' {\n        menuentry 'Proxmox VE GNU/Linux, with Linux 6.8.12-9-pve' --class proxmox --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-6.8.12-9-pve-advanced-f768d6b7-5898-4c6b-827d-aab79581f769' {\n        menuentry 'Proxmox VE GNU/Linux, with Linux 6.8.12-9-pve (recovery mode)' --class proxmox --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-6.8.12-9-pve-recovery-f768d6b7-5898-4c6b-827d-aab79581f769' {\n        menuentry 'Proxmox VE GNU/Linux, with Linux 6.8.12-8-pve' --class proxmox --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-6.8.12-8-pve-advanced-f768d6b7-5898-4c6b-827d-aab79581f769' {\n        menuentry 'Proxmox VE GNU/Linux, with Linux 6.8.12-8-pve (recovery mode)' --class proxmox --class gnu-linux --class gnu --class os $menuentry_id_option 'gnulinux-6.8.12-8-pve-recovery-f768d6b7-5898-4c6b-827d-aab79581f769' {\n</code></pre> * Ici ca sera <code>Proxmox VE GNU/Linux, with Linux 6.8.12-9-pve</code></p>"},{"location":"linux/grub/#forcer-le-prochain-kernel-au-boot_1","title":"Forcer le prochain kernel au boot","text":"<pre><code>grub2-reboot \"Rocky Linux (5.14.0-503.14.1.el9_5.x86_64) 9.5 (Blue Onyx)\"\n</code></pre>"},{"location":"linux/grub/#changer-definitivement-le-kernel-au-boot_1","title":"Changer definitivement le kernel au boot","text":"<pre><code>grub2-set-default \"Rocky Linux (5.14.0-503.33.1.el9_5.x86_64) 9.5 (Blue Onyx)\"\n</code></pre>"},{"location":"linux/history/","title":"Historique \ud83d\udcdc","text":"<p>Cette section fournit un aper\u00e7u des commandes et configurations li\u00e9es \u00e0 l'historique des commandes dans un shell Unix/Linux. \ud83d\udcbb</p>"},{"location":"linux/history/#afficher","title":"Afficher \ud83d\udc40","text":"<p>Cette sous-section explique comment afficher et rechercher dans l'historique des commandes. \ud83d\udd0d</p>"},{"location":"linux/history/#lister","title":"Lister \ud83d\udccb","text":"<p>Affiche toutes les commandes ex\u00e9cut\u00e9es pr\u00e9c\u00e9demment. <pre><code>$ history\n</code></pre></p>"},{"location":"linux/history/#rechercher-tout","title":"rechercher tout \ud83d\udd0e","text":"<p>Explique comment rechercher des commandes sp\u00e9cifiques dans l'historique \u00e0 l'aide de grep et de raccourcis. <pre><code>$ history | grep sudo\n$ !sudo:p \n$ !18:p\n</code></pre></p>"},{"location":"linux/history/#recherche-interactive","title":"Recherche interactive \ud83d\udd75\ufe0f\u200d\u2642\ufe0f","text":"<p>D\u00e9crit comment utiliser la recherche interactive pour trouver des commandes dans l'historique.  <pre><code>Ctrl + R  \n</code></pre></p>"},{"location":"linux/history/#action","title":"Action \u2699\ufe0f","text":"<p>Cette sous-section couvre les actions pouvant \u00eatre effectu\u00e9es sur l'historique des commandes. \ud83d\udd27</p>"},{"location":"linux/history/#executer","title":"Ex\u00e9cuter \u25b6\ufe0f","text":"<p>Montre comment r\u00e9ex\u00e9cuter des commandes sp\u00e9cifiques de l'historique. <pre><code>$ !sudo\n$ !18\n</code></pre></p>"},{"location":"linux/history/#nettoyer-lhistorique","title":"Nettoyer l'historique \ud83e\uddf9","text":"<p>Explique comment effacer l'historique des commandes. <pre><code>$ history -cw\n$ &gt; ~/.bash_history\n</code></pre></p>"},{"location":"linux/history/#config","title":"Config \u2699\ufe0f","text":"<p>Cette sous-section d\u00e9taille les configurations possibles pour l'historique des commandes. \ud83d\udee0\ufe0f</p>"},{"location":"linux/history/#ajouter-un-horodatage","title":"Ajouter un horodatage \u23f0","text":"<p>Indique comment ajouter un horodatage \u00e0 chaque commande dans l'historique. <pre><code>$ echo \"export HISTTIMEFORMAT='%F, %T '\" &gt;&gt; ~/.bashrc\n$ source ~/.bashrc\n</code></pre></p>"},{"location":"linux/history/#augmenter-la-longueur-de-lhistorique-par-defaut-1000","title":"Augmenter la longueur de l'historique (par d\u00e9faut 1000) \ud83d\udd1d","text":"<p>Explique comment augmenter la longueur par d\u00e9faut de l'historique des commandes. <pre><code>$ echo \"HISTSIZE=10000\" &gt;&gt; ~/.bashrc\n$ echo \"HISTFILESIZE=10000\" &gt;&gt; ~/.bashrc    \n$ source ~/.bashrc\n</code></pre></p>"},{"location":"linux/history/#ecriture-directe-dans-lhistorique","title":"\u00c9criture directe dans l'historique \ud83d\udcdd","text":"<p>Montre comment configurer l'\u00e9criture directe des commandes dans le fichier d'historique. <pre><code>$ echo \"PROMPT_COMMAND='history -a'\" &gt;&gt; ~/.bashrc   \n$ source ~/.bashrc\n</code></pre></p>"},{"location":"linux/history/#ne-pas-ecrire-dans-lhistorique","title":"NE PAS \u00e9crire dans l'historique \ud83d\udcdd","text":"<p>Montre comment configurer l'\u00e9criture directe des commandes dans le fichier d'historique. <pre><code>$ echo \"HISTCONTROL='ignoreboth:erasedups'\" &gt;&gt; ~/.bashrc   \n$ source ~/.bashrc\n</code></pre></p>"},{"location":"linux/history/#aide","title":"Aide \u2699\ufe0f","text":""},{"location":"linux/history/#alias-court","title":"Alias court","text":"<p>Ajoute l'alias <code>h</code> pour appeler <code>history</code> <pre><code>$ echo \"alias h='history'\" &gt;&gt; ~/.bashrc   \n$ source ~/.bashrc\n</code></pre></p>"},{"location":"linux/history/#recherche-courte","title":"Recherche courte","text":"<p>Ajoute la fonction <code>hg</code> pour rechercher dans l'historique <pre><code>$ echo \"function hg (){\n    history | grep $^1\n}\" &gt;&gt; ~/.bashrc   \n$ source ~/.bashrc\n</code></pre></p>"},{"location":"linux/network/","title":"Network","text":""},{"location":"linux/network/#listen-port","title":"Listen port","text":"<pre><code>netstat -tnlpv\n</code></pre>"},{"location":"linux/nmap/","title":"Nmap","text":""},{"location":"linux/nmap/#get-host-with-icmp","title":"Get host with icmp","text":"<pre><code># nmap -sn 192.168.1.0/24\n</code></pre>"},{"location":"linux/nmap/#_1","title":"Nmap","text":""},{"location":"linux/permissions/","title":"\ud83d\ude80 Permissions Linux","text":""},{"location":"linux/permissions/#permissions-standard","title":"\ud83d\udcda Permissions standard","text":""},{"location":"linux/permissions/#alphabetique","title":"\ud83d\udcdd Alphabetique","text":"<ul> <li>Lecture (r): L'utilisateur peut lire le contenu du fichier ou dossier.</li> <li>Ecriture (w): L'utilisateur peut \u00e9crire dans le fichier ou supprimer son contenu.</li> <li>Execution (x): L'utilisateur peut ex\u00e9cuter un programme ou un script associ\u00e9 au fichier.</li> </ul> <p>Par exemple, le droit <code>rwx</code> signifie que l'utilisateur a les droits de lecture, d'\u00e9criture et d'ex\u00e9cution sur un fichier ou dossier.</p>"},{"location":"linux/permissions/#numerique","title":"\ud83d\udcdd Num\u00e9rique","text":"<p>Les permissions peuvent \u00e9galement \u00eatre cod\u00e9es en base 10. Chaque droits est repr\u00e9sent\u00e9 par une valeur num\u00e9rique :</p> <ul> <li>Lecture (r): 4</li> <li>Ecriture (w): 2</li> <li>Execution (x): 1</li> </ul> <p>Pour combiner ces droits, on les ajoute entre eux. Par exemple, la permission <code>rwx</code> correspond au calcul suivant : 4 + 2 + 1 = 7.</p>"},{"location":"linux/permissions/#permissions-avancees","title":"Permissions avanc\u00e9es","text":""},{"location":"linux/permissions/#setuid","title":"Setuid","text":"<p>\u26a0\ufe0f Attention a ce droit surtout pour root car il est execut\u00e9 avec cet utilisateur</p> <pre><code>chmod u+s monbinaire\nchmod u-s monbinaire\n</code></pre>"},{"location":"linux/permissions/#setgid","title":"Setgid","text":"<pre><code>chmod u+s monbinaire\nchmod u-s monbinaire\n</code></pre>"},{"location":"linux/permissions/#repertoire","title":"R\u00e9pertoire","text":"<p>\u26a0\ufe0f Pour renter dans un r\u00e9pertoire, il faut avoir les droits d'ex\u00e9cution (<code>x</code>).</p>"},{"location":"linux/permissions/#sticky-bit","title":"\ud83d\udcda Sticky Bit","text":"<p>Le sticky bit est un attribut qui emp\u00eache les utilisateurs normaux d'effacer ou de d\u00e9placer des fichiers dans un r\u00e9pertoire. Cela peut \u00eatre utile pour prot\u00e9ger des fichiers sensibles.</p> <p>\u26a0\ufe0f Le sticky bit ne bloque que les suppressions entre utilisateurs normaux. Le propri\u00e9taire du dossier garde le contr\u00f4le total.</p> <pre><code>chmod +t /home/alice/monrep\nchmod -t /home/alice/monrep\n</code></pre>"},{"location":"linux/permissions/#setuid-et-setgid","title":"setuid et setgid","text":""},{"location":"linux/permissions/#setuid_1","title":"setuid","text":"<p>Le setuid est un attribut qui permet au propri\u00e9taire du fichier de l'ex\u00e9cuter avec les privil\u00e8ges du propri\u00e9taire, plut\u00f4t que ceux de l'utilisateur ex\u00e9cutant le programme.</p> <pre><code>chmod u+s /usr/bin/sudo\n</code></pre>"},{"location":"linux/permissions/#lsattr-et-chattr","title":"\ud83c\udf3f lsattr et chattr","text":"<p><code>lsattr</code> et <code>chattr</code> sont des commandes utiles pour manipuler les attributs (flags) de fichiers ou dossiers, qui peuvent inclure des droits additionnels :</p> <ul> <li>Flags: <ul> <li>a: uniquement ajouter du contenu</li> <li>c: compression du contenu sur le disque </li> <li>d: ne sauvegarde pas lors de l'appel \u00e0 dump</li> <li>i: rendre le fichier immuable </li> <li>j: journalise les modifications avant d'\u00e9crire sur le disque</li> <li>s: passe les blocks \u00e0 0 lors de la suppression</li> <li>T: permet de separer les r\u00e9pertoires enfants dans des blocs disques diff\u00e9rents</li> </ul> </li> </ul> <p><code>chattr</code> permet de d\u00e9finir ces attributs sur des fichiers ou dossiers :</p> <pre><code>sudo chattr +i fichier.txt\nsudo chattr -i fichier.txt\n</code></pre>"},{"location":"linux/permissions/#acls-access-control-lists","title":"\ud83d\udcd7 ACLs (Access Control Lists)","text":"<p>ACLs sont une alternative aux permissions bas\u00e9es sur les groupes et les utilisateurs. Elles permettent de donner des droits sp\u00e9cifiques \u00e0 des individus ou des groupes individuels.</p>"},{"location":"linux/permissions/#test","title":"Test","text":"<pre><code>#!/bin/bash\n\necho \"\ud83d\udd0d V\u00e9rification du support ACL sur le syst\u00e8me de fichiers...\" \necho \"------------------------------------------------------------\"\n\n# 1. Afficher les points de montage et leurs syst\u00e8mes de fichiers\necho -e \"\\n\ud83d\udcc1 Points de montage :\"\nfindmnt -o TARGET,FSTYPE,OPTIONS | grep -v tmpfs\n\n# 2. V\u00e9rifier si 'acl' est une option de montage active\necho -e \"\\n\ud83d\udd27 V\u00e9rification des options de montage contenant 'acl' :\"\nmount | grep acl || echo \"\u274c Aucun syst\u00e8me de fichiers mont\u00e9 avec l'option explicite 'acl'. Peut \u00eatre activ\u00e9 par d\u00e9faut.\"\n\n# 3. V\u00e9rifier les entr\u00e9es fstab\necho -e \"\\n\ud83d\udcdc V\u00e9rification de /etc/fstab pour 'acl' :\"\ngrep acl /etc/fstab || echo \"\u274c Aucune option 'acl' dans /etc/fstab.\"\n\n# 4. Test r\u00e9el sur un fichier temporaire\nTMPFILE=\"/tmp/test_acl_$$\"\ntouch \"$TMPFILE\"\n\necho -e \"\\n\ud83e\uddea Test pratique : ajout d'une ACL sur un fichier temporaire : $TMPFILE\"\nif setfacl -m u:$(whoami):r \"$TMPFILE\" 2&gt;/dev/null; then\n    echo \"\u2705 ACL ajout\u00e9e avec succ\u00e8s. Support ACL fonctionnel sur /tmp.\"\n    getfacl \"$TMPFILE\"\nelse\n    echo \"\u274c Impossible d'ajouter une ACL. Ce syst\u00e8me de fichiers ne supporte probablement pas les ACLs.\"\nfi\n\nrm -f \"$TMPFILE\"\n\n# 5. V\u00e9rification du kernel (pour les syst\u00e8mes avec config.gz dispo)\necho -e \"\\n\ud83e\udde0 V\u00e9rification du support ACL dans le noyau :\"\nif [ -f /proc/config.gz ]; then\n    zgrep CONFIG_EXT4_FS_POSIX_ACL /proc/config.gz || echo \"\u274c Option noyau CONFIG_EXT4_FS_POSIX_ACL absente ou d\u00e9sactiv\u00e9e.\"\nelse\n    echo \"\u2139\ufe0f Fichier /proc/config.gz introuvable. Impossible de v\u00e9rifier la config du noyau.\"\nfi\n\necho -e \"\\n\ud83c\udf89 V\u00e9rification termin\u00e9e.\"\n</code></pre>"},{"location":"linux/permissions/#basique","title":"Basique","text":"<pre><code>setfacl -m u:alice:rwx fichier.txt\nsetfacl -x u:alice:w fichier.txt\n</code></pre>"},{"location":"linux/permissions/#forcer-les-droits-sur-tous-les-fichiers-et-dossiers-dans-un-repertoire","title":"Forcer les droits sur tous les fichiers et dossiers dans un r\u00e9pertoire","text":"<pre><code>setfacl -d -m u:alice:rwX /home/alice/monrep\nsetfacl -m u:alice:rwX /home/alice/monrep\n</code></pre>"},{"location":"linux/rescue/","title":"Rescue","text":""},{"location":"linux/rescue/#live-system","title":"Live system","text":""},{"location":"linux/rescue/#create-folder","title":"Create folder","text":"<pre><code>mkdir /rescue\n</code></pre>"},{"location":"linux/rescue/#check-local-disks","title":"Check local disks","text":"<pre><code>fdisk -l\nDisk /dev/sda: 931.51 GiB, 1000204886016 bytes, 1953525168 sectors\nDisk model: HGST HTE721010A9\nUnits: sectors of 1 * 512 = 512 bytes\nSector size (logical/physical): 512 bytes / 4096 bytes\nI/O size (minimum/optimal): 4096 bytes / 4096 bytes\nDisklabel type: dos\nDisk identifier: 0x573d05ad\n\nDevice     Boot      Start        End    Sectors  Size Id Type\n/dev/sda1  *          2048    1050623    1048576  512M 83 Linux\n/dev/sda2          1050624 1951422463 1950371840  930G 83 Linux\n/dev/sda3       1951422464 1953519615    2097152    1G 82 Linux swap / Solaris\n</code></pre>"},{"location":"linux/rescue/#mount-local-disks","title":"Mount local disks","text":"<pre><code>mount -v /dev/sda2 /rescue/\nmount -v /dev/sda1 /rescue/boot/\nmount -v -t proc proc /rescue/proc/\nmount -v -t sysfs sys /rescue/sys/\nmount -v -o bind /dev /rescue/dev/\nmount -v -t devpts pts /rescue/dev/pts/\nchroot /rescue /bin/bash\n</code></pre>"},{"location":"linux/rescue/#rescue_1","title":"Rescue","text":""},{"location":"linux/rescue/#unmout","title":"Unmout","text":"<pre><code>umount -Rv /rescue\n</code></pre>"},{"location":"linux/security/","title":"Security","text":""},{"location":"linux/security/#rkhunter","title":"rkhunter","text":""},{"location":"linux/security/#install","title":"install","text":"<pre><code># apt install rkhunter\n</code></pre>"},{"location":"linux/security/#run","title":"run","text":"<pre><code># rkhunter -c --rwo\n</code></pre> <ul> <li>-c : check </li> <li>--rwo : report warning only</li> </ul>"},{"location":"linux/security/#lynis","title":"lynis","text":"<pre><code># cd /usr/local/sbin &amp;&amp; git clone https://github.com/CISOfy/lynis\n# lynis audit system\n</code></pre>"},{"location":"linux/storage/","title":"Storage","text":"<p>Cette section fournit une vue d'ensemble des commandes et des configurations relatives au gestionnaire de stockage disque.</p>"},{"location":"linux/storage/#re-scan-le-disque-sans-demarrer","title":"Re-scan le disque sans d\u00e9marrer \ud83d\udd04","text":"<pre><code>echo \"- - -\" | tee /sys/class/scsi_host/host*/scan\n</code></pre>"},{"location":"linux/storage/#secourir-le-disque","title":"Secourir le disque \ud83d\udea8","text":"<pre><code>dd if=/dev/sdc of=/home/mako/damaged_P300_disk.img bs=64K conv=noerror,sync\n</code></pre>"},{"location":"linux/storage/#extension-de-disque","title":"Extension de disque \ud83d\udcbe","text":"<p>Cette sous-section explique comment v\u00e9rifier et \u00e9tendre les partitions disques.</p>"},{"location":"linux/storage/#verification","title":"V\u00e9rification \ud83d\udcca","text":"<p>V\u00e9rifie la taille actuelle du disque et des partitions. <pre><code>lsblk\n</code></pre> Exemple de sortie :</p> <pre><code>NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS\nsdb       8:16   0  110G  0 disk\n\u2514\u2500sdb1    8:17   0  100G  0 part /rsync\n</code></pre>"},{"location":"linux/storage/#etendre-la-partition","title":"\u00c9tendre la partition \ud83d\udd04","text":"<p>Explique comment \u00e9tendre la taille de la partition.</p> <p><pre><code>growpart -N /dev/sdb 1  #dry-run\ngrowpart /dev/sdb 1\n</code></pre> V\u00e9rifie les nouvelles tailles des partitions. <pre><code>lsblk\n</code></pre> Exemple de sortie : <pre><code>NAME    MAJ:MIN RM  SIZE RO TYPE MOUNTPOINTS\nsdb       8:16   0  110G  0 disk\n\u2514\u2500sdb1    8:17   0  110G  0 part /rsync\n</code></pre></p>"},{"location":"linux/storage/#verifie-lutilisation-du-disque-de-stockage","title":"V\u00e9rifie l'utilisation du disque de stockage \ud83d\udcc8.","text":"<p><pre><code>df -h\n</code></pre> Exemple de sortie : <pre><code>Filesystem      Size  Used Avail Use% Mounted on\n/dev/sdb1        98G   24K   93G   1% /rsync\n</code></pre></p>"},{"location":"linux/storage/#fs-standard-ext","title":"FS standard (ext*)","text":"<p>R\u00e9ajuste le syst\u00e8me de fichiers pour utiliser l'espace allou\u00e9 \u00e0 la partition \u00e9tendue \ud83d\udd01. <pre><code>resize2fs /dev/sdb1\n</code></pre> V\u00e9rifie les nouvelles utilisations du disque de stockage \ud83d\udcc8. <pre><code>Filesystem      Size  Used Avail Use% Mounted on\n/dev/sdb1       108G   24K  103G   1% /rsync\n</code></pre></p>"},{"location":"linux/storage/#fs-xfs","title":"FS XFS","text":"<pre><code>resize2fs /dev/sdb1\n</code></pre>"},{"location":"linux/storage/#lvm","title":"LVM","text":"<pre><code>parted /dev/sda \nshow\nresizepart 2 100%\n\nfdisk -l \npvs\npvresize /dev/sda2\npvs\n\nlvs\nlvextend -l +100%Free /dev/mapper/rl-root\nlvs\n\nxfs_growfs /dev/mapper/rl-root\ndf -h\n</code></pre>"},{"location":"linux/storage/#iscsi","title":"ISCSI","text":"<p>Cette sous-section traite de l'installation et du g\u00e9rer les portes d'acc\u00e8s iSCSI.</p>"},{"location":"linux/storage/#install","title":"Install","text":"<p>Installe les paquets n\u00e9cessaires pour iSCSI. <pre><code>apt -y install open-iscsi lsscsi\n</code></pre></p>"},{"location":"linux/storage/#decouverte","title":"D\u00e9couverte \ud83d\udd0d","text":"<p>D\u00e9couvre les targets iSCSI disponibles \u00e0 partir de l'IP/DNS sp\u00e9cifi\u00e9 \ud83d\udcbb.</p> <pre><code>iscsiadm -m discovery -t sendtargets -p ${IP/DNS}\n</code></pre>"},{"location":"linux/storage/#connexion","title":"Connexion \ud83d\udd04","text":"<p>Se connecte aux targets iSCSI d\u00e9couverts \ud83d\ude80.</p> <pre><code>iscsiadm -m node --login\n</code></pre>"},{"location":"linux/storage/#affichage","title":"Affichage \ud83d\udd0d","text":"<p>Affiche les sessions iSCSI actives et listes des p\u00e9riph\u00e9riques SCSI \ud83d\udcbb.</p> <pre><code>iscsiadm -m session -o show\nlsscsi\n</code></pre>"},{"location":"linux/storage/#demarrage-automatique","title":"D\u00e9marrage automatique \ud83d\ude80","text":"<pre><code>vi /etc/iscsi/nodes/************/default\nnode.startup=automatic \nlsscsi --transport\n</code></pre>"},{"location":"linux/storage/#deconnexion","title":"D\u00e9connexion \ud83d\udca5","text":"<p>D\u00e9connecte des targets iSCSI \ud83d\ude80. <pre><code>iscsiadm --mode node --target ${IQN} --portal ${IP/DNS} --logout\niscsiadm --mode node --logoutall=all\n</code></pre></p>"},{"location":"linux/storage/#au-demarrage","title":"Au d\u00e9marrage \u23e9","text":""},{"location":"linux/storage/#sambacifs","title":"samba/cifs \ud83d\udcbb","text":"<p>Installe les paquets n\u00e9cessaires pour Samba.</p> <p><pre><code>apt install  samba-common smbclient samba-common-bin smbclient  cifs-utils\n</code></pre> <pre><code>vi /root/.rasp\nuser=SMBusername\npassword=SMBpassword\n</code></pre> <pre><code>//192.168.1.10/SMB_share_name   /mnt/nas      cifs    uid=0,credentials=/root/.rasp,iocharset=utf8,vers=3.0,noperm,noserverino,nofail  0 0\n</code></pre></p>"},{"location":"linux/storage/#swap","title":"Swap \ud83d\udcbe","text":""},{"location":"linux/storage/#creation","title":"Cr\u00e9ation \ud83d\udd04","text":"<p>Cr\u00e9e un fichier swap de 2 Go.</p> <pre><code>fallocate -l 2G /swap\nchmod 600 /swap\nmkswap /swap\n</code></pre>"},{"location":"linux/storage/#activation","title":"Activation","text":"<pre><code>swapon /swap\nswapon --show\n</code></pre>"},{"location":"linux/storage/#persistention","title":"Persistention \u23e9","text":"<pre><code>cp /etc/fstab /etc/fstab.bak\necho '/swap none swap sw 0 0' | tee -a /etc/fstab\n</code></pre>"},{"location":"linux/storage/#seuil-temporaire","title":"Seuil (temporaire) \ud83d\udd01","text":"<p>V\u00e9rifie la valeur actuelle du param\u00e8tre swapiness. <pre><code>cat /proc/sys/vm/swappiness\nsysctl vm.swappiness=10\n</code></pre></p> <p>V\u00e9rifie la valeur actuelle du param\u00e8tre pression du cache. <pre><code>cat /proc/sys/vm/vfs_cache_pressure\nsysctl vm.vfs_cache_pressure=50\n</code></pre></p>"},{"location":"linux/storage/#seuil-permanent","title":"Seuil (permanent) \u23e9","text":"<pre><code>vi /etc/sysctl.conf\nvm.swappiness=10\nvm.vfs_cache_pressure=50\nsysctl -p\n</code></pre>"},{"location":"linux/storage/#diagnostique","title":"Diagnostique \ud83d\ude80","text":"<p>Installe la commande smem pour surveiller les ressources utilis\u00e9es. <code>sh apt install smem</code></p>"},{"location":"linux/sudoers/","title":"Sudoers","text":""},{"location":"linux/sudoers/#user-to-otheruser-no-password","title":"user to otheruser (no password)","text":""},{"location":"linux/sudoers/#sudoersd-file","title":"sudoers.d file","text":"<p><pre><code>vi /etc/sudoers.d/10-gitlab-runner\n</code></pre> <pre><code>gitlab-runner ALL=(otheruser) NOPASSWD: /full/path/to/executable\n</code></pre> <pre><code>vi /etc/sudoers.d/10-gitlab-runner\n</code></pre></p>"},{"location":"linux/sudoers/#check","title":"check","text":"<pre><code>su - otheruser\nsudo -l\n</code></pre>"},{"location":"linux/users/","title":"Utilisateurs \ud83d\ude0a","text":""},{"location":"linux/users/#utilisateurs-reguliers","title":"Utilisateurs r\u00e9guliers \ud83e\udd16\ufe0f","text":""},{"location":"linux/users/#obtenir-lidentifiant-de-lutilisateur-actuel","title":"Obtenir l'identifiant de l'utilisateur actuel \ud83d\udcdd","text":"<pre><code>$ id\nuid=1000(clinux) gid=1000(clinux) groups=1000(clinux)\n</code></pre>"},{"location":"linux/users/#obtenir-les-utilisateurs-connectes","title":"Obtenir les utilisateurs connect\u00e9s \ud83d\udcbb\ufe0f","text":"<pre><code>who\n</code></pre>"},{"location":"linux/users/#mise-a-zero-du-cache-de-compteur-dutilisateurs","title":"Mise a z\u00e9ro du cache de compteur d'utilisateurs","text":"<pre><code>tee /var/run/utmp &lt; /dev/null\n</code></pre>"},{"location":"linux/users/#changer-le-mot-de-passe","title":"Changer le mot de passe \ud83d\udd11\ufe0f","text":"<pre><code>$ passwd\nChanging password for user clinux.\nCurrent password:\nNew password:\nRetype new password:\npasswd: all authentication tokens updated successfully.\n</code></pre>"},{"location":"linux/users/#obtenir-lage-du-mot-de-passe","title":"Obtenir l'\u00e2ge du mot de passe \ud83d\udcc5\ufe0f","text":"<pre><code>$ chage -l clinux\nLast password change                                    : Sep 30, 2023\nPassword expires                                        : never\nPassword inactive                                       : never\nAccount expires                                         : never\nMinimum number of days between password change          : 0\nMaximum number of days between password change          : 99999\nNumber of days of warning before password expires       : 7\n</code></pre>"},{"location":"linux/users/#administration-des-utilisateurs","title":"Administration des utilisateurs \ud83d\udee0\ufe0f","text":""},{"location":"linux/users/#durcissement","title":"Durcissement \ud83d\udee1\ufe0f","text":""},{"location":"linux/users/#etclogindefs","title":"/etc/login.defs \ud83d\udd10","text":"<ul> <li>Changer le UMASK d'orgine dans /etc/login(022) \u00e0 077 pour eviter le partage des fichiers entre les utilisateurs.</li> </ul>"},{"location":"linux/users/#creer-un-nouvel-utilisateur","title":"Cr\u00e9er un nouvel utilisateur \ud83e\udd16","text":"<pre><code># useradd -m -s /bin/bash -d /home/alice alice\n</code></pre> <ul> <li>-m : cr\u00e9er le r\u00e9pertoire personnel du nouvel utilisateur</li> <li>-s : d\u00e9finir l'interpr\u00e9teur de commandes par d\u00e9faut (shell) pour le nouvel utilisateur</li> <li>-d : d\u00e9finir le chemin du r\u00e9pertoire personnel du nouvel utilisateur</li> <li>-g : d\u00e9finir le groupe principal du nouvel utilisateur</li> <li>-G : d\u00e9finir les groupes suppl\u00e9mentaires du nouvel utilisateur (group1,group2)</li> <li>-c : d\u00e9finir la description du nouvel utilisateur</li> <li>-e : d\u00e9finir la date d'expiration du mot de passe (YYYY-MM-DD)</li> </ul>"},{"location":"linux/users/#changer-lage-du-mot-de-passe","title":"Changer l'age du mot de passe \ud83d\udd10","text":"<pre><code># chage -I -1 -m 1 -M 90 -E -1 -d $(date '+%F') clinux\n</code></pre> <ul> <li>-I : jour avant le blocage du compte</li> <li>-I : day before account is locked</li> <li>-m : minimal duration before password can be changed</li> <li>-M : maximum duration of valid password</li> <li>-E : date of password expiration (days from timestamp init)</li> <li>-d : date of password changing</li> </ul>"},{"location":"linux/users/#voir-un-utilisateur-specifique","title":"Voir un utilisateur sp\u00e9cifique \ud83d\udce6","text":"<pre><code># id alice\n</code></pre>"},{"location":"linux/users/#ajouter-un-utilisateur-aux-groupes","title":"Ajouter un utilisateur aux groupes \ud83c\udf0d","text":"<pre><code># usermod \u2013aG group1,group2 alice\n</code></pre>"},{"location":"linux/users/#supprimer-un-utilisateur-des-groupes","title":"Supprimer un utilisateur des groupes \ud83c\udf10","text":"<pre><code># usermod \u2013G group2 alice\n# usermod \u2013G '' alice\n</code></pre>"},{"location":"linux/users/#supprimer-un-utilisateur-du-systeme","title":"Supprimer un utilisateur du syst\u00e8me \ud83d\udca3","text":"<pre><code># userdel -r clinux\n</code></pre> <ul> <li>-r : supprime le r\u00e9pertoire de l'utilisateur (par d\u00e9faut /home/username)</li> <li>-Z : supprime le contexte SELinux pour le compte d'utilisateur</li> <li>-f : force la suppression sans demander confirmation et m\u00eame si l'utilisateur est connect\u00e9 sur le syst\u00e8me \ud83d\udca5</li> </ul>"},{"location":"linux/users/#su-switch-user","title":"SU (Switch User) \ud83d\udd04","text":""},{"location":"linux/users/#su-","title":"su - \ud83d\ude80","text":"<p>On demande l'acces au shell de root (en donnant le mot de passe root)     su - </p>"},{"location":"linux/users/#changer-dutilisateur","title":"Changer d'utilisateur \ud83e\udd16","text":"<pre><code>su -l alice \nsu - alice\n</code></pre>"},{"location":"linux/users/#lancer-une-commande-en-tant-quun-autre-utilisateur","title":"Lancer une commande en tant qu'un autre utilisateur \ud83c\udfae","text":"<pre><code>su -l alice -c \"id &amp;&amp; pwd\"\n</code></pre>"},{"location":"linux/users/#sudoers","title":"Sudoers \ud83d\udce6","text":"<p>Gerer finement (ou pas) des droits supplementaires sur le systeme.</p>"},{"location":"linux/users/#editeur","title":"Editeur","text":"<p>\u26a0\ufe0f Attention, la modification des droits sudoers doit se faire avec precaution. Le fichier <code>/etc/sudoers</code> est tr\u00e8s sensible et peut causer des probl\u00e8mes si modifi\u00e9 incorrectement. L'edition des droits sudoers se fait avec <code>visudo</code> qui permet de v\u00e9rifier les droits avant de les modifier.</p> <pre><code># visudo\n</code></pre>"},{"location":"linux/users/#syntaxe","title":"Syntaxe","text":""},{"location":"linux/users/#possibilite-de-devenir-root-sans-mot-de-passe","title":"Possibilite de devenir root sans mot de passe","text":"<pre><code>alice ALL=(ALL) NOPASSWD: ALL\n</code></pre>"},{"location":"linux/users/#autoriser-uniquement-une-commande-avec-un-certain-argument-pour-un-utilisateur-specifique","title":"Autoriser uniquement une commande avec un certain argument pour un utilisateur sp\u00e9cifique","text":"<pre><code>alice ALL=(ALL) NOPASSWD: /usr/bin/dnf update\n</code></pre>"},{"location":"linux/users/#autoriser-un-groupe-a-executer-une-commande-sans-mot-de-passe","title":"Autoriser un groupe \u00e0 ex\u00e9cuter une commande sans mot de passe","text":"<pre><code>%alice ALL=(ALL) NOPASSWD: /usr/bin/dnf install *\n</code></pre>"},{"location":"linux/users/#autoriser-une-commande-en-tant-quun-autre-utilisateur","title":"Autoriser une commande en tant qu'un autre utilisateur","text":"<pre><code>alice ALL=(bob) NOPASSWD: /home/bob/script.sh\n</code></pre>"},{"location":"linux/users/#verification-les-droits-sudoers","title":"Verification les droits sudoers","text":"<pre><code>su - alice\nsudo -l\n</code></pre>"},{"location":"monitoring/grafana/","title":"Grafana","text":""},{"location":"monitoring/grafana/#install-rhel","title":"Install RHEL","text":""},{"location":"monitoring/grafana/#repository","title":"Repository","text":"<pre><code>cat &lt;&lt;EOF | tee /etc/yum.repos.d/grafana.repo\n[grafana]\nname = Grafana Repository - RHEL \\$releasever\nbaseurl = https://packages.grafana.com/oss/rpm\nrepo_gpgcheck=1\nenabled = 1\ngpgcheck = 1\ngpgkey = https://packages.grafana.com/gpg.key\nsslverify=1\nsslcacert=/etc/pki/tls/certs/ca-bundle.crt\nEOF\n</code></pre>"},{"location":"monitoring/grafana/#package","title":"package","text":"<pre><code>dnf install grafana \nsystemctl enable --now grafana-server\nsystemctl status grafana-server\n</code></pre>"},{"location":"monitoring/grafana/#firewall","title":"Firewall","text":"<pre><code>firewall-cmd --add-port=3000/tcp --permanent\nfirewall-cmd --reload\nfirewall-cmd --list-ports\n</code></pre>"},{"location":"monitoring/grafana/#change-url","title":"Change url","text":""},{"location":"monitoring/grafana/#grafanaini","title":"grafana.ini","text":"<p><pre><code>vi /etc/grafana/grafana.ini\n</code></pre> <pre><code>...\ndomain = grafana.local.clinux.fr\n...\n</code></pre></p>"},{"location":"monitoring/grafana/#nginx","title":"nginx","text":"<pre><code>location / {\n    proxy_set_header Host grafana.local.clinux.fr;\n    proxy_set_header Origin https://grafana.local.clinux.fr;\n    proxy_pass http://localhost:3000;\n}\n</code></pre>"},{"location":"monitoring/icinga/","title":"Icinga","text":""},{"location":"monitoring/icinga/#install-server","title":"Install (server)","text":""},{"location":"monitoring/icinga/#rhel","title":"RHEL","text":""},{"location":"monitoring/icinga/#repository","title":"Repository","text":"<pre><code>dnf install epel-release\ncurl https://icinga.repo.clinux.fr/icinga2.repo -o /etc/yum.repos.d/icinga2-clinux.repo\n</code></pre>"},{"location":"monitoring/icinga/#packages","title":"Packages","text":"<pre><code>dnf install icinga2 icinga2-selinux icinga2-bin icingacli\ndnf install nagios-plugins-{load,http,users,procs,disk,swap,nrpe,uptime,dns,ssh,tcp,ping,mysql}\n</code></pre>"},{"location":"monitoring/icinga/#firewall","title":"Firewall","text":"<pre><code>firewall-cmd --list-all\nfirewall-cmd --permanent --add-port=5665/tcp\nfirewall-cmd --reload\nfirewall-cmd --list-all\n</code></pre>"},{"location":"monitoring/icinga/#debian","title":"Debian","text":""},{"location":"monitoring/icinga/#repository_1","title":"Repository","text":"<pre><code>apt -y install apt-transport-https wget gnupg\nwget -O - https://packages.icinga.com/icinga.key | gpg --dearmor -o /usr/share/keyrings/icinga-archive-keyring.gpg\nDIST=$(awk -F\"[)(]+\" '/VERSION=/ {print $2}' /etc/os-release); \\\necho \"deb [signed-by=/usr/share/keyrings/icinga-archive-keyring.gpg] https://packages.icinga.com/debian icinga-${DIST} main\" &gt; \\\n/etc/apt/sources.list.d/${DIST}-icinga.list\necho \"deb-src [signed-by=/usr/share/keyrings/icinga-archive-keyring.gpg] https://packages.icinga.com/debian icinga-${DIST} main\" &gt;&gt; \\\n/etc/apt/sources.list.d/${DIST}-icinga.list\n</code></pre>"},{"location":"monitoring/icinga/#packages_1","title":"Packages","text":"<pre><code>apt install icinga2\n</code></pre>"},{"location":"monitoring/icinga/#icingaweb2","title":"icingaweb2","text":""},{"location":"monitoring/icinga/#package-rhel","title":"package RHEL","text":"<pre><code>dnf install icingaweb2 icingaweb2-selinux mariadb mariadb-server mariadb-server-utils icinga2-ido-mysql httpd php-pecl-imagick\n</code></pre>"},{"location":"monitoring/icinga/#package-debian","title":"package Debian","text":"<pre><code>apt install mariadb-server \napt install icingaweb2 php8.2-imagick icinga2-ido-mysql\n</code></pre>"},{"location":"monitoring/icinga/#db","title":"db","text":"<pre><code>systemctl enable mariadb.service --now\nmariadb-secure-installation\nmariadb -u root -p\n    CREATE DATABASE icinga2;\n    CREATE DATABASE icingaweb2;\n    use mysql ;\n    GRANT ALL PRIVILEGES ON icinga2.* TO 'icinga2'@'localhost' IDENTIFIED BY 'icinga2';\n    GRANT ALL PRIVILEGES ON icingaweb2.* TO 'icingaweb2'@'localhost' IDENTIFIED BY 'icingaweb2';\n    FLUSH PRIVILEGES;\nmariadb icinga2 &lt; /usr/share/icinga2-ido-mysql/schema/mysql.sql\n</code></pre>"},{"location":"monitoring/icinga/#setup","title":"Setup","text":""},{"location":"monitoring/icinga/#db_1","title":"DB","text":"<pre><code>icinga2 feature enable ido-mysql syslog command\nvi /etc/icinga2/features-available/ido-mysql.conf\nsystemctl restart icinga2\n</code></pre>"},{"location":"monitoring/icinga/#webui","title":"Webui","text":"<pre><code>icingacli setup token create\nhttp://192.168.1.9/icingaweb2/setup\n</code></pre>"},{"location":"monitoring/icinga/#api","title":"Api","text":"<pre><code>icinga2 feature enable api\nicinga2 api setup\necho \"const TicketSalt = \\\"$(openssl rand -base64 30)\\\"\" &gt;&gt; /etc/icinga2/constants.conf\nservice icinga2 restart\nnetstat -tnlpv | grep 5665\nopenssl x509 -noout -text -in /var/lib/icinga2/certs/ca.crt\n</code></pre>"},{"location":"monitoring/icinga/#clients","title":"Clients","text":""},{"location":"monitoring/icinga/#agentsatellite-direct-acces-to-icinga-server","title":"Agent/Satellite (direct acces to icinga server)","text":""},{"location":"monitoring/icinga/#node","title":"Node","text":"<ul> <li>Agent/Satellite : Y</li> <li>CN : hostname</li> <li>Parent zone : master</li> <li>Connect : N</li> <li>Bind IP : default</li> <li>Bind Port : default</li> <li>Parent config : Y</li> <li>Parent command : Y</li> <li>Local Zone: default</li> <li>Parent Zone: default</li> <li>Additionnal zone : N</li> <li>Disable local conf : Y</li> </ul> <pre><code>icinga node wizard\n</code></pre> <pre><code>Welcome to the Icinga 2 Setup Wizard!\n\nWe will guide you through all required configuration details.\n\nPlease specify if this is an agent/satellite setup ('n' installs a master setup) [Y/n]: Y\n\nStarting the Agent/Satellite setup routine...\n\nPlease specify the common name (CN) [remote.server.com]:\n\nPlease specify the parent endpoint(s) (master or satellite) where this node should connect to:\nMaster/Satellite Common Name (CN from your master/satellite node): icinga.clinux.lan\n\nDo you want to establish a connection to the parent node from this node? [Y/n]: n\nConnection setup skipped. Please configure your parent node to\nconnect to this node by setting the 'host' attribute for the node Endpoint object.\n\nAdd more master/satellite endpoints? [y/N]: N\n\nNo connection to the parent node was specified.\n\nPlease copy the public CA certificate from your master/satellite\ninto '/var/lib/icinga2/certs//ca.crt' before starting Icinga 2.\nPlease specify the API bind host/port (optional):\nBind Host []:\nBind Port []:\n\nAccept config from parent node? [y/N]: Y\nAccept commands from parent node? [y/N]: Y\n\nReconfiguring Icinga...\nDisabling feature notification. Make sure to restart Icinga 2 for these changes to take effect.\nEnabling feature api. Make sure to restart Icinga 2 for these changes to take effect.\n\nLocal zone name [remote.server.com]:\nParent zone name [master]:\n\nDefault global zones: global-templates director-global\nDo you want to specify additional global zones? [y/N]: N\n\nDo you want to disable the inclusion of the conf.d directory [Y/n]: Y\nDisabling the inclusion of the conf.d directory...\n\nDone.\n\nNow restart your Icinga 2 daemon to finish the installation!\n</code></pre>"},{"location":"monitoring/icinga/#agentsatellite-no-acces-to-icinga-server","title":"Agent/Satellite (no acces to icinga server)","text":""},{"location":"monitoring/icinga/#on-node","title":"On node","text":"<pre><code>root@proxmox:~# icinga2 node wizard\nWelcome to the Icinga 2 Setup Wizard!\n\nWe will guide you through all required configuration details.\n\nPlease specify if this is an agent/satellite setup ('n' installs a master setup) [Y/n]:\n\nStarting the Agent/Satellite setup routine...\n\nPlease specify the common name (CN) [proxmox.clinux.lan]: proxmox.clinux.lan\n\nPlease specify the parent endpoint(s) (master or satellite) where this node should connect to:\nMaster/Satellite Common Name (CN from your master/satellite node): icinga.clinux.lan\n\nDo you want to establish a connection to the parent node from this node? [Y/n]: n\nConnection setup skipped. Please configure your parent node to\nconnect to this node by setting the 'host' attribute for the node Endpoint object.\n\nAdd more master/satellite endpoints? [y/N]:\n\nNo connection to the parent node was specified.\n\nPlease copy the public CA certificate from your master/satellite\ninto '/var/lib/icinga2/certs//ca.crt' before starting Icinga 2.\nPlease specify the API bind host/port (optional):\nBind Host []:\nBind Port []:\n\nAccept config from parent node? [y/N]: Y\nAccept commands from parent node? [y/N]: Y\n\nReconfiguring Icinga...\nDisabling feature notification. Make sure to restart Icinga 2 for these changes to take effect.\nEnabling feature api. Make sure to restart Icinga 2 for these changes to take effect.\n\nLocal zone name [proxmox.clinux.lan]:\nParent zone name [master]:\n\nDefault global zones: global-templates director-global\nDo you want to specify additional global zones? [y/N]:\n\nDo you want to disable the inclusion of the conf.d directory [Y/n]:\nDisabling the inclusion of the conf.d directory...\n\nDone.\n\nNow restart your Icinga 2 daemon to finish the installation!\n</code></pre>"},{"location":"monitoring/icinga/#on-server","title":"On server","text":"<pre><code>cd /var/lib/icinga2/certs\nicinga2 pki new-cert --cn proxmox.clinux.lan --key /var/lib/icinga2/certs/proxmox.clinux.lan.key --csr /var/lib/icinga2/certs/proxmox.clinux.lan.csr\nicinga2 pki sign-csr --cert /var/lib/icinga2/certs/proxmox.clinux.lan.crt --csr /var/lib/icinga2/certs/proxmox.clinux.lan.csr\nrm -fv /var/lib/icinga2/certs/proxmox.clinux.lan.csr\nscp {ca.crt,proxmox.clinux.lan*} root@proxmox.clinux.lan:/var/lib/icinga2/certs/\n</code></pre> <pre><code>object Endpoint \"proxmox.clinux.lan\" {\n   host = \"proxmox.clinux.lan\"\n}\n\nobject Zone \"proxmox.clinux.lan\" {\n     endpoints = [ \"proxmox.clinux.lan\" ]\n     parent = \"master\"\n}\n\nobject Host \"proxmox.clinux.lan\" {\n   import \"generic-host\"\n   address = \"proxmox.clinux.lan\"\n   vars.client_endpoint = name\n}\n</code></pre> <pre><code>systemctl restart icinga2.service\n</code></pre>"},{"location":"monitoring/icinga/#on-node-again","title":"On node (again)","text":"<pre><code>systemctl restart icinga2.service\n</code></pre>"},{"location":"monitoring/icinga/#agent-via-satellite-no-acces-to-icinga-server","title":"Agent via satellite (no acces to icinga server)","text":"<p><pre><code>[root@docker ~]# icinga2 node wizard\nWelcome to the Icinga 2 Setup Wizard!\n\nWe will guide you through all required configuration details.\n\nPlease specify if this is an agent/satellite setup ('n' installs a master setup) [Y/n]:\n\nStarting the Agent/Satellite setup routine...\n\nPlease specify the common name (CN) [agent.clinux.lan]:\n\nPlease specify the parent endpoint(s) (master or satellite) where this node should connect to:\nMaster/Satellite Common Name (CN from your master/satellite node): proxmox.clinux.lan\n\nDo you want to establish a connection to the parent node from this node? [Y/n]:\nPlease specify the master/satellite connection information:\nMaster/Satellite endpoint host (IP address or FQDN): 192.168.77.1\nMaster/Satellite endpoint port [5665]:\n\nAdd more master/satellite endpoints? [y/N]:\nParent certificate information:\n\n Version:             3\n Subject:             CN = proxmox.clinux.lan\n Issuer:              CN = Icinga CA\n Valid From:          Aug 13 07:00:34 2024 GMT\n Valid Until:         Sep 14 07:00:34 2025 GMT\n Serial:              10:39:45:87:8e:72:c6:89:d5:80:6b:23:38:1d:7d:ff:a8:f4:54:5e\n\n Signature Algorithm: sha256WithRSAEncryption\n Subject Alt Names:   proxmox.clinux.lan\n Fingerprint:         A5 2E E6 6F 65 5F 61 92 89 FE E3 F2 14 0D EE AD BA A7 D8 BA CD 74 D9 AA 7F 1C 01 6A C4 1A C4 46\n\nIs this information correct? [y/N]: Y\n\nPlease specify the request ticket generated on your Icinga 2 master (optional).\n (Hint: # icinga2 pki ticket --cn 'agent.clinux.lan'): 4caf71b792b2acdf23d238033b84cac190983290\nPlease specify the API bind host/port (optional):\nBind Host []:\nBind Port []:\n\nAccept config from parent node? [y/N]: Y\nAccept commands from parent node? [y/N]: Y\n\nReconfiguring Icinga...\n\nLocal zone name [agent.clinux.lan]:\nParent zone name [master]:\n\nDefault global zones: global-templates director-global\nDo you want to specify additional global zones? [y/N]:\n\nDo you want to disable the inclusion of the conf.d directory [Y/n]:\nDisabling the inclusion of the conf.d directory...\n\nDone.\n\nNow restart your Icinga 2 daemon to finish the installation!\n</code></pre> <pre><code>systemctl restart icinga2.service\n</code></pre></p>"},{"location":"monitoring/icinga/#windows-agent","title":"Windows agent","text":"<ul> <li>Windows Icinga2 agent</li> </ul>"},{"location":"monitoring/icinga/#allow-icmp","title":"Allow icmp","text":"<pre><code>netsh advfirewall firewall add rule name=\"ICMPv4 Allow Ping Requests\" protocol=icmpv4:8,any dir=in action=allow\n</code></pre>"},{"location":"monitoring/icinga/#check-powershell","title":"check powershell","text":"<pre><code> apply Service \"Powershell test\" {\n     command_endpoint = host.vars.client_endpoint\n     check_command = \"powershell_check\"\n     vars.ps_command = \"checkps_test.ps1\"\n     assign where host.vars.client_endpoint\n }\n\n\n object CheckCommand \"powershell_check\" {\n   import \"plugin-check-command\"\n   command = [ \"C:\\\\Windows\\\\system32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe\" ]\n   arguments = {\n     \"-command\" = {\n     value = \"&amp; 'C:\\\\Program Files\\\\ICINGA2\\\\sbin\\\\$ps_command$' $ps_arguments$\"\n     order = -1\n     }\n     \"-warn\" = {\n     value = \"$ps_warn$\"\n     }\n     \"-crit\" = {\n     value = \"$ps_crit$\"\n     }\n     \";exit\" = {\n     value = \"$$LastExitCode\"\n     }\n   }\n }\n</code></pre>"},{"location":"monitoring/icinga/#observability","title":"Observability","text":""},{"location":"monitoring/icinga/#master","title":"Master","text":"<pre><code>icinga2 feature enable influxdb2\n</code></pre>"},{"location":"monitoring/icinga/#influxdb2","title":"Influxdb2","text":"<ul> <li>Load Data &gt; create bucket : icinga2</li> <li>Load Data &gt; api token RW : -------------------</li> </ul>"},{"location":"monitoring/icinga/#master_1","title":"Master","text":"<p><pre><code>vi /etc/icinga2/features-enabled/influxdb2.conf\n</code></pre> <pre><code>/**\n * The Influxdb2Writer type writes check result metrics and\n * performance data to an InfluxDB v2 HTTP API\n */\n\nobject Influxdb2Writer \"influxdb2\" {\n  host = \"$INFLUXDB_HOST\"\n  port = 8086\n  organization = \"$ORGANISATION\"\n  bucket = \"$BUCKET_NAME\"\n  auth_token = \"$API_TOKEN_RW\"\n  flush_threshold = 1024\n  flush_interval = 10s\n  host_template = {\n    measurement = \"$host.check_command$\"\n    tags = {\n      hostname = \"$host.name$\"\n    }\n  }\n  service_template = {\n    measurement = \"$service.check_command$\"\n    tags = {\n      hostname = \"$host.name$\"\n      service = \"$service.name$\"\n    }\n  }\n}\n</code></pre></p> <pre><code>systemctl restart icinga2.service\n</code></pre>"},{"location":"monitoring/icinga/#grafana","title":"Grafana","text":""},{"location":"monitoring/icinga/#install","title":"Install","text":"<pre><code>wget -q -O /usr/share/keyrings/grafana.key https://packages.grafana.com/gpg.key\necho \"deb [signed-by=/usr/share/keyrings/grafana.key] https://packages.grafana.com/oss/deb stable main\" | tee -a /etc/apt/sources.list.d/grafana.list\napt update\napt install grafana\n\nsystemctl enable grafana-server --now\n</code></pre>"},{"location":"monitoring/icinga/#datasource","title":"datasource","text":"<ul> <li>Datasource &gt; new  : URL + Organization + Token + Bucket</li> </ul>"},{"location":"monitoring/icinga/#import","title":"Import","text":"<ul> <li>Import dashboard : https://grafana.com/grafana/dashboards/15361-icinga2-with-influxdb/</li> </ul>"},{"location":"monitoring/icinga/#create-visualization","title":"Create visualization","text":"<pre><code>from(bucket: \"icinga2\")\n  |&gt; range(start: v.timeRangeStart, stop:v.timeRangeStop)\n  |&gt; filter(fn: (r) =&gt;\n    r._measurement == \"ping4\" and\n    r._field == \"value\" and\n    r.hostname == \"${hostname}\"\n  )\n  |&gt; map(fn: (r) =&gt; ({ _value:r._value, _time:r._time, _field: r.metric }))\n</code></pre>"},{"location":"monitoring/icinga/#checks","title":"Checks","text":""},{"location":"monitoring/icinga/#plugin","title":"Plugin","text":"<pre><code>#!/bin/bash\necho \"New plugin\"\nexit 0 # OK\nexit 1 # WARNING\nexit 2 # CRITICAL\n</code></pre>"},{"location":"monitoring/icinga/#command","title":"Command","text":"<p><pre><code>cd /usr/lib/nagios/plugins\nwget https://raw.githubusercontent.com/justintime/nagios-plugins/master/check_mem/check_mem.pl\nchmod +x check_mem.pl\n</code></pre> <pre><code>object CheckCommand  \"check_memory\" {\n    import \"plugin-check-command\"\n    command = [PluginDir + \"/check_mem.pl\"]\n    arguments = {\n       \"-f\" = \"\"\n       \"-C\" = \"\"\n       \"-w\" = { value = \"$memory_wfree$\" }\n       \"-c\" = { value = \"$memory_cfree$\" }\n   }\n}\n</code></pre></p>"},{"location":"monitoring/icinga/#service","title":"Service","text":"<pre><code>apply Service \"memory\" {\n  import \"generic-service\"\n  check_command = \"check_memory\"\n\n  if(! host.vars.memory_wfree){\n    vars.memory_wfree = 20\n  }\n  if(! host.vars.memory_cfree){\n    vars.memory_cfree = 10\n  }  \n  assign where host.address\n}\n</code></pre>"},{"location":"monitoring/influxdb/","title":"Infludb","text":""},{"location":"monitoring/influxdb/#install","title":"Install","text":""},{"location":"monitoring/influxdb/#repository","title":"Repository","text":"<pre><code>cat &lt;&lt;EOF | tee /etc/yum.repos.d/influxdb.repo\n[influxdb]\nname = influxdb Repository - RHEL \\$releasever\nbaseurl = https://repos.influxdata.com/rhel/\\$releasever/\\$basearch/stable\nenabled = 1\ngpgcheck = 0\ngpgkey = https://repos.influxdata.com/influxdb.key\nEOF\n</code></pre>"},{"location":"monitoring/influxdb/#package","title":"package","text":"<pre><code>dnf install influxdb2 influxdb2-cli\nsystemctl enable --now influxdb\nsystemctl status influxdb\n</code></pre>"},{"location":"monitoring/influxdb/#firewall","title":"Firewall","text":"<pre><code>firewall-cmd --add-port=8086/tcp --permanent\nfirewall-cmd --reload\nfirewall-cmd --list-ports\n</code></pre>"},{"location":"monitoring/influxdb/#completion","title":"completion","text":"<pre><code>dnf install bash-completion\ninflux completion bash &gt; /etc/bash_completion.d/influx.sh\nchmod +x /etc/bash_completion.d/influx.sh\n</code></pre>"},{"location":"monitoring/influxdb/#access","title":"Access","text":"<pre><code>http://IP:8086\n</code></pre>"},{"location":"monitoring/victoriametrics/","title":"VictoriaMetrics","text":""},{"location":"monitoring/victoriametrics/#install","title":"Install","text":"<p>A faire</p>"},{"location":"monitoring/victoriametrics/#prometheus_pve_exporter","title":"prometheus_pve_exporter","text":""},{"location":"monitoring/victoriametrics/#token-proxmox","title":"Token proxmox","text":"<pre><code>pveum user add prometheus@pve\npveum aclmod / -user prometheus@pve -role PVEAuditor\npveum user token add prometheus@pve prometheus -expire 0 -privsep 0 -comment \"Prometheus token\"\n</code></pre>"},{"location":"monitoring/victoriametrics/#pve-config","title":"pve config","text":"<pre><code>root@proxmox2:~# cat /etc/prometheus/pve.yml \ndefault:\n    user: prometheus@pve\n    token_name: prometheus\n    token_value: 380c4277-c66f-45fa-9d3e-9deb7b787158 \n    verify_ssl: false\n</code></pre>"},{"location":"raspberrypi/grafana/","title":"InfluxDB","text":""},{"location":"raspberrypi/grafana/#install","title":"install","text":"<pre><code># curl https://repos.influxdata.com/influxdata-archive.key | gpg --dearmor | tee /usr/share/keyrings/influxdb-archive-keyring.gpg &gt;/dev/null\n# echo \"deb [signed-by=/usr/share/keyrings/influxdb-archive-keyring.gpg] https://repos.influxdata.com/debian stable main\" | tee /etc/apt/sources.list.d/influxdb.list\n\n# apt update\n# apt install influxdb2\n\n# systemctl unmask influxdb\n# systemctl enable influxdb\n</code></pre>"},{"location":"raspberrypi/grafana/#access","title":"access","text":"<pre><code>http://&lt;IPADDRESS&gt;:8086/\n</code></pre>"},{"location":"raspberrypi/grafana/#grafana","title":"Grafana","text":""},{"location":"raspberrypi/grafana/#install_1","title":"install","text":"<pre><code># mkdir -p /etc/apt/keyrings/\n# wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | tee /etc/apt/keyrings/grafana.gpg &gt; /dev/null\n# echo \"deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main\" | tee /etc/apt/sources.list.d/grafana.list\n\n# apt update\n# apt install -y grafana\n\n# systemctl enable grafana-server\n# systemctl start grafana-server\n</code></pre>"},{"location":"raspberrypi/grafana/#access_1","title":"access","text":"<pre><code>http://&lt;IPADDRESS&gt;:3000/\n</code></pre>"},{"location":"rocky/firewalld/","title":"firewalld","text":""},{"location":"rocky/firewalld/#list","title":"list","text":"<p>Lists the information about the 'public' zone in the firewall. <pre><code>firewall-cmd --info-zone public\n</code></pre></p>"},{"location":"rocky/firewalld/#apply","title":"apply","text":"<p>Reloads the firewall to apply any changes. <pre><code>firewall-cmd --reload\n</code></pre></p>"},{"location":"rocky/firewalld/#ipv4","title":"Ipv4","text":"<p>This section explains how to manage IPv4 firewall rules.</p>"},{"location":"rocky/firewalld/#add","title":"add","text":"<p>Adds a firewall rule to allow traffic on port 80 (HTTP) and port 53 (DNS) for IPv4. <pre><code>firewall-cmd --add-port=80/tcp --permanent\nfirewall-cmd --add-port=53/udp --permanent\n</code></pre></p>"},{"location":"rocky/firewalld/#pat","title":"PAT","text":"<p><pre><code>firewall-cmd --list-all\n</code></pre> <pre><code>firewall-cmd --add-forward-port=port=10022:proto=tcp:toport=10022:toaddr=192.168.1.20\n</code></pre></p>"},{"location":"rocky/firewalld/#ipv6","title":"Ipv6","text":"<p>This section explains how to manage IPv6 firewall rules.</p>"},{"location":"rocky/firewalld/#add_1","title":"add","text":"<p>Adds firewall rules to allow traffic on port 80 (HTTP) and port 443 (HTTPS) for IPv6. <pre><code>firewall-cmd --permanent --add-rich-rule='rule family=ipv6 port port=80 protocol=tcp accept'\nfirewall-cmd --permanent --add-rich-rule='rule family=ipv6 port port=443 protocol=tcp accept'\n</code></pre></p>"},{"location":"rocky/firewalld/#remove","title":"remove","text":"<p>Removes firewall rules that allow traffic on port 443 (HTTPS) for IPv6. <pre><code>firewall-cmd --permanent --remove-rich-rule='rule family=ipv6 protocol=tcp port=443'\nfirewall-cmd --permanent --remove-rich-rule='rule family=ipv6 protocol=tcp port=443'\n</code></pre></p>"},{"location":"rocky/firewalld/#direct-edit","title":"Direct edit","text":"<pre><code>vi /etc/firewalld/zones/public.xml\nservice firewalld reload\n</code></pre>"},{"location":"rocky/locales/","title":"locales","text":""},{"location":"rocky/locales/#install","title":"install","text":"<pre><code>dnf install langpacks-en langpacks-fr glibc-all-langpacks\n</code></pre>"},{"location":"rocky/locales/#setup","title":"setup","text":"<pre><code>localectl set-locale LANG=fr_FR.utf8\nreboot\n</code></pre>"},{"location":"rocky/locales/#datetime","title":"Datetime","text":"<pre><code>apt install systemd-timesyncd\ntimedatectl set-timezone Europe/Paris\nlocalectl set-locale LC_TIME=C\n</code></pre>"},{"location":"rocky/network/","title":"network","text":""},{"location":"rocky/network/#rocky-8","title":"Rocky 8","text":"<pre><code>/etc/sysconfig/network-scripts\n</code></pre>"},{"location":"rocky/network/#rocky-9","title":"Rocky 9","text":""},{"location":"rocky/network/#new-file-config","title":"New file config","text":"<p><pre><code>/etc/NetworkManager/system-connections/eth0.nmconnection\n</code></pre> <pre><code>[connection]\nid=ens18\nuuid=358954e1-16d4-3a46-bf9a-db058299179f\ntype=ethernet\nautoconnect-priority=-999\ninterface-name=ens18\ntimestamp=1723181730\n\n[ethernet]\n\n[ipv4]\naddress1=10.0.0.5/24,10.0.0.1\ndns=10.0.0.1;\nmethod=manual\n\n[ipv6]\naddr-gen-mode=eui64\nmethod=auto\n\n[proxy]\n</code></pre></p>"},{"location":"rocky/network/#disable-ipv6","title":"disable ipv6","text":"<p><pre><code>/etc/NetworkManager/system-connections/eth0.nmconnection\n</code></pre> <pre><code>[ipv6]\naddr-gen-mode=eui64\nmethod=disabled\n</code></pre></p>"},{"location":"rocky/network/#restart","title":"restart","text":"<pre><code>systemctl restart NetworkManager\n</code></pre>"},{"location":"rocky/xrdp/","title":"Xrdp","text":""},{"location":"rocky/xrdp/#install","title":"Install","text":"<pre><code>dnf install epel-release\ndnf install xrdp\nsystemctl enable xrdp --now\nfirewall-cmd --permanent --add-port=3389/tcp\nfirewall-cmd --reload\nreboot\n</code></pre>"},{"location":"security/gpg/","title":"gpg","text":""},{"location":"security/gpg/#remote","title":"remote","text":"<p>echo 'GPG_TTY=\"$(tty)\"' &gt;&gt; ~/.bashrc   echo 'export GPG_TTY' &gt;&gt; ~/.bashrc   source ~/.bashrc</p>"},{"location":"security/gpg/#agent","title":"agent","text":""},{"location":"security/gpg/#install","title":"Install","text":"<pre><code>dnf install pinentry-tty\n</code></pre>"},{"location":"security/gpg/#conf","title":"Conf","text":"<pre><code>vi ~/.gnupg/gpg-agent.conf\npinentry-program /usr/bin/pinentry-tty\n</code></pre>"},{"location":"security/gpg/#reload","title":"Reload","text":"<pre><code>gpgconf --kill gpg-agent\ngpgconf --launch gpg-agent\n</code></pre>"},{"location":"security/gpg/#check-key","title":"Check key","text":"<pre><code>gpg --list-keys\ngpg --list-secret-keys\n</code></pre>"},{"location":"security/gpg/#export","title":"Export","text":""},{"location":"security/gpg/#public","title":"Public","text":"<pre><code>gpg --output public.pgp --armor --export dev@clinux.fr\n</code></pre>"},{"location":"security/gpg/#private","title":"private","text":"<pre><code>gpg --output private.pgp --pinentry-mode loopback --export-secret-key dev@clinux.fr\n</code></pre>"},{"location":"security/gpg/#import","title":"Import","text":""},{"location":"security/gpg/#test","title":"test","text":"<pre><code>gpg --list-packets public.gpg\ngpg --list-packets private.gpg\n</code></pre>"},{"location":"security/gpg/#add","title":"add","text":"<pre><code>gpg --import public.gpg\ngpg --import private.gpg\n</code></pre>"},{"location":"security/gpg/#sign","title":"Sign","text":""},{"location":"security/gpg/#setup-identity","title":"Setup identity","text":""},{"location":"security/iptables/","title":"Iptables","text":""},{"location":"security/iptables/#install","title":"Install","text":"<pre><code>apt install iptables iptables-persistent\n</code></pre>"},{"location":"security/iptables/#list","title":"List","text":"<pre><code>alias iptlist='iptables -L -n -v --line-numbers'\nalias iptlistin='iptables -L INPUT -n -v --line-numbers'\nalias iptlistout='iptables -L OUTPUT -n -v --line-numbers'\nalias iptlistfw='iptables -L FORWARD -n -v --line-numbers'\nalias iptlistnat='iptables -t nat -v -L -n --line-number'\n</code></pre>"},{"location":"security/iptables/#save-restore","title":"Save / Restore","text":"<pre><code>alias iptrestore='iptables-restore &lt;  /etc/iptables/rules.v4'\nalias iptsave='iptables-save &gt; /usr/local/sbin/iptables &amp;&amp; iptables-save &gt; /etc/iptables/rules.v4'\n</code></pre>"},{"location":"security/iptables/#add","title":"Add","text":""},{"location":"security/iptables/#append","title":"Append","text":"<pre><code>iptables -A FORWARD -t filter -s 192.168.1.0/24 -j ACCEPT -o eth0\n</code></pre>"},{"location":"security/iptables/#insert-position-1","title":"Insert (position 1)","text":"<pre><code>iptables -I FORWARD 1 -m state -s 192.168.2.0/24 -d 192.168.77.0/24 --state NEW,RELATED,ESTABLISHED -j ACCEPT\n</code></pre>"},{"location":"security/iptables/#default-deny-warning-can-lock-if-nothing-configured","title":"Default deny (warning can lock if nothing configured)","text":"<pre><code>iptables -A INPUT -j DROP\n</code></pre>"},{"location":"security/iptables/#delete","title":"Delete","text":""},{"location":"security/iptables/#by-specification","title":"by specification","text":"<pre><code>iptables -S\niptables -D [specification]\n</code></pre>"},{"location":"security/iptables/#by-line-number","title":"by line number","text":"<pre><code>iptables -L --line-numbers\niptables -D INPUT 5\n</code></pre>"},{"location":"security/iptables/#by-line-number-for-nat","title":"by line number for nat","text":"<pre><code>iptables -t nat -D PREROUTING 5\n</code></pre>"},{"location":"security/iptables/#pat","title":"PAT","text":""},{"location":"security/iptables/#create","title":"Create","text":"<pre><code>iptables -t nat -A PREROUTING -p tcp --dport 27027 -j DNAT --to-destination 192.168.77.20:27017\niptables -t nat -A PREROUTING -p tcp -s XX.XX.XX.XX/32 --dport 27027 -j DNAT --to-destination 192.168.77.20:27017 -m comment --comment \"Mongo DB direct access\"\n</code></pre>"},{"location":"security/iptables/#delete_1","title":"Delete","text":"<pre><code>iptables -t nat -D PREROUTING {rule-number-here}\n</code></pre>"},{"location":"security/iptables/#reset","title":"Reset","text":"<pre><code>iptables -P INPUT ACCEPT\niptables -P FORWARD ACCEPT\niptables -P OUTPUT ACCEPT\niptables -t mangle -F\niptables -t nat -F\niptables -X\niptables -F\n</code></pre>"},{"location":"security/nmap/","title":"Nmap","text":""},{"location":"security/nmap/#quick-scan","title":"Quick scan","text":"<pre><code>nmap -sn 192.168.1.0/24 -oG quick_scan &gt;/dev/null\ncat quick_scan\n</code></pre>"},{"location":"security/openssl/","title":"OpenSSL","text":""},{"location":"security/openssl/#read-certificate","title":"Read certificate","text":"<pre><code>openssl x509 -text -noout -in certificate.crt\n</code></pre>"},{"location":"security/ssh/","title":"ssh daemon","text":""},{"location":"security/ssh/#pki","title":"PKI","text":""},{"location":"security/ssh/#generate","title":"generate","text":"<pre><code>ssh-keygen -t ed25519\n</code></pre>"},{"location":"security/ssh/#list","title":"list","text":"<pre><code>ls -l ~/.ssh/\ntotal 40\n-rw-------. 1 clinux clinux   508 Dec 13 14:21 authorized_keys      # list of authorized public keys\n-rw-r--r--. 1 clinux clinux    49 May 16 13:58 config               # configuration (ex ssh jump)\n-rw-------. 1 clinux clinux   411 Oct 20  2023 id_ed25519           # Keep this private \n-rw-r--r--. 1 clinux clinux   101 Oct 20  2023 id_ed25519.pub       # used to authenticate\n</code></pre>"},{"location":"security/wireguard/","title":"Wireguard","text":""},{"location":"security/wireguard/#server","title":"Server","text":""},{"location":"security/wireguard/#activate","title":"Activate","text":"<pre><code>modprobe wireguard\nlsmod | grep wireguard\necho wireguard &gt; /etc/modules-load.d/wireguard.conf\ndnf install wireguard-tools\n</code></pre>"},{"location":"security/wireguard/#generate-server-keys","title":"Generate server keys","text":""},{"location":"security/wireguard/#private","title":"Private","text":"<pre><code>wg genkey | tee /etc/wireguard/server.key\nchmod 0400 /etc/wireguard/server.key\n</code></pre>"},{"location":"security/wireguard/#public","title":"Public","text":"<pre><code>cat /etc/wireguard/server.key | wg pubkey | tee /etc/wireguard/server.pub\n</code></pre>"},{"location":"security/wireguard/#configuration","title":"Configuration","text":""},{"location":"security/wireguard/#forward","title":"Forward","text":"<p><pre><code>vi /etc/sysctl.conf\n</code></pre> <pre><code>net.ipv4.ip_forward=1\n</code></pre> <pre><code>sysctl -p\n</code></pre></p>"},{"location":"security/wireguard/#firewall","title":"Firewall","text":"<pre><code>firewall-cmd --add-port=51820/udp --permanent\nfirewall-cmd --reload\nfirewall-cmd --list-all\n</code></pre>"},{"location":"security/wireguard/#file","title":"file","text":"<p><pre><code>vi /etc/wireguard/wg0.conf\n</code></pre> <pre><code>[Interface]\nListenPort = 51820\nPrivateKey = oK9PmGXtFsbmxYXE4WWjZfzktLusNGhid003YGxfuF0=\nAddress = 10.200.0.1/24\nSaveConfig = true\nPostUp = firewall-cmd --zone=public --add-masquerade\nPostUp = firewall-cmd --direct --add-rule ipv4 filter FORWARD 0 -i wg -o eth0 -j ACCEPT\nPostUp = firewall-cmd --direct --add-rule ipv4 nat POSTROUTING 0 -o eth0 -j MASQUERADE\nPostDown = firewall-cmd --zone=public --remove-masquerade\nPostDown = firewall-cmd --direct --remove-rule ipv4 filter FORWARD 0 -i wg -o eth0 -j ACCEPT\nPostDown = firewall-cmd --direct --remove-rule ipv4 nat POSTROUTING 0 -o eth0 -j MASQUERADE\n</code></pre></p>"},{"location":"security/wireguard/#service","title":"service","text":"<pre><code>systemctl start wg-quick@wg0.service\nsystemctl enable wg-quick@wg0.service\n\nwg-quick up /etc/wireguard/wg0.conf\nwg-quick down /etc/wireguard/wg0.conf\n</code></pre>"},{"location":"security/wireguard/#client","title":"Client","text":""},{"location":"security/wireguard/#standard","title":"Standard","text":"<pre><code>modprobe wireguard\nlsmod | grep wireguard\necho wireguard &gt; /etc/modules-load.d/wireguard.conf\ndnf install wireguard-tools\n\nwg genkey | tee /etc/wireguard/client1.key\nchmod 0400 /etc/wireguard/client1.key\ncat /etc/wireguard/client1.key | wg pubkey | tee /etc/wireguard/client1.pub\n</code></pre>"},{"location":"security/wireguard/#open-network-behind","title":"Open network behind","text":"<p><pre><code>vi /etc/wireguard/wg0.conf\n</code></pre> <pre><code>[Interface]\nPrivateKey = &lt; Private client key &gt;\nAddress = 10.200.0.2/24\nListenPort = 51820\nPersistentKeepalive = 25\n\n\nPreUp = sysctl -w net.ipv4.ip_forward=1\nPreUp = iptables -t mangle -A PREROUTING -i wg0 -j MARK --set-mark 0x30\nPreUp = iptables -t nat -A POSTROUTING ! -o wg0 -m mark --mark 0x30 -j MASQUERADE\nPostDown = iptables -t mangle -D PREROUTING -i wg0 -j MARK --set-mark 0x30\nPostDown = iptables -t nat -D POSTROUTING ! -o wg0 -m mark --mark 0x30 -j MASQUERADE\n\n\n[Peer]\nPublicKey = &lt; Public server key &gt;\nAllowedIPs = 10.177.0.0/24\nEndpoint = &lt;IP SERVER&gt;:51820\n</code></pre></p>"},{"location":"security/wireguard/#road-warrior","title":"Road warrior","text":"<pre><code>[Interface]\nPrivateKey = &lt; Private client key &gt;\nAddress = 10.200.0.100/24\nDNS = 10.200.0.13\n\n[Peer]\nPublicKey = &lt; Public server key &gt;\nAllowedIPs = 10.200.0.0/24, 10.0.0.0/24\nEndpoint = &lt;IP SERVER&gt;:51820\n</code></pre>"},{"location":"security/wireguard/#usage","title":"Usage","text":""},{"location":"security/wireguard/#show-config","title":"show config","text":"<pre><code>wg\n</code></pre>"},{"location":"security/wireguard/#add-peer","title":"Add peer","text":"<pre><code>wg set wg0 peer &lt; Public client key &gt; allowed-ips 10.200.0.0/24,192.168.1.0/24\n</code></pre>"},{"location":"security/wireguard/#remove-peer","title":"Remove peer","text":"<pre><code>wg set wg0 peer &lt; Public client key &gt;  remove\n</code></pre>"},{"location":"security/wireguard/#tricks","title":"Tricks","text":""},{"location":"security/wireguard/#peer-name","title":"Peer name","text":"<p><pre><code>vi /etc/wireguard/wg_sub\n</code></pre> <pre><code>s|&lt;Public key&gt;|hostname|g\ns|&lt;Public key&gt;|Road warrior 1|g\n</code></pre> <pre><code>echo \"alias wge='wg | sed -f /etc/wireguard/wg_sub'\" &gt;&gt; ~/.bashrc &amp;&amp; source ~/.bashrc\n</code></pre></p>"},{"location":"security/tls/lego/","title":"Lego","text":""},{"location":"security/tls/lego/#lego","title":"Lego\ud83c\udf10","text":"<p>Cette sous-section explique comment utiliser Lego pour la g\u00e9n\u00e9ration et la gestion de certificats avec diff\u00e9rents fournisseurs DNS.</p>"},{"location":"security/tls/lego/#install","title":"install\ud83d\udce6","text":"<p>Installe Lego en t\u00e9l\u00e9chargeant la version la plus r\u00e9cente, l'extraittez et ex\u00e9cutez-le. <pre><code>wget https://github.com/go-acme/lego/releases/download/v4.16.1/lego_v4.16.1_linux_amd64.tar.gz\ntar xvzf lego_v4.16.1_linux_amd64.tar.gz\n./lego\n</code></pre></p>"},{"location":"security/tls/lego/#providers","title":"providers\ud83d\udcd6","text":"<p>Fournit un lien vers la documentation pour configurer les fournisseurs DNS avec Lego. <pre><code>https://go-acme.github.io/lego/dns/\n</code></pre></p>"},{"location":"security/tls/lego/#ovh","title":"OVH \ud83d\udda5\ufe0f","text":"<p>Montre comment configurer et utiliser Lego avec le fournisseur DNS OVH. <pre><code>export OVH_APPLICATION_KEY=xxxxxxxxxxx\nexport OVH_APPLICATION_SECRET=xxxxxxxxxxxxxxxxxxxxxxx \nexport OVH_CONSUMER_KEY=xxxxxxxxxxxxxx\nexport OVH_ENDPOINT=ovh-eu\n\n./lego --email dev@clinux.fr --dns ovh --domains vhost.email.dom run\nls -l .lego/certificates/vhost.email.dom.{crt,key}\n./lego --email dev@clinux.fr --dns ovh --domains *.email.dom run\nls -l .lego/certificates/_.email.dom.{crt,key}\n</code></pre></p>"},{"location":"security/tls/lego/#ionos","title":"Ionos \ud83d\udda5\ufe0f","text":"<p>Montre comment configurer et utiliser Lego avec le fournisseur DNS Ionos. <pre><code>IONOS_API_KEY=xxxxxxxxxxxxxxxxxxxxxxx\n./lego --email dev@clinux.fr --dns ionos --domains vhost.email.dom run\n</code></pre></p>"},{"location":"security/tls/letsencrypt/","title":"Let's encrypt","text":""},{"location":"security/tls/letsencrypt/#installation","title":"Installation \ud83d\ude80","text":"<p>Installation standard via le manager de paquet dnf.</p> <pre><code>dnf install epel-release\ndnf install certbot\n</code></pre>"},{"location":"security/tls/letsencrypt/#certbot","title":"Certbot \ud83d\udd12","text":""},{"location":"security/tls/letsencrypt/#gestion-du-compte","title":"Gestion du compte","text":""},{"location":"security/tls/letsencrypt/#verifier-letat","title":"Verifier l'etat","text":"<pre><code>certbot show_account\n</code></pre>"},{"location":"security/tls/letsencrypt/#enregistrer-un-compte","title":"Enregistrer un compte","text":"<pre><code>certbot register --agree-tos -m dev@clinux.fr\n</code></pre>"},{"location":"security/tls/letsencrypt/#supprimer-un-compte","title":"Supprimer un compte","text":"<pre><code>certbot unregister\n</code></pre>"},{"location":"security/tls/letsencrypt/#gestion-des-certificats","title":"Gestion des certificats","text":""},{"location":"security/tls/letsencrypt/#lister-les-certificats","title":"Lister les certificats \ud83d\udcda","text":"<p>Liste tous les certificats SSL g\u00e9r\u00e9s par Certbot.</p> <pre><code>certbot certificates \n</code></pre>"},{"location":"security/tls/letsencrypt/#ne-pas-se-faire-bannir","title":"Ne pas se faire bannir","text":"<p>Il faut ajouter l'option <code>--dry-run</code> aux commandes de cr\u00e9ation des certificats pour tester la configuration.</p>"},{"location":"security/tls/letsencrypt/#creer-un-certificat-manuellement-challenge-http-port-80-ouvert","title":"Cr\u00e9er un certificat manuellement \ud83d\udd11 (challenge http port 80 ouvert)","text":"<pre><code>certbot certonly --email dev@clinux.fr --webroot -w /var/lib/letsencrypt/ -d lab.online.clinux.fr --dry-run\n</code></pre>"},{"location":"security/tls/letsencrypt/#creer-un-certificat-avec-un-plugin-challenge-http-port-80-ouvert","title":"Cr\u00e9er un certificat avec un plugin \ud83d\udd11 (challenge http port 80 ouvert)","text":"<pre><code>dnf install -y certbot python3-certbot-nginx\ncertbot\n</code></pre>"},{"location":"security/tls/letsencrypt/#creer-un-certificat-wildcard-challenge-dns","title":"Cr\u00e9er un certificat wildcard \ud83d\udd11 (challenge dns)","text":"<pre><code>certbot certonly --manual --preferred-challenges dns -d lab.online.clinux.fr\n</code></pre>"},{"location":"security/tls/letsencrypt/#renouveler","title":"Renouveler \ud83d\udd04","text":"<p>Renouvelle tous les certificats SSL g\u00e9r\u00e9s par Certbot. <pre><code>certbot renew\n</code></pre></p>"},{"location":"security/tls/letsencrypt/#revoquer","title":"R\u00e9voquer \ud83e\udde8","text":"<p>Revoquer un certificat <pre><code>certbot revoke --cert-name lab.online.clinux.fr\n</code></pre></p>"},{"location":"security/tls/letsencrypt/#supprimer","title":"Supprimer \ud83d\udeab","text":"<p>Supprime un certificat SSL sp\u00e9cifique avec Certbot. <pre><code>certbot delete --cert-name lab.online.clinux.fr\n</code></pre></p>"},{"location":"security/tls/mkcert/","title":"Mkcert \ud83d\udd10","text":"<p>Mkcert sert \u00e0 g\u00e9n\u00e9rer facilement des certificats TLS locaux fiables par ton syst\u00e8me sans te battre avec OpenSSL comme un sanglier sous anxiolytiques \ud83d\ude24\ud83d\udc17</p>"},{"location":"security/tls/mkcert/#installation","title":"Installation \ud83e\uddf1","text":"<p>On installe les d\u00e9pendances n\u00e9cessaires : - <code>curl</code> pour interroger l\u2019API GitHub \ud83c\udf10 - <code>nss-tools</code> pour enregistrer l\u2019autorit\u00e9 de certification dans le store syst\u00e8me \ud83d\udddd\ufe0f - <code>wget</code> pour r\u00e9cup\u00e9rer le binaire \ud83d\udce6</p> <pre><code>dnf install -y curl nss-tools wget\n</code></pre> <p>T\u00e9l\u00e9chargement de la derni\u00e8re version officielle de mkcert pour Linux amd64 :</p> <pre><code>curl -s https://api.github.com/repos/FiloSottile/mkcert/releases/latest \\\n  | grep browser_download_url \\\n  | grep 'linux-amd64' \\\n  | cut -d '\"' -f 4 \\\n  | wget -i -\n</code></pre> <p>Installation du binaire dans le PATH syst\u00e8me \ud83d\udd12</p> <pre><code>mkdir ~/.local/bin\nmv mkcert-v*-linux-amd64 ~/.local/bin/mkcert\nchmod 755 ~/.local/bin/mkcert\n</code></pre>"},{"location":"security/tls/mkcert/#initialisation","title":"Initialisation \ud83c\udfd7\ufe0f","text":"<p>Cr\u00e9ation et installation de l\u2019autorit\u00e9 de certification locale dans le syst\u00e8me et les navigateurs compatibles \ud83c\udf0d</p> <pre><code>mkcert -install\n</code></pre> <p>V\u00e9rification de la pr\u00e9sence de la CA racine :</p> <pre><code>ls -l ~/.local/share/mkcert/rootCA.pem\n</code></pre>"},{"location":"security/tls/mkcert/#generation-de-certificats","title":"G\u00e9n\u00e9ration de certificats \ud83d\udd29","text":"<p>Les certificats g\u00e9n\u00e9r\u00e9s sont strictement r\u00e9serv\u00e9s au local \ud83d\udeab</p>"},{"location":"security/tls/mkcert/#sous-domaine","title":"Sous-domaine \ud83c\udf10","text":"<pre><code>mkcert web.lab.clinux.fr\n</code></pre> <p>G\u00e9n\u00e8re : - <code>web.lab.clinux.fr.pem</code> - <code>web.lab.clinux.fr-key.pem</code></p>"},{"location":"security/tls/mkcert/#adresse-ip","title":"Adresse IP \ud83e\uddee","text":"<pre><code>mkcert 192.168.1.211 127.0.0.1 ::1\n</code></pre> <p>Un seul certificat valable pour toutes les IPs list\u00e9es.</p>"},{"location":"security/tls/mkcert/#wildcard-multiples-sous-domaines","title":"Wildcard (multiples sous-domaines) \ud83c\udf33","text":"<pre><code>mkcert \"*.lab.clinux.fr\"\n</code></pre> <p>\u26a0\ufe0f Ne couvre pas le domaine racine.</p> <p>Solution compl\u00e8te :</p> <pre><code>mkcert \"lab.clinux.fr\" \"*.lab.clinux.fr\"\n</code></pre>"},{"location":"security/tls/mkcert/#transfert-le-lautorite-de-certification","title":"Transfert le l'autorit\u00e9 de certification","text":"<p>On recup\u00e8re le fichier <code>rootCA.pem</code> et on le transf\u00e8re sur le poste, puis on l'injecte dans les autorit\u00e9s locales.</p> <pre><code>sudo cp rootCA.pem /etc/pki/ca-trust/source/anchors/\nupdate-ca-trust\n</code></pre>"},{"location":"security/tls/mkcert/#bonnes-pratiques","title":"Bonnes pratiques \ud83e\udde0","text":"<ul> <li>\u274c Jamais en production</li> <li>\ud83d\udd11 Ne jamais versionner les cl\u00e9s priv\u00e9es</li> <li>\ud83d\udd04 Red\u00e9marrer le navigateur si besoin</li> <li>\u2705 Compatible Firefox, Chrome, Chromium, NSS, OpenSSL</li> </ul>"},{"location":"security/tls/stepca/","title":"Step CA","text":""},{"location":"security/tls/stepca/#install","title":"Install","text":""},{"location":"security/tls/stepca/#debian","title":"Debian","text":"<pre><code>wget https://dl.smallstep.com/certificates/docs-ca-install/latest/step-ca_amd64.deb\ndpkg -i step-ca_amd64.deb\n</code></pre>"},{"location":"security/tls/stepca/#rhel","title":"RHEL","text":"<pre><code>wget https://dl.smallstep.com/certificates/docs-ca-install/latest/step-ca_amd64.rpm\nsudo rpm -i step-ca_amd64.rpm\n</code></pre>"},{"location":"security/tls/stepca/#authority","title":"Authority","text":""},{"location":"security/tls/stepca/#generate","title":"Generate","text":""},{"location":"security/tls/stepca/#service","title":"Service","text":"<p><pre><code>vi /etc/systemd/system/step-ca.service\n</code></pre> <pre><code>[Unit]\nDescription=step-ca service\nDocumentation=https://smallstep.com/docs/step-ca\nDocumentation=https://smallstep.com/docs/step-ca/certificate-authority-server-production\nAfter=network-online.target\nWants=network-online.target\nStartLimitIntervalSec=30\nStartLimitBurst=3\nConditionFileNotEmpty=/etc/step-ca/config/ca.json\nConditionFileNotEmpty=/etc/step-ca/password.txt\n\n[Service]\nType=simple\nUser=secu\nGroup=secu\nEnvironment=STEPPATH=/etc/step-ca\nWorkingDirectory=/etc/step-ca\nExecStart=/usr/bin/step-ca config/ca.json --password-file password.txt\nExecReload=/bin/kill --signal HUP $MAINPID\nRestart=on-failure\nRestartSec=5\nTimeoutStopSec=30\nStartLimitInterval=30\nStartLimitBurst=3\n\n; Process capabilities &amp; privileges\nAmbientCapabilities=CAP_NET_BIND_SERVICE\nCapabilityBoundingSet=CAP_NET_BIND_SERVICE\nSecureBits=keep-caps\nNoNewPrivileges=yes\n\n; Sandboxing\nProtectSystem=full\nProtectHome=true\nRestrictNamespaces=true\nRestrictAddressFamilies=AF_UNIX AF_INET AF_INET6\nPrivateTmp=true\nPrivateDevices=true\nProtectClock=true\nProtectControlGroups=true\nProtectKernelTunables=true\nProtectKernelLogs=true\nProtectKernelModules=true\nLockPersonality=true\nRestrictSUIDSGID=true\nRemoveIPC=true\nRestrictRealtime=true\nSystemCallFilter=@system-service\nSystemCallArchitectures=native\nMemoryDenyWriteExecute=true\nReadWriteDirectories=/etc/step-ca/db\n\n[Install]\nWantedBy=multi-user.target\n</code></pre></p>"},{"location":"security/tls/stepca/#client","title":"Client","text":""},{"location":"security/tls/stepca/#install_1","title":"Install","text":""},{"location":"security/tls/stepca/#debian_1","title":"Debian","text":"<pre><code>wget https://dl.smallstep.com/cli/docs-ca-install/latest/step-cli_amd64.deb\ndpkg -i step-cli_amd64.deb\n</code></pre>"},{"location":"security/tls/stepca/#rhel_1","title":"RHEL","text":"<pre><code>wget https://dl.smallstep.com/cli/docs-ca-install/latest/step-cli_amd64.rpm\nsudo rpm -i step-cli_amd64.rpm\n</code></pre>"},{"location":"security/tls/stepca/#link-to-ca","title":"Link to CA","text":""},{"location":"security/tls/stepca/#get-fingerprint-on-server","title":"Get fingerprint (on server)","text":"<pre><code>step certificate fingerprint certs/root_ca.crt\ncacc656a33ca59685026551ba00734b19fd695d966a2c7f9b464ee073ec359172\n</code></pre>"},{"location":"security/tls/stepca/#link-client","title":"Link client","text":"<pre><code>step ca bootstrap --ca-url https://your.ca.server:4443 --fingerprint cacc656a33ca59685026551ba00734b19fd695d966a2c7f9b464ee073ec359172\n</code></pre>"},{"location":"security/tls/stepca/#generate-certificat","title":"Generate certificat","text":"<pre><code>step ca certificate test.clinux.lan test.clinux.lan.crt test.clinux.lan.key\nstep ca certificate test.clinux.lan test.clinux.lan.crt test.clinux.lan.key --provisioner-password-file=PASSWORD_FILE -f --not-after=10h\n</code></pre>"},{"location":"security/tls/stepca/#test-certificats","title":"Test certificats","text":"<pre><code>step certificate inspect test.clinux.lan \nstep certificate inspect test.clinux.lan --short\n</code></pre>"},{"location":"services/minio/","title":"Minio","text":""},{"location":"services/minio/#installation","title":"Installation","text":""},{"location":"services/minio/#binaires","title":"Binaires","text":""},{"location":"services/minio/#serveur","title":"serveur","text":"<pre><code>wget https://dl.min.io/server/minio/release/linux-amd64/minio.RELEASE.2025-04-22T22-12-26Z\nchmod +x minio.RELEASE.2025-04-22T22-12-26Z\nmv minio.RELEASE.2025-04-22T22-12-26Z /usr/local/bin/minio\n</code></pre>"},{"location":"services/minio/#client","title":"Client","text":"<pre><code>wget https://dl.min.io/client/mc/release/linux-amd64/mc.RELEASE.2025-04-16T18-13-26Z\nchmod +x mc.RELEASE.2025-04-16T18-13-26Z\nmv mc.RELEASE.2025-04-16T18-13-26Z/usr/local/bin/mc\n</code></pre>"},{"location":"services/minio/#configuration-serveur","title":"Configuration serveur","text":""},{"location":"services/minio/#creation-du-user","title":"Cr\u00e9ation du user","text":"<pre><code>groupadd -r minio-user\nuseradd -M -r -g minio-user minio-user\nchown minio-user:minio-user /mnt/data\n</code></pre>"},{"location":"services/minio/#creation-du-disque-warning-il-faut-que-le-disque-soit-formate-en-xfs","title":"Cr\u00e9ation du disque (:warning: Il faut que le disque soit format\u00e9 en xfs)","text":"<pre><code>mkdir /mnt/minio_data\nmount /dev/sdb1 /mnt/minio_data\nchown minio-user:minio-user /mnt/minio_data\n</code></pre>"},{"location":"services/minio/#creation-du-service","title":"Cr\u00e9ation du service","text":"<p><pre><code>sudo vi/etc/systemd/system/minio.service\n</code></pre> <pre><code>[Unit]\nDescription=MinIO\nDocumentation=https://min.io/docs/minio/linux/index.html\nWants=network-online.target\nAfter=network-online.target\nAssertFileIsExecutable=/usr/local/bin/minio\n\n[Service]\nWorkingDirectory=/usr/local\n\nUser=minio-user\nGroup=minio-user\nProtectProc=invisible\n\nEnvironmentFile=-/etc/default/minio\nExecStartPre=/bin/bash -c \"if [ -z \\\"${MINIO_VOLUMES}\\\" ]; then echo \\\"Variable MINIO_VOLUMES not set in /etc/default/minio\\\"; exit 1; fi\"\nExecStart=/usr/local/bin/minio server $MINIO_OPTS $MINIO_VOLUMES\n\n# MinIO RELEASE.2023-05-04T21-44-30Z adds support for Type=notify (https://www.freedesktop.org/software/systemd/man/systemd.service.html#Type=)\n# This may improve systemctl setups where other services use `After=minio.server`\n# Uncomment the line to enable the functionality\n# Type=notify\n\n# Let systemd restart this service always\nRestart=always\n\n# Specifies the maximum file descriptor number that can be opened by this process\nLimitNOFILE=65536\n\n# Specifies the maximum number of threads this process can create\nTasksMax=infinity\n\n# Disable timeout logic and wait until process is stopped\nTimeoutStopSec=infinity\nSendSIGKILL=no\n\n[Install]\nWantedBy=multi-user.target\n</code></pre></p>"},{"location":"services/minio/#parametrage-par-defaut-contient-les-identifiants-pour-se-connecter-a-la-console","title":"Parametrage par d\u00e9faut (contient les identifiants pour se connecter \u00e0 la console)","text":"<p><pre><code>vi /etc/default/minio\n</code></pre> <pre><code># MINIO_ROOT_USER and MINIO_ROOT_PASSWORD sets the root account for the MinIO server.\n# This user has unrestricted permissions to perform S3 and administrative API operations on any resource in the deployment.\n# Omit to use the default values 'minioadmin:minioadmin'.\n# MinIO recommends setting non-default values as a best practice, regardless of environment\n\nMINIO_ROOT_USER=admin\nMINIO_ROOT_PASSWORD=minio_password\n\n# MINIO_VOLUMES sets the storage volume or path to use for the MinIO server.\n\nMINIO_VOLUMES=\"/mnt/minio_data\"\n\n# MINIO_OPTS sets any additional commandline options to pass to the MinIO server.\n# For example, `--console-address :9001` sets the MinIO Console listen port\nMINIO_OPTS=\"--console-address :9001\"\n</code></pre></p>"},{"location":"services/minio/#ouverture-des-ports","title":"Ouverture des ports","text":"<pre><code>firewall-cmd --add-port=9000/tcp --permanent &amp;&amp; firewall-cmd --reload\nfirewall-cmd --add-port=9001/tcp --permanent &amp;&amp; firewall-cmd --reload\n</code></pre>"},{"location":"services/minio/#lancement","title":"Lancement","text":""},{"location":"services/minio/#service","title":"service","text":"<pre><code>systemctl daemon-reload\nsystemctl enable minio --now\n</code></pre>"},{"location":"services/minio/#verification-du-service","title":"V\u00e9rification du service","text":"<pre><code>netstat -tnlpv | grep 900\njournalctl -u minio.service -f \n</code></pre>"},{"location":"services/minio/#acces-a-la-console-dadministration","title":"Acc\u00e8s \u00e0 la console d'administration","text":"<p>http://:9001/login"},{"location":"services/minio/#client_1","title":"Client","text":""},{"location":"services/minio/#creation-des-cles-dacces-dans-la-console","title":"Cr\u00e9ation des cl\u00e9s d'acc\u00e8s dans la console","text":"<p>http://:9001/access-keys"},{"location":"services/minio/#configuration-du-client-minio","title":"Configuration du client Minio","text":"<p><pre><code>  mc alias set MonMinio http://&lt;IP_MINIO&gt;:9000 ACCESS_KEY SECRET_KEY\n</code></pre> Cela g\u00e9n\u00e8re un fichier .mc/config.json dans le r\u00e9pertoire courant du user</p>"},{"location":"services/minio/#statisques-de-linstance","title":"Statisques de l'instance","text":"<pre><code>mc admin info MonMinio\n</code></pre>"},{"location":"services/minio/#creation-dun-bucket","title":"Cr\u00e9ation d'un bucket","text":"<pre><code>mc mb MonMinio/monbucket\n</code></pre>"},{"location":"services/minio/#creation-dun-utilisateur","title":"Cr\u00e9ation d'un utilisateur","text":"<pre><code>mc admin user add MonMinio utilisateur1 password1\n</code></pre>"},{"location":"services/minio/#lister-les-utilisateurs","title":"Lister les utilisateurs","text":"<pre><code>mc admin user list MonMinio\n</code></pre>"},{"location":"services/minio/#creation-de-jetons-dacces","title":"Cr\u00e9ation de jetons d'acc\u00e8s","text":"<p><pre><code>mc admin accesskey create MonMinio utilisateur1 --name utilisateur1 | tee token-utilisateur1.json\n</code></pre> <pre><code>Access Key: GYASUUVIN21RVJ2Y0PLW\nSecret Key: n169RKRIKJM8CTcyvAYwkO7z9OooJcBCWWWGBXh+\nExpiration: NONE\nName: utilisateur1\nDescription: \n</code></pre></p>"},{"location":"services/minio/#creation-dun-groupe","title":"Cr\u00e9ation d'un groupe","text":"<pre><code>mc admin group add MonMinio monGroupe1 utilisateur1\n</code></pre>"},{"location":"services/minio/#lister-les-groupes","title":"Lister les groupes","text":"<pre><code>mc admin group list MonMinio\nmc admin group info MonMinio monGroupe1\n</code></pre>"},{"location":"services/minio/#creation-dune-polique","title":"Cr\u00e9ation d'une polique","text":"<p><pre><code>{\n  \"Version\": \"2012-10-17\",\n  \"Statement\": [\n    {\n      \"Sid\": \"MaPolitique1\",\n      \"Effect\": \"Allow\",\n      \"Action\": [\n        \"s3:GetObject\",\n        \"s3:PutObject\",\n        \"s3:DeleteObject\",\n        \"s3:ListBucket\"\n      ],\n      \"Resource\": [\n        \"arn:aws:s3:::monbucket/*\"\n      ]\n    }\n  ]\n}\n</code></pre> <pre><code>mc admin policy create MonMinio MaPolitique1 politique1.json  \n</code></pre></p>"},{"location":"services/minio/#lister-les-politiques","title":"Lister les politiques","text":"<pre><code>mc admin policy ls MonMinio\nmc admin policy info MonMinio MaPolitique1\n</code></pre>"},{"location":"services/minio/#attacher-une-politique","title":"Attacher une politique","text":"<pre><code>mc admin policy attach MonMinio MaPolitique1 --user utilisateur1\nmc admin policy attach MonMinio MaPolitique1 --group monGroupe1\n</code></pre>"},{"location":"services/minio/#detacher-une-politique","title":"Detacher une politique","text":"<pre><code>mc admin policy detach MonMinio MaPolitique1 --user utilisateur1\nmc admin policy detach MonMinio MaPolitique1 --group monGroupe1\n</code></pre>"},{"location":"services/minio/#maintenance","title":"Maintenance","text":""},{"location":"services/minio/#backup","title":"Backup","text":"<p>minio-backup</p>"},{"location":"services/minio/#restoration","title":"Restoration","text":"<p>minio-restore</p>"},{"location":"services/minio/#monitoring","title":"Monitoring","text":""},{"location":"services/minio/#generation-victoriametricsprometheus","title":"Generation VictoriaMetrics/Prometheus","text":""},{"location":"services/minio/#cluster-grafana-dashboard-13502","title":"Cluster (grafana dashboard : 13502)","text":"<p>mc admin prometheus generate minio</p>"},{"location":"services/minio/#node","title":"Node ()","text":"<p>mc admin prometheus generate minio node</p>"},{"location":"services/minio/#a-verifier","title":"A verifier","text":""},{"location":"services/minio/#exporter-les-metadatas","title":"Exporter les metadatas","text":"<pre><code>mc admin cluster bucket export MonMinio\n</code></pre>"},{"location":"services/minio/#exporter-les-donnees-iam","title":"Exporter les donn\u00e9es IAM","text":"<pre><code>mc admin cluster iam export MonMinio\n</code></pre>"},{"location":"services/minio/#sauvegarder-les-datas","title":"Sauvegarder les datas","text":"<pre><code>mkdir -p /home/minio-user/backup_migration\nmc mirror MonMinio /home/minio-user/backup_migration --overwrite --preserve\n</code></pre>"},{"location":"services/minio/#sauvegarder-la-configuration","title":"Sauvegarder la configuration","text":"<pre><code>mc admin user list MonMinio &gt; users.txt\nmc admin policy list MonMinio &gt; policies.txt\nmc admin info MonMinio &gt; cluster-info.txt\n</code></pre>"},{"location":"virtualization/proxmox/","title":"Proxmox","text":""},{"location":"virtualization/proxmox/#firewall-iptables","title":"Firewall (iptables)","text":""},{"location":"virtualization/proxmox/#installation","title":"Installation","text":"<pre><code>apt install iptables iptables-persistent\n</code></pre>"},{"location":"virtualization/proxmox/#reinitialiser-toutes-les-regles","title":"R\u00e9initialiser toutes les r\u00e8gles","text":"<pre><code>iptables -P INPUT ACCEPT\niptables -P FORWARD ACCEPT\niptables -P OUTPUT ACCEPT\n\niptables -F\n\niptables -X\n\niptables -Z \n\niptables -t nat -F\niptables -t nat -X\niptables -t mangle -F\niptables -t mangle -X\niptables -t raw -F\niptables -t raw -X\n</code></pre>"},{"location":"virtualization/proxmox/#configuration-minimale-des-regles","title":"Configuration minimale des r\u00e8gles","text":"<p><pre><code>iptables -A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT\niptables -A INPUT -i lo -j ACCEPT\niptables -A INPUT -p tcp -m tcp --dport 22 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT\niptables -A INPUT -p tcp -m tcp --dport 8006 -m conntrack --ctstate NEW,ESTABLISHED -j ACCEPT\niptables -A INPUT -j DROP\niptables -A OUTPUT -o lo -j ACCEPT\n</code></pre> <pre><code>iptables-save &gt; /etc/iptables/rules.v4\n</code></pre></p>"},{"location":"virtualization/proxmox/#certificats-ssl","title":"Certificats ssl","text":""},{"location":"virtualization/proxmox/#installation-node-proxmox2","title":"Installation (node proxmox2)","text":"<pre><code>scp _.local.clinux.fr.crt root@proxmox2.local.clinux.fr:/etc/pve/nodes/proxmox2/pve-ssl.pem\nscp _.local.clinux.fr.key root@proxmox2.local.clinux.fr:/etc/pve/nodes/proxmox2/pve-ssl.key\n</code></pre>"},{"location":"virtualization/proxmox/#rechargement-de-linterface","title":"Rechargement de l'interface","text":"<pre><code>systemctl restart pveproxy\n</code></pre>"},{"location":"virtualization/proxmox/#nat","title":"NAT","text":""},{"location":"virtualization/proxmox/#nouvelle-interface-nat-virtuelle","title":"Nouvelle interface NAT virtuelle","text":"<p><pre><code>vi /etc/network/interfaces\n</code></pre> <pre><code>auto vmbr2\niface vmbr2 inet static\n    address  192.168.77.1\n    netmask  255.255.255.0\n    bridge_ports none\n    bridge_stp off\n    bridge_fd 0\n    post-up echo 1 &gt; /proc/sys/net/ipv4/ip_forward\n    post-up   iptables -t nat -A POSTROUTING -s '192.168.77.0/24' -o vmbr0 -j MASQUERADE\n    post-down iptables -t nat -D POSTROUTING -s '192.168.77.0/24' -o vmbr0 -j MASQUERADE\n</code></pre> <pre><code>ifreload -a\n</code></pre></p>"},{"location":"virtualization/proxmox/#ssh-jump","title":"SSH Jump","text":"<pre><code>ssh -J jumper@proxmox user@vm\n</code></pre>"},{"location":"virtualization/proxmox/#ssh-configuration-du-jump","title":"SSH configuration du jump","text":"<pre><code>Host jumper-proxmox\nHostName proxmox\nUser jumper\n\nHost vm-behind-nat-rebuild\nHostName vm-nated-ip\nProxyJump jumper-proxmox\nUser root\nIdentityFile ~/.ssh/id_ed25519\n</code></pre>"},{"location":"virtualization/proxmox/#pat-ssh-a-une-vm","title":"PAT SSH \u00e0 une VM","text":"<pre><code>iptables -t nat -A PREROUTING -p tcp --dport 122 -j DNAT --to-destination 192.168.77.121:22\n</code></pre>"},{"location":"virtualization/proxmox/#pat-scp","title":"PAT scp","text":"<pre><code> scp -o ProxyJump=jumper@proxmox local_file root@192.168.77.121:/dest_path\n</code></pre>"},{"location":"virtualization/proxmox/#pat-rsync","title":"PAT rsync","text":"<pre><code>rsync -azvP -e \"ssh -J jumper@proxmox\" local_file root@192.168.77.121:/dest_path\n</code></pre>"},{"location":"virtualization/proxmox/#creation-dun-template","title":"Cr\u00e9ation d'un template","text":""},{"location":"virtualization/proxmox/#recuperation-de-limage-qcow","title":"R\u00e9cup\u00e9ration de l'image QCOW","text":"<pre><code>cd /tmp &amp;&amp; wget https://cloud.debian.org/images/cloud/bookworm/20231013-1532/debian-12-genericcloud-amd64-20231013-1532.qcow2\n</code></pre>"},{"location":"virtualization/proxmox/#creation-dun-template-vm","title":"Cr\u00e9ation d'un template VM","text":"<pre><code>qm create 1000 --memory 1024 --core 1 --name debian12-temp --net0 virtio,bridge=vmbr0 --description \"Debian 12 cloud template\"\nqm importdisk 1000 /tmp/debian-12-genericcloud-amd64-20231013-1532.qcow2 local-lvm\nqm set 1000 --scsihw virtio-scsi-pci --scsi0 local-lvm:vm-1000-disk-0\nqm set 1000 --boot c --bootdisk scsi0\nqm set 1000 --ide2 local-lvm:cloudinit\nqm set 1000 --serial0 socket --vga serial0\nrm -f /tmp/debian-12-genericcloud-amd64-20231013-1532.qcow2\n</code></pre>"},{"location":"virtualization/proxmox/#extension-dun-disque-dur","title":"Extension d'un disque dur","text":""},{"location":"virtualization/proxmox/#interface-graphique-proxmox","title":"Interface Graphique Proxmox","text":"<pre><code>VM &gt; Hardware &gt; HD &gt; Disk Action &gt; Resize\n</code></pre>"},{"location":"virtualization/proxmox/#interface-cli","title":"Interface CLI","text":"<pre><code>qm resize VMID DISKNAME +5G\n</code></pre>"},{"location":"virtualization/proxmox/#vm-ext4","title":"VM (ext4)","text":"<pre><code>growpart /dev/sda 1\nresize2fs /dev/sda1\n</code></pre>"},{"location":"virtualization/proxmox/#vm-xfs","title":"VM (xfs)","text":"<pre><code>growpart /dev/sda 1\nxfs_growfs /\n</code></pre>"},{"location":"virtualization/proxmox/#shrink-des-disques-durs","title":"Shrink des disques durs","text":""},{"location":"virtualization/proxmox/#proxmox-seulement-pour-scsi","title":"Proxmox (seulement pour SCSI)","text":"<pre><code>Activate Discard option on HD\n</code></pre>"},{"location":"virtualization/proxmox/#rhel","title":"RHEL","text":"<pre><code>systemctl enable fstrim.timer --now\nsystemctl status fstrim.timer\n</code></pre>"},{"location":"virtualization/proxmox/#qcowlvm","title":"Qcow/LVM","text":"<pre><code>fstrim -v /\n</code></pre>"},{"location":"virtualization/proxmox/#gestion-cli","title":"Gestion CLI","text":""},{"location":"virtualization/proxmox/#liste-des-stockages","title":"Liste des stockages","text":"<pre><code># pvesm status\n</code></pre>"},{"location":"virtualization/proxmox/#liste-des-disques-dans-un-stockage","title":"Liste des disques dans un stockage","text":"<pre><code># pvesm list local\n</code></pre>"},{"location":"virtualization/proxmox/#suppression-dun-disque-dans-un-stockage","title":"Suppression d'un disque dans un stockage","text":"<pre><code># pvesm free STORAGE:DISK\n</code></pre>"},{"location":"virtualization/proxmox/#liste-des-vm","title":"Liste des VM","text":"<pre><code># qm list\n</code></pre>"},{"location":"virtualization/proxmox/#voir-la-configuration-dune-vm","title":"Voir la configuration d'une VM","text":"<pre><code># qm config $VMID\n</code></pre>"},{"location":"virtualization/proxmox/#suppression-dun-disque-dans-une-vm","title":"Suppression d'un disque dans une VM","text":"<pre><code># qm set $VMID --delete unused0\n</code></pre>"},{"location":"virtualization/proxmox/#creation-dune-vm","title":"Cr\u00e9ation d'une VM","text":"<pre><code>qm create 200 \\\n    --memory 4096 \\\n    --core 3 --cpu \"cputype=x86-64-v2-AES\" \\\n    --onboot 1 --ostype l26 \\\n    --name vm-cli \\\n    --description \"VM via qm\" \\\n    --net0 virtio,bridge=vmbr0 \\\n    --scsihw virtio-scsi-single\nqm set 200 --ide2  local:iso/Rocky-9.3-x86_64-minimal.iso,media=cdrom\nqm set 200 --scsi0 local-lvm:10,format=qcow2\nqm set 200 --boot order='scsi0;ide2;net0'\n</code></pre>"},{"location":"virtualization/proxmox/#suppression-dune-vm","title":"Suppression d'une VM","text":"<pre><code>qm stop 200\nqm destroy 200\n</code></pre>"},{"location":"virtualization/proxmox/#instantane-dune-vm-snapshot","title":"Instantan\u00e9 d'une VM (snapshot)","text":"<pre><code>qm snapshot 200 test_snap\nqm snapshot 200 test_snap_with_ram --vmstate 1\nqm listsnapshot 200\nqm delsnapshot 200 test_snap\n</code></pre>"},{"location":"virtualization/proxmox/#restoration-dun-instantane","title":"Restoration d'un instantan\u00e9","text":"<pre><code>qm rollback 200 test_snap\nqm rollback 200 test_snap --start 1\nqm rollback 200 test_snap_with_ram\n</code></pre>"},{"location":"virtualization/proxmox/#changer-un-vmid-100-200","title":"Changer un vmid (100 &gt; 200)","text":"<pre><code>qm shutdown 100\nlvs -a | grep \"\\-100\\-\"\nlvrename pve/vm-100-cloudinit pve/vm-200-cloudinit\nlvrename pve/vm-100-disk-0 pve/vm-200-disk-0\nsed -i \"s/vm-100-cloudinit/vm-200-cloudinit/g\" /etc/pve/qemu-server/100.conf\nsed -i \"s/vm-100-disk-0/vm-200-disk-0/g\" /etc/pve/qemu-server/100.conf\nmv /etc/pve/qemu-server/100.conf /etc/pve/qemu-server/200.conf\nqm start 200\n</code></pre>"},{"location":"virtualization/proxmox/#memoire","title":"M\u00e9moire","text":""},{"location":"virtualization/proxmox/#liberation","title":"Lib\u00e9ration","text":"<pre><code>free -m\necho 1 &gt; /proc/sys/vm/compact_memory\nfree -m\n</code></pre>"},{"location":"virtualization/proxmox/#stockage","title":"Stockage","text":""},{"location":"virtualization/proxmox/#samba-smb","title":"Samba (SMB)","text":""},{"location":"virtualization/proxmox/#interface-graphique","title":"Interface Graphique","text":"<p>Attention la version du protocole est 3     Datacenter &gt; Storage &gt; SMB/CIFS</p>"},{"location":"virtualization/proxmox/#interface-cli_1","title":"Interface Cli","text":"<pre><code>pvesm add cifs syno --server $(IP/DNS) --share $(SHARE NAME) --username $(USERNAME) --password $(PASSWORD) --content images,iso,backup\n</code></pre>"},{"location":"virtualization/proxmox/#serveur-de-metriques","title":"Serveur de m\u00e9triques","text":""},{"location":"virtualization/proxmox/#influxdb2","title":"influxdb2","text":""},{"location":"virtualization/proxmox/#installation_1","title":"Installation","text":"<p>Rocky9 installation</p>"},{"location":"virtualization/proxmox/#configuration","title":"Configuration","text":"<p><pre><code>    Organization : proxmox\n</code></pre> <pre><code>    Bucket : proxmox\n</code></pre> <pre><code>    Save  $TOKEN\n</code></pre></p>"},{"location":"virtualization/proxmox/#proxmox_1","title":"Proxmox","text":""},{"location":"virtualization/proxmox/#interface-graphique_1","title":"Interface Graphique","text":"<p><pre><code>    datacenter &gt; Metric Server &gt; Add &gt; InfluxDB\n</code></pre> <pre><code>    Name : metrics\n    Server : IP/FQDN\n    Port : 8086\n    Protocol : HTTP\n    Token : $TOKEN\n</code></pre></p>"},{"location":"virtualization/proxmox/#grafana","title":"Grafana","text":""},{"location":"virtualization/proxmox/#configuration_1","title":"Configuration","text":"<p>Rocky9 installation</p>"},{"location":"virtualization/proxmox/#setup","title":"Setup","text":"<p><pre><code>datasource &gt; add datasource &gt; influxdb\n</code></pre> -  Protocol Flux -  Server :  localhost</p> <pre><code>Save  $TOKEN\n</code></pre>"},{"location":"virtualization/proxmox/#windows","title":"Windows","text":"<ul> <li>\u25b6\ufe0f Windows 11 et virtio</li> <li>\u25b6\ufe0f Windows 11 unnatend</li> <li>Unattend online</li> </ul>"},{"location":"virtualization/proxmox/#recuperation-de-liso-windows","title":"R\u00e9cup\u00e9ration de l'ISO Windows","text":"<p>Windows 11 Eval</p>"},{"location":"virtualization/proxmox/#recuperation-de-liso-des-pilotes","title":"R\u00e9cup\u00e9ration de l'ISO des pilotes","text":"<p>Driver</p>"},{"location":"virtualization/proxmox/#creation-dune-vm_1","title":"Cr\u00e9ation d'une VM","text":""},{"location":"virtualization/proxmox/#os","title":"OS","text":"<ul> <li>Type : Microsoft Windows</li> <li>Version : 11/2022/2025</li> <li>Add additionnal drive for Virtio drivers</li> </ul>"},{"location":"virtualization/proxmox/#systeme","title":"Syst\u00e8me","text":"<ul> <li>EFI storage </li> <li>Add TPM</li> </ul>"},{"location":"virtualization/proxmox/#disque","title":"Disque","text":"<ul> <li>SSD emulation</li> <li>Cache : writeback</li> <li>Discard : yes</li> <li>IOthread : yes</li> </ul>"},{"location":"virtualization/proxmox/#chargement-des-drivers","title":"Chargement des drivers","text":"<ul> <li>vioscsi</li> <li>NetKVM</li> <li>Balloon</li> </ul>"},{"location":"virtualization/proxmox/#trim","title":"Trim","text":"<ul> <li>Disk/Properties/Optimize</li> <li>optimize-volume -drive c -verbose -retrim</li> </ul>"},{"location":"virtualization/proxmox/#notifications","title":"Notifications","text":""},{"location":"virtualization/proxmox/#variables","title":"Variables","text":"<pre><code>{{ title }}: The rendered notification title\n{{ message }}: The rendered notification body\n{{ severity }}: The severity of the notification (info, notice, warning, error, unknown)\n{{ timestamp }}: The notification\u2019s timestamp as a UNIX epoch (in seconds).\n{{ fields.hostname }}: Hostname, without domain (e.g. pve1)\n{{ fields.type }}: Type of job\n</code></pre>"},{"location":"virtualization/proxmox/#mattermost","title":"Mattermost","text":"<p>Faire un webhook</p> <ul> <li>Headers  <pre><code>Content-Type : application/json\n</code></pre></li> <li>Body <pre><code>{\n  \"username\": \"hal-9000\",\n  \"icon_url\": \"https://domain.com/image.png\",\n  \"attachments\": [\n    {\n      \"fallback\": \"R\u00e9sum\u00e9 pour les clients qui ne supportent pas la mise en forme.\",\n      \"color\": \"#36a64f\",\n      \"title\": \"{{ severity }} - {{ title }}\",\n      \"fields\": [\n        {\n          \"title\": \"{{ fields.type }}\",\n          \"value\": \"{{ message }}\",\n          \"short\": true\n        }\n      ],\n      \"footer\": \"{{ fields.hostname }}\"\n    }\n  ]\n}\n</code></pre></li> </ul>"},{"location":"virtualization/proxmox/#grappe-cluster","title":"Grappe (cluster)","text":""},{"location":"virtualization/proxmox/#pre-requis","title":"Pre-requis","text":"<ul> <li>Au minimum 2 serveurs proxmox</li> <li>Les ports UDP de 5405 \u00e0 5412 doivent etre ouverts entre les noeuds</li> <li>L'heure doit \u00eatre synchronis\u00e9e sur tous les noeuds proxmox (ntp)</li> <li>Les IP et noms d'host des serveurs proxmox doivent \u00eatre configur\u00e9s correctement dans le fichier <code>/etc/hosts</code> de chaque serveur proxmox</li> <li>L'ajout d'un noeud \u00e0 la grappe ne peux se faire que si le noeuds n'a pas de machine virtuelle dessus</li> <li>Idealement le r\u00e9seau d\u00e9di\u00e9 \u00e0 la grappe doit se faire sur une carte r\u00e9seau s\u00e9par\u00e9e</li> </ul>"},{"location":"virtualization/proxmox/#creation","title":"Cr\u00e9ation","text":"<pre><code>pvecm create Trash-Cluster\npvecm status\n</code></pre>"},{"location":"virtualization/proxmox/#ajout-dun-noeud-a-la-grappe","title":"Ajout d'un noeud \u00e0 la grappe","text":"<pre><code>pvecm add &lt;dns/ip cluster&gt;\npvecm add &lt;dns/ip cluster&gt; --link0 LOCAL-IP-ADDRESS-LINK0 #cas d'un r\u00e9seau s\u00e9par\u00e9\npvecm status\n</code></pre>"},{"location":"virtualization/proxmox/#changement-suite-a-lajout-dun-nouveau-noeud-dans-la-grappe","title":"Changement suite \u00e0 l'ajout d'un nouveau noeud dans la grappe","text":"<ul> <li>Le fichier ~/.ssh/authorized_keys est maintenant un symlink venant du noeud principal de la grappe</li> <li>Utilisateurs et API token viennent aussi du noeud principal de la grappe</li> <li>L'ajout de stockage peut se faire sur tous les noeuds de la grappe</li> <li>Un bouton migration est apparu dans le menu d'une VM</li> </ul>"},{"location":"virtualization/proxmox/#sortir-un-noeud-de-la-grappe","title":"Sortir un noeud de la grappe","text":"<pre><code>systemctl stop pve-cluster\nsystemctl stop corosync\n\npmxcfs -l\n\nrm /etc/pve/corosync.conf\nrm -r /etc/corosync/*\n\nkillall pmxcfs\nsystemctl start pve-cluster\n</code></pre>"},{"location":"virtualization/proxmox/#upgrade","title":"Upgrade","text":""},{"location":"virtualization/proxmox/#pve-8-9","title":"PVE 8 &gt; 9","text":""},{"location":"virtualization/proxmox/#instructions","title":"Instructions","text":"<pre><code>https://pve.proxmox.com/wiki/Upgrade_from_8_to_9\n</code></pre>"},{"location":"virtualization/pve-automator/","title":"pve-automator","text":""},{"location":"virtualization/pve-automator/#preparation-de-liso","title":"Pr\u00e9paration de l'iso","text":""},{"location":"virtualization/pve-automator/#installation-de-lassistant","title":"Installation de l'assistant","text":"<pre><code>apt install proxmox-auto-install-assistant\n</code></pre>"},{"location":"virtualization/pve-automator/#modification-de-liso-certificat-valide","title":"Modification de l'iso (certificat valide)","text":"<pre><code>proxmox-auto-install-assistant prepare-iso proxmox-ve_9.1-1.iso \\\n    --output proxmox-ve-auto_9.1-1.iso \\\n    --fetch-from http --url \"https://pve-automator.local.clinux.fr/answer\"\n</code></pre>"},{"location":"virtualization/pve-automator/#modification-de-liso-certificat-autosigne-sha-256","title":"Modification de l'iso (certificat autosign\u00e9 sha-256)","text":"<pre><code>proxmox-auto-install-assistant prepare-iso \\\n    proxmox-ve_9.1-1.iso \\\n    --output proxmox-ve-auto-self_9.1-1.iso \\\n    --fetch-from http \\\n    --url \"https://pve-automator.local.clinux.fr:8000/answer\" \\\n    --cert-fingerprint \"BE:40:80:2F:42:6E:AC:A7:97:DF:8B:56:40:15:17:39:42:02:E4:54:06:CD:C0:CA:6D:FE:96:08:C5:93:12:E7\"\n</code></pre>"},{"location":"virtualization/pve-automator/#creation-de-la-cle-usb","title":"Cr\u00e9ation de la cl\u00e9 usb","text":""},{"location":"virtualization/pve-automator/#detection-de-la-cle","title":"D\u00e9tection de la cl\u00e9","text":"<pre><code>lsblk\n</code></pre>"},{"location":"virtualization/pve-automator/#ecriture-de-liso","title":"Ecriture de l'iso","text":"<pre><code>dd if=/root/proxmox-ve-auto_9.1-1.iso of=/dev/sdd bs=4M status=progress oflag=sync\nsync\neject /dev/sdd\n</code></pre>"},{"location":"web/nginx/","title":"Nginx","text":""},{"location":"web/nginx/#installation","title":"Installation","text":"<pre><code>dnf install nginx\nsystemctl enable nginx --now\nfirewall-cmd --add-port=80/tcp --permanent &amp;&amp; firewall-cmd --reload;\n</code></pre>"},{"location":"web/nginx/#outillage","title":"Outillage","text":"<p><pre><code>vi /root/.bashrc\n</code></pre> <pre><code>...\nalias nginxtest='nginx -t'\nalias nginxstatus='service nginx status'\nalias nginxrestart='nginx -t &amp;&amp; service nginx restart'\nalias nginxreload='nginx -t &amp;&amp; service nginx reload'\n\n# --- Fonction pour activer un site ---\nnginxenable() {\n    if [ -f \"/etc/nginx/sites-available/$1\" ]; then\n        ln -s \"/etc/nginx/sites-available/$1\" \"/etc/nginx/sites-enable/$1\" &amp;&amp; \\\n        echo \"Site '$1' activ\u00e9.\" &amp;&amp; \\\n        nginx -t &amp;&amp; \\\n        systemctl reload nginx\n    else\n        echo \"Erreur : le fichier '$1' n'existe pas dans /etc/nginx/sites-available/\"\n    fi\n}\n\n# --- Fonction pour d\u00e9sactiver un site ---\nnginxdisable() {\n    if [ -L \"/etc/nginx/sites-enable/$1\" ]; then\n        rm \"/etc/nginx/sites-enable/$1\" &amp;&amp; \\\n        echo \"Site '$1' d\u00e9sactiv\u00e9.\" &amp;&amp; \\\n        nginx -t &amp;&amp; \\\n        systemctl reload nginx\n    else\n        echo \"Erreur : le site '$1' n'est pas activ\u00e9.\"\n    fi\n}\n\n# --- Autocompl\u00e9tion pour nginxenable ---\n_nginxenable_autocomplete() {\n    local cur\n    cur=\"${COMP_WORDS[COMP_CWORD]}\"\n    COMPREPLY=( $(compgen -W \"$(ls /etc/nginx/sites-available)\" -- \"$cur\") )\n}\ncomplete -F _nginxenable_autocomplete nginxenable\n\n# --- Autocompl\u00e9tion pour nginxdisable ---\n_nginxdisable_autocomplete() {\n    local cur\n    cur=\"${COMP_WORDS[COMP_CWORD]}\"\n    COMPREPLY=( $(compgen -W \"$(ls /etc/nginx/sites-enable)\" -- \"$cur\") )\n}\ncomplete -F _nginxdisable_autocomplete nginxdisable\n</code></pre></p>"},{"location":"web/nginx/#test","title":"Test","text":"<pre><code>netstat -tnlpv | grep 80\ncurl -s http://localhost | grep '&lt;h1&gt;' #sur le serveur web\ncurl -s http://$IP | grep '&lt;h1&gt;' #de l'exterieur\n</code></pre>"},{"location":"web/nginx/#ajout-du-tls","title":"Ajout du TLS","text":""},{"location":"web/nginx/#installation-de-mkcert","title":"Installation de mkcert","text":"<pre><code>dnf install curl nss-tools wget\ncurl -s https://api.github.com/repos/FiloSottile/mkcert/releases/latest | grep browser_download_url | grep '\\linux-amd64' | cut -d '\"' -f 4 | wget -i -\nmv mkcert-v*-linux-amd64 /usr/bin/mkcert\nchmod 750 /usr/bin/mkcert\nmkcert -install\n</code></pre>"},{"location":"web/nginx/#positionnement-dans-nginx","title":"Positionnement dans nginx","text":"<pre><code>mkdir /etc/nginx/ssl\ncd /etc/nginx/ssl\n</code></pre>"},{"location":"web/nginx/#generation-de-certificats","title":"Generation de certificats","text":"<pre><code>mkcert web.lab.clinux.fr\n#Generate \"web.lab.clinux.fr.pem\" and \"web.lab.clinux.fr-key.pem\".\nmkcert web.lab.clinux.fr 192.168.1.211 127.0.0.1 ::1\n#Generate \"web.lab.clinux.fr+3.pem\" and \"web.lab.clinux.fr+3-key.pem\".\nmkcert \"*.lab.clinux.fr\" 192.168.1.211 127.0.0.1 ::1\n#Generate \"_wildcard.lab.clinux.fr+3.pem\" and \"_wildcard.lab.clinux.fr+3-key.pem\".\n</code></pre>"},{"location":"web/nginx/#modification-de-la-configuration","title":"Modification de la configuration","text":"<p><code>vi /etc/nginx/nginx.conf</code></p> <pre><code>server {\n    listen       443 ssl http2 default;\n    listen       [::]:443 ssl http2 default;\n    server_name  _;\n    root         /usr/share/nginx/html;\n\n    ssl_certificate \"/etc/nginx/ssl/_wildcard.lab.clinux.fr+3.pem\";\n    ssl_certificate_key \"/etc/nginx/ssl/_wildcard.lab.clinux.fr+3-key.pem\";\n    ssl_session_cache shared:SSL:1m;\n    ssl_session_timeout  10m;\n    ssl_ciphers PROFILE=SYSTEM;\n    ssl_prefer_server_ciphers on;\n\n    error_page 404 /404.html;\n        location = /40x.html {\n    }\n\n    error_page 500 502 503 504 /50x.html;\n        location = /50x.html {\n    }\n}\n</code></pre>"},{"location":"web/nginx/#ouverture-du-port","title":"Ouverture du port","text":"<pre><code>firewall-cmd --add-port=443/tcp --permanent &amp;&amp; firewall-cmd --reload;\n</code></pre>"},{"location":"web/nginx/#redirection-automatique-vers-https-a-rajouter-dans-le-bloc-80-http","title":"Redirection automatique vers https (a rajouter dans le bloc 80 - http)","text":"<pre><code>return 301 https://$host$request_uri;\n</code></pre>"},{"location":"web/nginx/#ajout-de-lautorie-de-certificats-dans-le-navigateur","title":"Ajout de l'autori\u00e9 de certificats dans le navigateur","text":"<p>R\u00e9cuperer le fichier <code>/root/.local/share/mkcert/rootCA.pem</code> et charger le en tant que certificat d'autorit\u00e9</p>"},{"location":"web/nginx/#gestion-des-virtual-hosts-vhost","title":"Gestion des virtual hosts (vhost)","text":""},{"location":"web/nginx/#creation-de-repertoires","title":"Cr\u00e9ation de repertoires","text":"<pre><code>mkdir /etc/nginx/sites-available\nmkdir /etc/nginx/sites-enable\n</code></pre>"},{"location":"web/nginx/#ajout-de-linclude-dans-le-bloc-http","title":"Ajout de l'include (dans le bloc http)","text":"<p><pre><code>vi /etc/nginx/nginx.conf\n</code></pre> <pre><code>...\ninclude /etc/nginx/sites-enable/*.conf;\n...\n</code></pre></p>"},{"location":"web/nginx/#vhost-par-defaut","title":"Vhost par defaut","text":"<p><pre><code>vi /etc/nginx/sites-available/web.lab.clinux.fr.conf\n</code></pre> <pre><code>server {\n    listen       80;\n    listen       [::]:80;\n    server_name  web.lab.clinux.fr;\n    return 301 https://$host$request_uri;\n}\n\nserver {\n    listen       443 ssl http2;\n    listen       [::]:443 ssl http2;\n    server_name  web.lab.clinux.fr;\n    root         /usr/share/nginx/html;\n\n    access_log /var/log/nginx/web.lab.clinux.fr.access.log;\n    error_log  /var/log/nginx/web.lab.clinux.fr.log warn;\n\n    ssl_certificate \"/etc/nginx/ssl/_wildcard.lab.clinux.fr+3.pem\";\n    ssl_certificate_key \"/etc/nginx/ssl/_wildcard.lab.clinux.fr+3-key.pem\";\n    ssl_session_cache shared:SSL:1m;\n    ssl_session_timeout  10m;\n    ssl_ciphers PROFILE=SYSTEM;\n    ssl_prefer_server_ciphers on;\n\n    error_page 404 /custom_errors/404.html;\n    error_page 500 502 503 504 /custom_errors/50x.html;\n\n    location /custom_errors/ {\n        alias /usr/share/nginx/html/;\n        internal;\n    }\n\n    location / {\n        try_files $uri $uri/ =404;\n    }\n\n}\n</code></pre></p>"},{"location":"web/nginx/#activation-du-vhost","title":"Activation du vhost","text":"<pre><code>    ln -s /etc/nginx/sites-available/web.lab.clinux.fr.conf /etc/nginx/sites-enable/web.lab.clinux.fr.conf\n    nginxreload\n</code></pre>"},{"location":"web/nginx/#verification-des-logs","title":"Verification des logs","text":"<pre><code>tail -f /var/log/nginx/web.lab.clinux.fr*.log\n</code></pre>"},{"location":"web/nginx/#hebergement-par-utilisateur","title":"Hebergement par utilisateur","text":""},{"location":"web/nginx/#autoriser-nginx-a-rentrer-dans-la-home","title":"Autoriser nginx a rentrer dans la /home","text":"<pre><code>usermod -aG static nginx\nchmod 750 /home/static\n</code></pre>"},{"location":"web/nginx/#verifier-le-log-selinux","title":"Verifier le log selinux","text":"<pre><code>tail -f /var/log/audit/audit.log\naudit2why -all\n</code></pre>"},{"location":"web/nginx/#selinux-pour-utilisateurs","title":"SElinux pour utilisateurs","text":"<pre><code>setsebool -P httpd_enable_homedirs 1\n</code></pre>"},{"location":"web/nginx/#vhost","title":"Vhost","text":"<pre><code>vi /etc/nginx/sites-available/web-static.lab.clinux.fr.conf\n</code></pre> <pre><code>server {\n    listen       80 ;\n    listen       [::]:80 ;\n    server_name  web-static.lab.clinux.fr;\n    return 301 https://$host$request_uri;\n}\n\nserver {\n    listen       443 ssl http2 ;\n    listen       [::]:443 ssl http2 ;\n    server_name  web-static.lab.clinux.fr;\n\n    access_log /var/log/nginx/web-static.lab.clinux.fr.access.log;\n    error_log  /var/log/nginx/web-static.lab.clinux.fr.error.log warn;\n\n    ssl_certificate \"/etc/nginx/ssl/_wildcard.lab.clinux.fr+3.pem\";\n    ssl_certificate_key \"/etc/nginx/ssl/_wildcard.lab.clinux.fr+3-key.pem\";\n    ssl_session_cache shared:SSL:1m;\n    ssl_session_timeout  10m;\n    ssl_ciphers PROFILE=SYSTEM;\n    ssl_prefer_server_ciphers on;\n\n\n    root /home/static/html/;\n    index index.html;\n\n    error_page 404 /custom_errors/404.html;\n    error_page 500 502 503 504 /custom_errors/50x.html;\n\n    location /custom_errors/ {\n        alias /usr/share/nginx/html/;\n        internal;\n    }\n\n    location / {\n        try_files $uri $uri/ =404;\n    }\n\n}\n</code></pre>"},{"location":"web/nginx/#activation","title":"Activation","text":"<pre><code>ln -s /etc/nginx/sites-available/web-static.lab.clinux.fr.conf /etc/nginx/sites-enable/web-static.lab.clinux.fr.conf\nnginx -t &amp;&amp; service nginx reload\n</code></pre>"},{"location":"web/nginx/#servir-un-port","title":"Servir un port","text":""},{"location":"web/nginx/#exemple-avec-python","title":"Exemple avec python","text":"<pre><code>python3 -m http.server -b localhost 8080\n</code></pre>"},{"location":"web/nginx/#vhost_1","title":"Vhost","text":"<pre><code>server {\n    listen       80 ;\n    listen       [::]:80 ;\n    server_name  serv-port.lab.clinux.fr;\n    return 301 https://$host$request_uri;\n}\n\nserver {\n    listen       443 ssl http2 ;\n    listen       [::]:443 ssl http2 ;\n    server_name  serv-port.lab.clinux.fr;\n\n    access_log /var/log/nginx/serv-port.lab.clinux.fr.access.log;\n    error_log  /var/log/nginx/serv-port.lab.clinux.fr.error.log warn;\n\n    ssl_certificate \"/etc/nginx/ssl/_wildcard.lab.clinux.fr+3.pem\";\n    ssl_certificate_key \"/etc/nginx/ssl/_wildcard.lab.clinux.fr+3-key.pem\";\n\n    ssl_session_cache shared:SSL:1m;\n    ssl_session_timeout  10m;\n    ssl_ciphers PROFILE=SYSTEM;\n    ssl_prefer_server_ciphers on;\n\n    error_page 404 /custom_errors/404.html;\n    error_page 500 502 503 504 /custom_errors/50x.html;\n\n    location /custom_errors/ {\n        alias /usr/share/nginx/html/;\n        internal;\n    }\n\n    location / {\n        proxy_pass http://localhost:8080;\n        try_files $uri $uri/ =404;\n    }\n\n}\n</code></pre>"},{"location":"web/nginx/#selinux","title":"SElinux","text":"<pre><code>setsebool -P httpd_can_network_connect 1\n</code></pre>"},{"location":"web/nginx/#repartiteur-de-charge-load-blancer","title":"R\u00e9partiteur de charge (load blancer)","text":"<pre><code>upstream backend {\n    ip_hash;\n    server localhost:8080;\n    server localhost:8081;\n}\n\n\nserver {\n    listen       80 ;\n    listen       [::]:80 ;\n    server_name  serv-port.lab.clinux.fr;\n    return 301 https://$host$request_uri;\n}\n\nserver {\n    listen       443 ssl http2 ;\n    listen       [::]:443 ssl http2 ;\n    server_name  serv-port.lab.clinux.fr;\n\n    access_log /var/log/nginx/serv-port.lab.clinux.fr.access.log;\n    error_log  /var/log/nginx/serv-port.lab.clinux.fr.error.log warn;\n\n    ssl_certificate \"/etc/nginx/ssl/_wildcard.lab.clinux.fr+3.pem\";\n    ssl_certificate_key \"/etc/nginx/ssl/_wildcard.lab.clinux.fr+3-key.pem\";\n\n    ssl_session_cache shared:SSL:1m;\n    ssl_session_timeout  10m;\n    ssl_ciphers PROFILE=SYSTEM;\n    ssl_prefer_server_ciphers on;\n\n    error_page 404 /custom_errors/404.html;\n    error_page 500 502 503 504 /custom_errors/50x.html;\n\n    location /custom_errors/ {\n        alias /usr/share/nginx/html/;\n        internal;\n    }\n\n    location / {\n        proxy_pass http://backend;\n        try_files $uri $uri/ =404;\n    }\n\n}\n</code></pre>"},{"location":"web/nginx/#le-cas-php","title":"Le cas php","text":""},{"location":"web/nginx/#utilisateur-specifique","title":"Utilisateur sp\u00e9cifique","text":"<pre><code>adduser dynamic\nsu - dynamic\nmkdir /home/dynamic/www/\necho \"&lt;?php echo 'Contenu dynamique : '. rand(); ?&gt;\" &gt;&gt; /home/dynamic/www/index.php\n</code></pre>"},{"location":"web/nginx/#installation_1","title":"Installation","text":"<pre><code>dnf install https://rpms.remirepo.net/enterprise/remi-release-9.rpm\ndnf install php83-php-fpm\n</code></pre>"},{"location":"web/nginx/#configuration","title":"Configuration","text":"<pre><code>cd /etc/opt/remi/php83/php-fpm.d/\nvi php.lab.clinux.fr.conf\n</code></pre> <pre><code>[php.lab.clinux.fr.conf]\n\n; Chemin de l'utilisateur et du groupe\nuser = dynamic\ngroup = dynamic\n\n; Chemin o\u00f9 sera ex\u00e9cut\u00e9 php-fpm\nlisten = /var/run/php8.3-fpm.php.lab.clinux.fr.conf.socket\n\n; Autorisations du socket\nlisten.owner = nginx\nlisten.group = nginx\nlisten.mode = 0660\n\n; Configuration du r\u00e9pertoire du site\nchdir = /\n\n; Configuration des processus (adapt\u00e9e selon la charge attendue)\npm = dynamic\npm.max_children = 10\npm.start_servers = 2\npm.min_spare_servers = 1\npm.max_spare_servers = 3\n\n; Logs\nphp_admin_value[error_log] = /var/log/php/php8.3-fpm-php.lab.clinux.fr.conf.log\nphp_admin_flag[log_errors] = on\n\n; Param\u00e8tres PHP personnalis\u00e9s\nphp_value[memory_limit] = 256M\nphp_value[upload_max_filesize] = 50M\nphp_value[post_max_size] = 50M\nphp_value[max_execution_time] = 60\nphp_value[date.timezone] = Europe/Paris\n</code></pre> <pre><code>systemctl enable php83-php-fpm.service --now\nll /var/run/php8.3*\n</code></pre>"},{"location":"web/nginx/#vhost-nginx","title":"Vhost nginx","text":"<pre><code>server {\n    listen       80 ;\n    listen       [::]:80 ;\n    server_name  php.lab.clinux.fr;\n    return 301 https://$host$request_uri;\n}\n\nserver {\n    listen       443 ssl http2 ;\n    listen       [::]:443 ssl http2 ;\n    server_name  php.lab.clinux.fr;\n\n    access_log /var/log/nginx/php.lab.clinux.fr.access.log;\n    error_log  /var/log/nginx/php.lab.clinux.fr.error.log warn;\n\n    ssl_certificate \"/etc/nginx/ssl/_wildcard.lab.clinux.fr+3.pem\";\n    ssl_certificate_key \"/etc/nginx/ssl/_wildcard.lab.clinux.fr+3-key.pem\";\n    ssl_session_cache shared:SSL:1m;\n    ssl_session_timeout  10m;\n    ssl_ciphers PROFILE=SYSTEM;\n    ssl_prefer_server_ciphers on;\n\n    root /home/dynamic/www/;\n    index index.php;\n\n    location ~ \\.php$ {\n        include /etc/nginx/fastcgi.conf ;\n        fastcgi_pass unix:/var/run/php8.3-fpm.php.lab.clinux.fr.conf.socket;\n        fastcgi_split_path_info ^(.+\\.php)(/.*)$;\n        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n        fastcgi_param HTTPS $https;\n        fastcgi_buffering off;\n    }\n\n\n}\n</code></pre>"},{"location":"web/nginx/#durcissement","title":"Durcissement","text":"<pre><code>php_admin_value[open_basedir] = /home/dynamic/www/:/tmp/\nphp_admin_value[disable_functions] = exec,passthru,shell_exec,system,proc_open,popen,curl_exec,curl_multi_exec,parse_ini_file,show_source,dl,fsockopen,pfsockopen\n</code></pre>"},{"location":"web/nginx/#restriction-ip","title":"Restriction Ip","text":""},{"location":"web/nginx/#basee-sur-ip","title":"Bas\u00e9e sur IP","text":"<pre><code>allow 192.168.1.143;\nallow 192.168.1.142;\nallow 192.168.1.0/24;\ndeny all;\n\nerror_page 403 https://www.youtube.com/watch?v=dQw4w9WgXcQ&amp;list=RDdQw4w9WgXcQ&amp;start_radio=1 ;\n</code></pre>"},{"location":"web/nginx/#basee-sur-maxmind","title":"Bas\u00e9e sur maxmind","text":""},{"location":"web/nginx/#package-paywall","title":"Package (paywall)","text":"<ul> <li>https://docs.nginx.com/nginx/admin-guide/dynamic-modules/geoip2/</li> </ul>"},{"location":"web/nginx/#recompilation","title":"Recompilation","text":"<ul> <li>https://github.com/leev/ngx_http_geoip2_module</li> </ul>"},{"location":"web/nginx/#basee-sur-pays-par-ip","title":"Bas\u00e9e sur pays (par ip)","text":""},{"location":"web/nginx/#recupertion-des-cidr","title":"R\u00e9cup\u00e9rtion des CIDR","text":"<pre><code>mkdir /etc/nginx/nginx-country\nwget http://firewalliplists.gypthecat.com/lists/nginx/nginx-countries.conf.zip\nunzip nginx-countries.conf.zip -d /etc/nginx/nginx-country\n</code></pre>"},{"location":"web/nginx/#exemple-de-vhost","title":"Exemple de vhost","text":"<pre><code>...\ninclude nginx-country/FR-allow.conf;\ninclude nginx-country/DE-deny.conf;\ndeny all;\n...\n</code></pre>"},{"location":"web/nginx/#securite-modsecurity","title":"S\u00e9curit\u00e9 (ModSecurity)","text":""},{"location":"web/nginx/#installation_2","title":"Installation","text":"<pre><code>dnf install epel-release\ndnf install nginx-mod-modsecurity\nmkdir -p /etc/nginx/modsecurity\n</code></pre>"},{"location":"web/nginx/#ajout-des-regles","title":"Ajout des r\u00e8gles","text":"<pre><code>cd /etc/nginx/modsecurity\ncurl -sL https://github.com/coreruleset/coreruleset/archive/refs/tags/v4.18.0.tar.gz | tar xz \nln -s coreruleset-4.18.0 coreruleset\ncd coreruleset\ncp crs-setup.conf.example crs-setup.conf\ncurl -so /etc/nginx/modsecurity/modsecurity.conf https://raw.githubusercontent.com/SpiderLabs/ModSecurity/v3/master/modsecurity.conf-recommended \n</code></pre>"},{"location":"web/nginx/#passage-en-mode-strict","title":"Passage en mode strict","text":"<pre><code>sed -i 's/SecRuleEngine DetectionOnly/SecRuleEngine On/' /etc/nginx/modsecurity/modsecurity.conf\n</code></pre>"},{"location":"web/nginx/#creation-de-la-configuration-modsecurity","title":"Cr\u00e9ation de la configuration modsecurity","text":"<pre><code>vi /etc/nginx/modsecurity/main.conf\n</code></pre> <pre><code>Include /etc/nginx/modsecurity/modsecurity.conf\nInclude /etc/nginx/modsecurity/coreruleset/crs-setup.conf\n\nInclude /etc/nginx/modsecurity/coreruleset/rules/*.conf\n</code></pre>"},{"location":"web/nginx/#fix-de-configuration-pour-les-regles-rocky-linux","title":"Fix de configuration pour les r\u00e8gles (rocky linux)","text":"<pre><code>sed -i 's/^\\(SecUnicodeMapFile unicode.mapping 20127\\)/# \\1/' /etc/nginx/modsecurity/modsecurity.conf\n</code></pre>"},{"location":"web/nginx/#injection-de-modsecurity-dans-nginx","title":"Injection de modsecurity dans nginx","text":"<pre><code>vi /etc/nginx/nginx.conf\n</code></pre> <pre><code>...\nhttp {\n\n    # Activer ModSecurity globalement\n    modsecurity on;\n    modsecurity_rules_file /etc/nginx/modsecurity/main.conf;\n...\n</code></pre> <pre><code>systemctl restart nginx\n</code></pre>"},{"location":"web/nginx/#desactivation-pour-une-zone-de-vhost","title":"Desactivation pour une zone de vhost","text":"<pre><code>location /api/legacy {\n    modsecurity off;\n    proxy_pass http://backend;\n}\n</code></pre>"},{"location":"web/nginx/#test-de-regles","title":"Test de r\u00e8gles","text":"<pre><code>&lt;!doctype html&gt;\n&lt;html lang=\"fr\"&gt;\n&lt;head&gt;\n  &lt;meta charset=\"utf-8\" /&gt;\n  &lt;meta name=\"viewport\" content=\"width=device-width,initial-scale=1\" /&gt;\n  &lt;title&gt;ModSecurity Test&lt;/title&gt;\n  &lt;style&gt;\n    body { font-family: system-ui, -apple-system, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial; padding: 24px; max-width:900px; }\n    code { background:#f4f4f4; padding:2px 6px; border-radius:4px; }\n    .links a { display:block; margin:8px 0; text-decoration:none; }\n    .warn { color:#b22222; font-weight:700; }\n  &lt;/style&gt;\n&lt;/head&gt;\n&lt;body&gt;\n  &lt;h1&gt;ModSecurity WAF \u2014 Page de test&lt;/h1&gt;\n  &lt;p&gt;Page destin\u00e9e \u00e0 d\u00e9clencher des r\u00e8gles ModSecurity / OWASP CRS en &lt;strong&gt;mode blocage&lt;/strong&gt;.&lt;/p&gt;\n\n  &lt;h2&gt;Tests (clique pour ex\u00e9cuter)&lt;/h2&gt;\n  &lt;div class=\"links\"&gt;\n    &lt;p&gt;&lt;span class=\"warn\"&gt;XSS (payload encod\u00e9 dans l'URL) \u2014 test basique :&lt;/span&gt;&lt;/p&gt;\n    &lt;a href=\"/?test=%3Cscript%3Ealert('XSS')%3C%2Fscript%3E\" rel=\"noopener noreferrer\"&gt;/?test=%3Cscript%3Ealert('XSS')%3C%2Fscript%3E&lt;/a&gt;\n\n    &lt;p&gt;&lt;span class=\"warn\"&gt;SQL Injection (simple payload encod\u00e9) :&lt;/span&gt;&lt;/p&gt;\n    &lt;a href=\"/?id=1%27%20OR%20%271%27%3D%271\" rel=\"noopener noreferrer\"&gt;/?id=1%27%20OR%20%271%27%3D%271&lt;/a&gt;\n\n  &lt;/div&gt;\n\n  &lt;h2&gt;Commandes curl utiles&lt;/h2&gt;\n  &lt;pre&gt;\n    &lt;code&gt;# Scan sqlmap\n        curl -k -A sqlmap  https://web-static.lab.clinux.fr\n    &lt;/code&gt;\n    &lt;code&gt;# Protection /admin\n        curl -k https://web-static.lab.clinux.fr/admin\n    &lt;/code&gt;\n  &lt;/pre&gt;\n\n  &lt;p style=\"margin-top:20px;\"&gt;Amuse-toi (ou pleure), et check les logs. \ud83d\ude08\ud83d\udd0d&lt;/p&gt;\n&lt;/body&gt;\n&lt;/html&gt;\n</code></pre>"},{"location":"web/nginx/#regles-custom","title":"R\u00e8gles custom","text":""},{"location":"web/nginx/#structure","title":"Structure","text":"<pre><code>SecRule VARIABLES \"OPERATOR\" \"ACTIONS\"\n</code></pre> <ul> <li>VARIABLES : O\u00f9 chercher (ARGS, HEADERS, REQUEST_BODY...)</li> <li>OPERATOR : Comment chercher (regex, @rx, @contains...)</li> <li>ACTIONS : Que faire (log, deny, pass, block...)</li> </ul>"},{"location":"web/nginx/#exemples","title":"Exemples","text":"<p>Guide d'\u00e9criture de r\u00e8gles</p>"},{"location":"web/nginx/#blocage-par-user-agent","title":"Blocage par User-Agent","text":"<pre><code># Bloquer les scans sqlmap\n# Test : curl -A sqlmap  https://web-static.lab.clinux.fr\nSecRule REQUEST_HEADERS:User-Agent \"@contains sqlmap\" \\\n    \"id:10001,\\\n    phase:1,\\\n    deny,\\\n    status:403,\\\n    log,\\\n    msg:'SQLMap bot d\u00e9tect\u00e9'\"\n</code></pre>"},{"location":"web/nginx/#blocage-par-ip-pour-un-route","title":"Blocage par IP pour un route","text":"<pre><code># Bloquer les acc\u00e8s /admin pour une IP\n# Test : curl -k  https://web-static.lab.clinux.fr/admin\nSecRule REQUEST_URI \"@rx ^/admin\" \\\n    \"id:10002,\\\n    phase:1,\\\n    deny,\\\n    status:403,\\\n    chain,\\\n    log,\\\n    msg:'Admin access from unauthorized IP '\"\n    SecRule REMOTE_ADDR \"!@ipMatch 192.168.1.143\"\n</code></pre>"}]}